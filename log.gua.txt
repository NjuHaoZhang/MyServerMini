20:22:07 完整请求
20:22:07 请求结束
20:22:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:22:07 path and query /api/todo/add {} {"title":"吃饭"}
20:22:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488975727,
  "id": 5,
  "completed": false,
  "title": "吃饭",
  "ut": 1488975727
}
20:24:01 完整请求
20:24:01 请求结束
20:24:01 完整请求
20:24:01 请求结束
20:24:01 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:24:01 path and query /todo/index {} 
20:24:01 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:24:01 完整请求
20:24:01 请求结束
20:24:01 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:24:01 path and query /static {'file': 'gua.js'} 
20:24:01 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}
20:24:01 完整请求
20:24:01 请求结束
20:24:01 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:24:01 path and query /static {'file': 'todo.js'} 
20:24:01 响应
 HTTP/1.1 200 OK

var todoTemplate = function(title) {
    var t = `
        <div class="todo-cell">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var title = todo.title
    var todoCell = todoTemplate(title)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            title: title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:24:01 完整请求
20:24:01 请求结束
20:24:02 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:24:02 path and query /api/todo/all {} 
20:24:02 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975133,
    "id": 3,
    "completed": false,
    "title": "吃瓜",
    "ut": 1488975133
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488975727,
    "id": 5,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975727
  }
]
20:24:15 完整请求
20:24:15 请求结束
20:24:15 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:24:15 path and query /api/todo/add {} {"title":"hello"}
20:24:15 响应
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488975855,
  "id": 6,
  "completed": false,
  "title": "hello",
  "ut": 1488975855
}
20:26:52 完整请求
20:26:52 请求结束
20:26:52 完整请求
20:26:52 请求结束
20:26:52 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:26:52 path and query /api/todo/add {} {"title":"hello瓜"}
20:26:52 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488976012,
  "id": 7,
  "completed": false,
  "title": "hello瓜",
  "ut": 1488976012
}
20:29:00 完整请求
20:29:00 请求结束
20:31:03 完整请求
20:31:03 请求结束
20:31:03 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:31:03 path and query /api/todo/add {} {"title":"hello瓜"}
20:31:03 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488976263,
  "id": 8,
  "completed": false,
  "title": "hello瓜",
  "ut": 1488976263
}
20:31:22 完整请求
20:31:22 请求结束
20:33:07 完整请求
20:33:07 完整请求
20:33:07 完整请求
20:33:07 完整请求
20:33:07 完整请求
20:33:07 请求结束
20:33:07 请求结束
20:33:07 请求结束
20:33:07 请求结束
20:33:07 请求结束
20:33:07 完整请求
20:33:07 请求结束
20:33:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:07 path and query /todo/index {} 
20:33:07 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:33:07 完整请求
20:33:07 请求结束
20:33:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:07 path and query /todo/index {} 
20:33:07 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:33:07 完整请求
20:33:07 请求结束
20:33:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:07 path and query /static {'file': 'gua.js'} 
20:33:07 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}
20:33:07 完整请求
20:33:07 请求结束
20:33:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:08 path and query /static {'file': 'todo.js'} 
20:33:08 响应
 HTTP/1.1 200 OK

var todoTemplate = function(title) {
    var t = `
        <div class="todo-cell">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var title = todo.title
    var todoCell = todoTemplate(title)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            todoCell.remove()
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:33:08 完整请求
20:33:08 请求结束
20:33:08 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:08 path and query /api/todo/all {} 
20:33:08 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975133,
    "id": 3,
    "completed": false,
    "title": "吃瓜",
    "ut": 1488975133
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488975727,
    "id": 5,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975727
  },
  {
    "ct": 1488975855,
    "id": 6,
    "completed": false,
    "title": "hello",
    "ut": 1488975855
  },
  {
    "ct": 1488976012,
    "id": 7,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976012
  },
  {
    "ct": 1488976263,
    "id": 8,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976263
  }
]
20:33:14 完整请求
20:33:14 请求结束
20:33:14 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:14 path and query /todo/index {} 
20:33:14 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:33:15 完整请求
20:33:15 完整请求
20:33:15 请求结束
20:33:15 请求结束
20:33:15 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:15 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:15 path and query /static {'file': 'gua.js'} 
20:33:15 path and query /static {'file': 'todo.js'} 
20:33:15 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}
20:33:15 响应
 HTTP/1.1 200 OK

var todoTemplate = function(title) {
    var t = `
        <div class="todo-cell">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var title = todo.title
    var todoCell = todoTemplate(title)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            todoCell.remove()
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:33:15 完整请求
20:33:15 请求结束
20:33:15 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:33:15 path and query /api/todo/all {} 
20:33:15 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975133,
    "id": 3,
    "completed": false,
    "title": "吃瓜",
    "ut": 1488975133
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488975727,
    "id": 5,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975727
  },
  {
    "ct": 1488975855,
    "id": 6,
    "completed": false,
    "title": "hello",
    "ut": 1488975855
  },
  {
    "ct": 1488976012,
    "id": 7,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976012
  },
  {
    "ct": 1488976263,
    "id": 8,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976263
  }
]
20:39:22 完整请求
20:39:22 请求结束
20:39:22 完整请求
20:39:22 请求结束
20:39:22 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:22 path and query /todo/index {} 
20:39:22 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:39:22 完整请求
20:39:22 请求结束
20:39:22 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:22 path and query /static {'file': 'gua.js'} 
20:39:22 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:39:22 完整请求
20:39:22 请求结束
20:39:22 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:22 path and query /static {'file': 'todo.js'} 
20:39:22 响应
 HTTP/1.1 200 OK

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:39:23 完整请求
20:39:23 请求结束
20:39:23 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:23 path and query /api/todo/all {} 
20:39:23 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975133,
    "id": 3,
    "completed": false,
    "title": "吃瓜",
    "ut": 1488975133
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488975727,
    "id": 5,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975727
  },
  {
    "ct": 1488975855,
    "id": 6,
    "completed": false,
    "title": "hello",
    "ut": 1488975855
  },
  {
    "ct": 1488976012,
    "id": 7,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976012
  },
  {
    "ct": 1488976263,
    "id": 8,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976263
  }
]
20:39:44 完整请求
20:39:44 请求结束
20:39:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:44 path and query /todo/index {} 
20:39:44 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:39:44 完整请求
20:39:44 请求结束
20:39:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:44 path and query /static {'file': 'gua.js'} 
20:39:44 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:39:44 完整请求
20:39:44 请求结束
20:39:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:44 path and query /static {'file': 'todo.js'} 
20:39:44 响应
 HTTP/1.1 200 OK

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:39:44 完整请求
20:39:44 请求结束
20:39:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:44 path and query /api/todo/all {} 
20:39:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975133,
    "id": 3,
    "completed": false,
    "title": "吃瓜",
    "ut": 1488975133
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488976263,
    "id": 8,
    "completed": false,
    "title": "hello瓜",
    "ut": 1488976263
  }
]
20:39:58 完整请求
20:39:58 请求结束
20:39:58 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:39:58 path and query /api/todo/delete {'id': '3'} 
20:39:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488975133,
  "id": 3,
  "completed": false,
  "title": "吃瓜",
  "ut": 1488975133
}
20:41:06 完整请求
20:41:06 请求结束
20:41:06 完整请求
20:41:06 请求结束
20:41:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:41:06 path and query /api/todo/delete {'id': '8'} 
20:41:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488976263,
  "id": 8,
  "completed": false,
  "title": "hello瓜",
  "ut": 1488976263
}
20:43:55 完整请求
20:43:55 请求结束
20:43:56 完整请求
20:43:56 请求结束
20:43:56 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:43:56 path and query /todo/index {} 
20:43:56 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:43:56 完整请求
20:43:56 请求结束
20:43:56 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:43:56 path and query /static {'file': 'gua.js'} 
20:43:56 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:43:56 完整请求
20:43:56 请求结束
20:43:56 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:43:56 path and query /static {'file': 'todo.js'} 
20:43:56 响应
 HTTP/1.1 200 OK

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ct = todo.ct
    var ut = todo.ut
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ct}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:43:56 完整请求
20:43:56 请求结束
20:43:56 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:43:56 path and query /api/todo/all {} 
20:43:56 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  }
]
20:44:43 完整请求
20:44:43 请求结束
20:44:43 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:44:43 path and query /api/todo/add {} {"title":"123"}
20:44:43 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488977083,
  "id": 5,
  "completed": false,
  "title": "123",
  "ut": 1488977083
}
20:45:10 完整请求
20:45:10 请求结束
20:46:12 完整请求
20:46:12 请求结束
20:46:12 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:46:12 path and query /todo/index {} 
20:46:12 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:46:12 完整请求
20:46:12 请求结束
20:46:12 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:46:12 path and query /static {'file': 'gua.js'} 
20:46:12 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:46:12 完整请求
20:46:12 请求结束
20:46:13 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:46:13 path and query /static {'file': 'todo.js'} 
20:46:13 响应
 HTTP/1.1 200 OK

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ct = todo.ct
    ct = new Date(ct * 1000)
    ct = ct.toLocaleTimeString()
//    var ut = todo.ut
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ct}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:46:13 完整请求
20:46:13 请求结束
20:46:13 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:46:13 path and query /api/todo/all {} 
20:46:13 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  }
]
20:47:19 完整请求
20:47:19 请求结束
20:47:19 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:19 path and query /todo/index {} 
20:47:19 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:47:19 完整请求
20:47:19 请求结束
20:47:20 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:20 path and query /static {'file': 'gua.js'} 
20:47:20 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:47:20 完整请求
20:47:20 请求结束
20:47:20 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:20 path and query /static {'file': 'todo.js'} 
20:47:20 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var t = timeString(todo.ut)
//    var ut = todo.ut
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ct}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:47:20 完整请求
20:47:20 请求结束
20:47:20 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:20 path and query /api/todo/all {} 
20:47:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  }
]
20:47:38 完整请求
20:47:38 请求结束
20:47:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:38 path and query /todo/index {} 
20:47:38 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:47:38 完整请求
20:47:38 请求结束
20:47:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:38 path and query /static {'file': 'gua.js'} 
20:47:38 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:47:38 完整请求
20:47:38 请求结束
20:47:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:38 path and query /static {'file': 'todo.js'} 
20:47:38 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
//    var ut = todo.ut
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:47:38 完整请求
20:47:38 请求结束
20:47:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:38 path and query /api/todo/all {} 
20:47:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488959077,
    "id": 2,
    "completed": false,
    "title": "瓜",
    "ut": 1488959077
  },
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  }
]
20:47:42 完整请求
20:47:42 请求结束
20:47:42 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:42 path and query /api/todo/delete {'id': '2'} 
20:47:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488959077,
  "id": 2,
  "completed": false,
  "title": "瓜",
  "ut": 1488959077
}
20:47:44 完整请求
20:47:44 请求结束
20:47:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:44 path and query /api/todo/add {} 
20:47:49 完整请求
20:47:49 请求结束
20:47:49 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:49 path and query /api/todo/add {} {"title":"123"}
20:47:49 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488977269,
  "id": 6,
  "completed": false,
  "title": "123",
  "ut": 1488977269
}
20:47:49 完整请求
20:47:49 请求结束
20:47:49 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:49 path and query /api/todo/add {} {"title":"123"}
20:47:49 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488977269,
  "id": 7,
  "completed": false,
  "title": "123",
  "ut": 1488977269
}
20:47:53 完整请求
20:47:53 请求结束
20:47:53 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:47:53 path and query /api/todo/add {} {"title":"123asd"}
20:47:53 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ct": 1488977273,
  "id": 8,
  "completed": false,
  "title": "123asd",
  "ut": 1488977273
}
20:48:51 完整请求
20:48:51 请求结束
20:48:51 完整请求
20:48:51 请求结束
20:48:51 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:48:51 path and query /todo/index {} 
20:48:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:48:51 完整请求
20:48:51 请求结束
20:48:51 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:48:51 path and query /static {'file': 'gua.js'} 
20:48:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:48:52 完整请求
20:48:52 请求结束
20:48:52 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:48:52 path and query /static {'file': 'todo.js'} 
20:48:52 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }

//        var input = e('#id-input-todo')
//        var title = input.value
//        log('click add', title)
//        var form = {
//            'title': title,
//        }
//        apiTodoAdd(form, function(r) {
//            // 收到返回的数据, 插入到页面中
//            var todo = JSON.parse(r)
//            insertTodo(todo)
//        })
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:48:52 完整请求
20:48:52 请求结束
20:48:52 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:48:52 path and query /api/todo/all {} 
20:48:52 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  },
  {
    "ct": 1488977269,
    "id": 6,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977269,
    "id": 7,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977273,
    "id": 8,
    "completed": false,
    "title": "123asd",
    "ut": 1488977273
  }
]
20:51:34 完整请求
20:51:34 请求结束
20:51:35 完整请求
20:51:35 请求结束
20:51:35 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:35 path and query /todo/index {} 
20:51:35 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:51:35 完整请求
20:51:35 请求结束
20:51:35 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:35 path and query /static {'file': 'gua.js'} 
20:51:35 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:51:35 完整请求
20:51:35 请求结束
20:51:35 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:35 path and query /static {'file': 'todo.js'} 
20:51:35 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <input class="todo-edit-input">
        <button class='todo-update'>更新</button>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:51:35 完整请求
20:51:35 请求结束
20:51:35 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:35 path and query /api/todo/all {} 
20:51:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  },
  {
    "ct": 1488977269,
    "id": 6,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977269,
    "id": 7,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977273,
    "id": 8,
    "completed": false,
    "title": "123asd",
    "ut": 1488977273
  }
]
20:51:49 完整请求
20:51:49 请求结束
20:51:49 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:49 path and query /todo/index {} 
20:51:49 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:51:49 完整请求
20:51:49 请求结束
20:51:50 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:50 path and query /static {'file': 'gua.js'} 
20:51:50 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:51:50 完整请求
20:51:50 请求结束
20:51:50 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:50 path and query /static {'file': 'todo.js'} 
20:51:50 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <input class="todo-edit-input">
        <button class='todo-update'>更新</button>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:51:50 完整请求
20:51:50 请求结束
20:51:50 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:51:50 path and query /api/todo/all {} 
20:51:50 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  },
  {
    "ct": 1488977269,
    "id": 6,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977269,
    "id": 7,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977273,
    "id": 8,
    "completed": false,
    "title": "123asd",
    "ut": 1488977273
  }
]
20:56:53 完整请求
20:56:53 请求结束
20:56:53 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:56:53 path and query /todo/index {} 
20:56:53 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:56:53 完整请求
20:56:53 请求结束
20:56:53 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:56:54 path and query /static {'file': 'gua.js'} 
20:56:54 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:56:54 完整请求
20:56:54 请求结束
20:56:54 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:56:54 path and query /static {'file': 'todo.js'} 
20:56:54 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id
                'title': title,
            }
            apiTodoUpdate(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:57:06 完整请求
20:57:06 请求结束
20:57:06 完整请求
20:57:06 请求结束
20:57:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:57:06 path and query /todo/index {} 
20:57:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:57:06 完整请求
20:57:06 请求结束
20:57:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:57:06 path and query /static {'file': 'gua.js'} 
20:57:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}
20:57:07 完整请求
20:57:07 请求结束
20:57:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:57:07 path and query /static {'file': 'todo.js'} 
20:57:07 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:57:07 完整请求
20:57:07 请求结束
20:57:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:57:07 path and query /api/todo/all {} 
20:57:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ct": 1488975265,
    "id": 4,
    "completed": false,
    "title": "吃饭",
    "ut": 1488975265
  },
  {
    "ct": 1488977083,
    "id": 5,
    "completed": false,
    "title": "123",
    "ut": 1488977083
  },
  {
    "ct": 1488977269,
    "id": 6,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977269,
    "id": 7,
    "completed": false,
    "title": "123",
    "ut": 1488977269
  },
  {
    "ct": 1488977273,
    "id": 8,
    "completed": false,
    "title": "123asd",
    "ut": 1488977273
  }
]
20:59:38 完整请求
20:59:38 请求结束
20:59:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:38 path and query /todo/index {} 
20:59:38 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
20:59:38 完整请求
20:59:38 请求结束
20:59:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:38 path and query /static {'file': 'gua.js'} 
20:59:38 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
}

20:59:38 完整请求
20:59:38 请求结束
20:59:38 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:39 path and query /static {'file': 'todo.js'} 
20:59:39 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
20:59:39 完整请求
20:59:39 请求结束
20:59:39 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:39 path and query /api/todo/all {} 
20:59:39 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488975265,
    "id": 4,
    "ct": 1488975265,
    "title": "吃饭",
    "completed": false
  },
  {
    "ut": 1488977083,
    "id": 5,
    "ct": 1488977083,
    "title": "123",
    "completed": false
  },
  {
    "ut": 1488977269,
    "id": 6,
    "ct": 1488977269,
    "title": "123",
    "completed": false
  },
  {
    "ut": 1488977269,
    "id": 7,
    "ct": 1488977269,
    "title": "123",
    "completed": false
  },
  {
    "ut": 1488977273,
    "id": 8,
    "ct": 1488977273,
    "title": "123asd",
    "completed": false
  }
]
20:59:41 完整请求
20:59:42 请求结束
20:59:42 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:42 path and query /api/todo/delete {'id': '5'} 
20:59:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488977083,
  "id": 5,
  "ct": 1488977083,
  "title": "123",
  "completed": false
}
20:59:42 完整请求
20:59:42 请求结束
20:59:42 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:42 path and query /api/todo/delete {'id': '6'} 
20:59:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488977269,
  "id": 6,
  "ct": 1488977269,
  "title": "123",
  "completed": false
}
20:59:43 完整请求
20:59:43 请求结束
20:59:43 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:43 path and query /api/todo/delete {'id': '8'} 
20:59:43 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488977273,
  "id": 8,
  "ct": 1488977273,
  "title": "123asd",
  "completed": false
}
20:59:43 完整请求
20:59:43 请求结束
20:59:43 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:43 path and query /api/todo/delete {'id': '7'} 
20:59:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488977269,
  "id": 7,
  "ct": 1488977269,
  "title": "123",
  "completed": false
}
20:59:53 完整请求
20:59:54 请求结束
20:59:54 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
20:59:54 path and query /api/todo/update {} {"id":"4","title":"吃瓜"}
20:59:54 kwargs,  {'id': 4} <class 'dict'>
20:59:54 debug 0
20:59:54 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488977994,
  "id": 4,
  "ct": 1488975265,
  "title": "吃瓜",
  "completed": false
}
21:05:10 完整请求
21:05:10 请求结束
21:05:10 完整请求
21:05:10 请求结束
21:05:10 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:10 path and query /todo/index {} 
21:05:10 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:05:11 完整请求
21:05:11 请求结束
21:05:11 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:11 path and query /static {'file': 'gua.js'} 
21:05:11 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
}

21:05:11 完整请求
21:05:11 请求结束
21:05:11 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:11 path and query /static {'file': 'todo.js'} 
21:05:11 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:05:11 完整请求
21:05:11 请求结束
21:05:11 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:11 path and query /api/todo/all {} 
21:05:11 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488977994,
    "id": 4,
    "ct": 1488975265,
    "title": "吃瓜",
    "completed": false
  }
]
21:05:18 完整请求
21:05:18 请求结束
21:05:18 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:18 path and query /api/todo/update {} {"id":"4","title":"hello"}
21:05:18 kwargs,  {'id': 4} <class 'dict'>
21:05:18 debug 0
21:05:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488978318,
  "id": 4,
  "ct": 1488975265,
  "title": "hello",
  "completed": false
}
21:05:20 完整请求
21:05:20 请求结束
21:05:20 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:21 path and query /todo/index {} 
21:05:21 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:05:21 完整请求
21:05:21 完整请求
21:05:21 请求结束
21:05:21 请求结束
21:05:21 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:21 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:21 path and query /static {'file': 'todo.js'} 
21:05:21 path and query /static {'file': 'gua.js'} 
21:05:21 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:05:21 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
}

21:05:21 完整请求
21:05:21 请求结束
21:05:21 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:05:21 path and query /api/todo/all {} 
21:05:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488978318,
    "id": 4,
    "ct": 1488975265,
    "title": "hello",
    "completed": false
  }
]
21:07:45 完整请求
21:07:45 请求结束
21:07:46 完整请求
21:07:46 请求结束
21:07:46 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:07:46 path and query /todo/index {} 
21:07:46 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:07:46 完整请求
21:07:46 请求结束
21:07:46 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:07:46 path and query /static {'file': 'gua.js'} 
21:07:46 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:07:46 完整请求
21:07:46 请求结束
21:07:46 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:07:46 path and query /static {'file': 'todo.js'} 
21:07:46 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span>${title}</span>
            <time>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:07:46 完整请求
21:07:46 请求结束
21:07:46 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:07:46 path and query /api/todo/all {} 
21:07:46 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488978318,
    "id": 4,
    "ct": 1488975265,
    "title": "hello",
    "completed": false
  }
]
21:10:33 完整请求
21:10:33 请求结束
21:10:33 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:33 path and query /todo/index {} 
21:10:34 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:10:34 完整请求
21:10:34 请求结束
21:10:34 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:34 path and query /static {'file': 'gua.js'} 
21:10:34 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:10:34 完整请求
21:10:34 请求结束
21:10:34 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:34 path and query /static {'file': 'todo.js'} 
21:10:34 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:10:34 完整请求
21:10:34 请求结束
21:10:34 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:34 path and query /api/todo/all {} 
21:10:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488978318,
    "id": 4,
    "ct": 1488975265,
    "title": "hello",
    "completed": false
  }
]
21:10:39 完整请求
21:10:39 请求结束
21:10:39 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:39 path and query /api/todo/update {} {"id":"4","title":"gua"}
21:10:39 kwargs,  {'id': 4} <class 'dict'>
21:10:39 debug 0
21:10:39 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488978639,
  "id": 4,
  "ct": 1488975265,
  "title": "gua",
  "completed": false
}
21:10:44 完整请求
21:10:44 请求结束
21:10:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:44 path and query /todo/index {} 
21:10:44 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:10:44 完整请求
21:10:44 完整请求
21:10:44 请求结束
21:10:44 请求结束
21:10:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:44 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:44 path and query /static {'file': 'todo.js'} 
21:10:44 path and query /static {'file': 'gua.js'} 
21:10:45 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:10:45 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:10:45 完整请求
21:10:45 请求结束
21:10:45 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:45 path and query /api/todo/all {} 
21:10:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488978639,
    "id": 4,
    "ct": 1488975265,
    "title": "gua",
    "completed": false
  }
]
21:10:50 完整请求
21:10:50 请求结束
21:10:50 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:10:50 path and query /api/todo/update {} 
21:11:09 完整请求
21:11:09 请求结束
21:11:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:11:09 path and query /api/todo/update {} {"id":"4","title":"瓜"}
21:11:09 kwargs,  {'id': 4} <class 'dict'>
21:11:09 debug 0
21:11:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488978669,
  "id": 4,
  "ct": 1488975265,
  "title": "瓜",
  "completed": false
}
21:11:09 完整请求
21:11:09 请求结束
21:11:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:11:09 path and query /api/todo/update {} {"id":"4","title":"瓜"}
21:11:09 kwargs,  {'id': 4} <class 'dict'>
21:11:09 debug 0
21:11:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "ut": 1488978669,
  "id": 4,
  "ct": 1488975265,
  "title": "瓜",
  "completed": false
}
21:17:29 完整请求
21:17:29 请求结束
21:17:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:29 path and query /todo/index {} 
21:17:29 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:17:29 完整请求
21:17:29 请求结束
21:17:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:29 path and query /static {'file': 'gua.js'} 
21:17:30 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:17:30 完整请求
21:17:30 请求结束
21:17:30 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:30 path and query /static {'file': 'todo.js'} 
21:17:30 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:17:30 完整请求
21:17:30 请求结束
21:17:30 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:30 path and query /api/todo/all {} 
21:17:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488978669,
    "id": 4,
    "ct": 1488975265,
    "title": "瓜",
    "completed": false
  }
]
21:17:34 完整请求
21:17:34 请求结束
21:17:34 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:35 path and query /weibo/index {} 
21:17:35 kwargs,  {'id': -1} <class 'dict'>
21:17:35 响应
 HTTP/1.1 302 OK
Location: /login
Content-Type: text/html


21:17:35 完整请求
21:17:35 请求结束
21:17:35 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:35 path and query /login {} 
21:17:35 login, cookies {'Pycharm-df207d35': '600adc10-1f5d-46ff-b99f-861b091847e7'}
21:17:35 响应
 HTTP/1.1 200 VERY OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>注册登录页面</title>
</head>
<body>
    <h1>登录</h1>
    <h2>你好 </h2>
    <form action="/login" method="post">
        <input type="text" name="username" placeholder="请输入用户名">
        <br>
        <input type="text" name="password" placeholder="请输入密码">
        <br>
        <button type="submit">登录</button>
    </form>
    <h3></h3>
</body>
</html>
21:17:57 完整请求
21:17:57 请求结束
21:17:57 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:57 path and query /weibo/index {} 
21:17:57 完整请求
21:17:57 请求结束
21:17:57 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:17:57 path and query /weibo/index {} 
21:18:06 完整请求
21:18:06 完整请求
21:18:06 完整请求
21:18:06 完整请求
21:18:06 请求结束
21:18:06 请求结束
21:18:06 请求结束
21:18:06 请求结束
21:18:06 完整请求
21:18:06 请求结束
21:18:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:06 path and query /todo/index {} 
21:18:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:18:06 完整请求
21:18:06 请求结束
21:18:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:06 path and query /static {'file': 'gua.js'} 
21:18:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:18:06 完整请求
21:18:06 请求结束
21:18:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:06 path and query /static {'file': 'todo.js'} 
21:18:06 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:18:07 完整请求
21:18:07 请求结束
21:18:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:07 path and query /api/todo/all {} 
21:18:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "completed": false,
    "id": 4,
    "title": "瓜",
    "ct": 1488975265,
    "ut": 1488978669
  }
]
21:18:09 完整请求
21:18:09 完整请求
21:18:09 请求结束
21:18:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:09 请求结束
21:18:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:09 path and query /weibo/index {} 
21:18:09 path and query /weibo/index {} 
21:18:29 完整请求
21:18:29 请求结束
21:18:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:29 path and query /weibo/index {} 
21:18:50 完整请求
21:18:50 请求结束
21:18:50 完整请求
21:18:50 请求结束
21:18:50 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:50 path and query /todo/index {} 
21:18:50 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:18:51 完整请求
21:18:51 请求结束
21:18:51 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:51 path and query /static {'file': 'gua.js'} 
21:18:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:18:51 完整请求
21:18:51 请求结束
21:18:51 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:51 path and query /static {'file': 'todo.js'} 
21:18:51 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:18:51 完整请求
21:18:51 请求结束
21:18:51 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:51 path and query /api/todo/all {} 
21:18:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "ut": 1488978669,
    "ct": 1488975265,
    "id": 4,
    "title": "瓜",
    "completed": false
  }
]
21:18:54 完整请求
21:18:54 请求结束
21:18:54 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:54 path and query /weibo/index {} 
21:18:54 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list">
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:18:54 完整请求
21:18:54 完整请求
21:18:54 请求结束
21:18:54 请求结束
21:18:55 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:55 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:55 path and query /static {'file': 'gua.js'} 
21:18:55 path and query /static {'file': 'weibo.js'} 
21:18:55 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

21:18:55 完整请求
21:18:55 请求结束
21:18:55 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:55 path and query /static {'file': 'weibo.js'} 
21:18:55 完整请求
21:18:55 请求结束
21:18:55 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:18:55 path and query /static {'file': 'weibo.js'} 
21:40:12 完整请求
21:40:12 请求结束
21:40:12 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:12 path and query /weibo/index {} 
21:40:12 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:40:12 完整请求
21:40:12 请求结束
21:40:13 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:13 path and query /static {'file': 'gua.js'} 
21:40:13 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

21:40:13 完整请求
21:40:13 请求结束
21:40:13 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:13 path and query /static {'file': 'weibo.js'} 
21:40:13 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.Weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:40:13 完整请求
21:40:13 请求结束
21:40:13 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:14 path and query /weibo/index {} 
21:40:14 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:40:14 完整请求
21:40:14 完整请求
21:40:14 请求结束
21:40:14 请求结束
21:40:14 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:14 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:14 path and query /static {'file': 'weibo.js'} 
21:40:14 path and query /static {'file': 'gua.js'} 
21:40:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.Weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:40:14 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

21:40:14 完整请求
21:40:14 请求结束
21:40:14 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:14 path and query /api/weibo/all {} 
21:40:15 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:40:28 完整请求
21:40:28 请求结束
21:40:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:29 path and query /weibo/index {} 
21:40:29 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:40:29 完整请求
21:40:29 请求结束
21:40:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:29 path and query /static {'file': 'gua.js'} 
21:40:29 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

21:40:29 完整请求
21:40:29 请求结束
21:40:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:29 path and query /static {'file': 'weibo.js'} 
21:40:29 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.Weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:40:29 完整请求
21:40:29 请求结束
21:40:29 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:40:29 path and query /api/weibo/all {} 
21:40:29 kwargs,  {'weibo_id': 1} <class 'dict'>
21:40:29 kwargs,  {'weibo_id': 2} <class 'dict'>
21:40:29 kwargs,  {'weibo_id': 3} <class 'dict'>
21:40:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "content": "hello tweet",
    "id": 1,
    "user_id": 1,
    "comments": [
      {
        "content": "楼主说得对",
        "id": 1,
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "content": "lbvu is right",
        "id": 2,
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "content": "你好",
    "id": 2,
    "user_id": 1,
    "comments": [
      {
        "content": "hello",
        "id": 3,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "123",
        "id": 4,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "asdf",
        "id": 5,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "说得好",
        "id": 7,
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "content": "说得好",
        "id": 8,
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "content": "hahaha",
    "id": 3,
    "user_id": 1,
    "comments": [
      {
        "content": "123",
        "id": 6,
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
21:41:09 完整请求
21:41:09 请求结束
21:41:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:41:09 path and query /weibo/index {} 
21:41:09 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:41:09 完整请求
21:41:09 请求结束
21:41:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:41:09 path and query /static {'file': 'gua.js'} 
21:41:09 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

21:41:09 完整请求
21:41:09 请求结束
21:41:09 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:41:10 path and query /static {'file': 'weibo.js'} 
21:41:10 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:41:10 完整请求
21:41:10 请求结束
21:41:10 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:41:10 path and query /api/weibo/all {} 
21:41:10 kwargs,  {'weibo_id': 1} <class 'dict'>
21:41:10 kwargs,  {'weibo_id': 2} <class 'dict'>
21:41:10 kwargs,  {'weibo_id': 3} <class 'dict'>
21:41:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "content": "hello tweet",
    "id": 1,
    "user_id": 1,
    "comments": [
      {
        "content": "楼主说得对",
        "id": 1,
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "content": "lbvu is right",
        "id": 2,
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "content": "你好",
    "id": 2,
    "user_id": 1,
    "comments": [
      {
        "content": "hello",
        "id": 3,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "123",
        "id": 4,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "asdf",
        "id": 5,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "说得好",
        "id": 7,
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "content": "说得好",
        "id": 8,
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "content": "hahaha",
    "id": 3,
    "user_id": 1,
    "comments": [
      {
        "content": "123",
        "id": 6,
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
21:42:06 完整请求
21:42:06 请求结束
21:42:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:42:06 path and query /weibo/index {} 
21:42:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:42:06 完整请求
21:42:06 请求结束
21:42:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:42:06 path and query /static {'file': 'gua.js'} 
21:42:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

21:42:06 完整请求
21:42:06 请求结束
21:42:06 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:42:06 path and query /static {'file': 'weibo.js'} 
21:42:07 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:42:07 完整请求
21:42:07 请求结束
21:42:07 cookie ['Pycharm-df207d35=600adc10-1f5d-46ff-b99f-861b091847e7']
21:42:07 path and query /api/weibo/all {} 
21:42:07 kwargs,  {'weibo_id': 1} <class 'dict'>
21:42:07 kwargs,  {'weibo_id': 2} <class 'dict'>
21:42:07 kwargs,  {'weibo_id': 3} <class 'dict'>
21:42:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "content": "hello tweet",
    "id": 1,
    "user_id": 1,
    "comments": [
      {
        "content": "楼主说得对",
        "id": 1,
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "content": "lbvu is right",
        "id": 2,
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "content": "你好",
    "id": 2,
    "user_id": 1,
    "comments": [
      {
        "content": "hello",
        "id": 3,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "123",
        "id": 4,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "asdf",
        "id": 5,
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "content": "说得好",
        "id": 7,
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "content": "说得好",
        "id": 8,
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "content": "hahaha",
    "id": 3,
    "user_id": 1,
    "comments": [
      {
        "content": "123",
        "id": 6,
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
21:44:32 完整请求
21:44:32 请求结束
10:47:22 完整请求
10:47:22 请求结束
10:47:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
10:47:22 path and query / {} 
10:47:22 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /todo/index


10:47:22 完整请求
10:47:22 请求结束
10:47:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
10:47:22 path and query /todo/index {} 
10:47:22 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
10:47:22 完整请求
10:47:22 请求结束
10:47:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
10:47:22 path and query /static {'file': 'gua.js'} 
10:47:22 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

10:47:23 完整请求
10:47:23 请求结束
10:47:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
10:47:23 path and query /static {'file': 'todo.js'} 
10:47:23 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
10:47:23 完整请求
10:47:23 请求结束
10:47:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
10:47:23 path and query /api/todo/all {} 
10:47:23 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "title": "瓜",
    "completed": false,
    "ct": 1488975265,
    "ut": 1488978669
  }
]
10:51:39 完整请求
10:51:39 请求结束
11:01:57 完整请求
11:01:57 请求结束
11:01:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
11:01:57 path and query /api/todo/delete {'id': '4'} 
11:01:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "title": "瓜",
  "completed": false,
  "ct": 1488975265,
  "ut": 1488978669
}
11:02:06 完整请求
11:02:06 请求结束
11:02:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
11:02:06 path and query /api/todo/add {} {"title":"gua"}
11:02:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "gua",
  "completed": false,
  "ct": 1520478126,
  "ut": 1520478126
}
11:02:10 完整请求
11:02:10 请求结束
11:02:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
11:02:10 path and query /api/todo/add {} {"title":"gua123"}
11:02:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "gua123",
  "completed": false,
  "ct": 1520478130,
  "ut": 1520478130
}
11:02:12 完整请求
11:02:12 请求结束
11:02:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
11:02:12 path and query /api/todo/delete {'id': '1'} 
11:02:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "gua",
  "completed": false,
  "ct": 1520478126,
  "ut": 1520478126
}
11:02:13 完整请求
11:02:13 请求结束
11:02:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
11:02:13 path and query /api/todo/delete {'id': '2'} 
11:02:13 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "gua123",
  "completed": false,
  "ct": 1520478130,
  "ut": 1520478130
}
11:03:09 完整请求
11:03:09 请求结束
14:06:04 完整请求
14:06:04 请求结束
14:06:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:04 path and query /api/todo/add {} {"title":"gua123"}
14:06:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "gua123",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489164
}
14:06:06 完整请求
14:06:06 请求结束
14:06:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:06 path and query /api/todo/add {} {"title":"gua123"}
14:06:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "gua123",
  "completed": false,
  "ct": 1520489166,
  "ut": 1520489166
}
14:06:24 完整请求
14:06:24 请求结束
14:06:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:24 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:24 kwargs,  {'id': 1} <class 'dict'>
14:06:24 debug 0
14:06:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489184
}
14:06:25 完整请求
14:06:25 请求结束
14:06:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:25 path and query /api/todo/update {} {"id":"1","title":""}
14:06:25 kwargs,  {'id': 1} <class 'dict'>
14:06:25 debug 0
14:06:25 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489185
}
14:06:26 完整请求
14:06:26 请求结束
14:06:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:26 path and query /api/todo/update {} {"id":"1","title":""}
14:06:26 kwargs,  {'id': 1} <class 'dict'>
14:06:26 debug 0
14:06:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489186
}
14:06:26 完整请求
14:06:26 请求结束
14:06:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:26 path and query /api/todo/update {} {"id":"1","title":""}
14:06:26 kwargs,  {'id': 1} <class 'dict'>
14:06:26 debug 0
14:06:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489186
}
14:06:26 完整请求
14:06:26 请求结束
14:06:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:26 path and query /api/todo/update {} {"id":"1","title":""}
14:06:26 kwargs,  {'id': 1} <class 'dict'>
14:06:26 debug 0
14:06:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489186
}
14:06:26 完整请求
14:06:26 请求结束
14:06:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:26 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:26 kwargs,  {'id': 1} <class 'dict'>
14:06:26 debug 0
14:06:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489186
}
14:06:27 完整请求
14:06:27 请求结束
14:06:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:27 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:27 kwargs,  {'id': 1} <class 'dict'>
14:06:27 debug 0
14:06:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489187
}
14:06:27 完整请求
14:06:27 请求结束
14:06:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:27 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:27 完整请求
14:06:27 kwargs,  {'id': 1} <class 'dict'>
14:06:27 请求结束
14:06:27 debug 0
14:06:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489187
}
14:06:27 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:27 kwargs,  {'id': 1} <class 'dict'>
14:06:27 debug 0
14:06:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489187
}
14:06:27 完整请求
14:06:27 请求结束
14:06:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:27 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:27 kwargs,  {'id': 1} <class 'dict'>
14:06:27 debug 0
14:06:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489187
}
14:06:28 完整请求
14:06:28 请求结束
14:06:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:28 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:28 kwargs,  {'id': 1} <class 'dict'>
14:06:28 debug 0
14:06:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489188
}
14:06:28 完整请求
14:06:28 请求结束
14:06:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:28 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:28 kwargs,  {'id': 1} <class 'dict'>
14:06:28 debug 0
14:06:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489188
}
14:06:29 完整请求
14:06:29 请求结束
14:06:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:29 path and query /api/todo/update {} {"id":"1","title":""}
14:06:29 kwargs,  {'id': 1} <class 'dict'>
14:06:29 debug 0
14:06:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489189
}
14:06:30 完整请求
14:06:30 请求结束
14:06:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:30 path and query /api/todo/update {} {"id":"1","title":""}
14:06:30 kwargs,  {'id': 1} <class 'dict'>
14:06:30 debug 0
14:06:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489190
}
14:06:30 完整请求
14:06:30 请求结束
14:06:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:30 path and query /api/todo/update {} {"id":"1","title":""}
14:06:30 kwargs,  {'id': 1} <class 'dict'>
14:06:30 debug 0
14:06:30 完整请求
14:06:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489190
}
14:06:30 请求结束
14:06:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:30 path and query /api/todo/update {} {"id":"1","title":""}
14:06:30 kwargs,  {'id': 1} <class 'dict'>
14:06:30 debug 0
14:06:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489190
}
14:06:30 完整请求
14:06:30 请求结束
14:06:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:30 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:30 kwargs,  {'id': 1} <class 'dict'>
14:06:30 debug 0
14:06:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489190
}
14:06:31 完整请求
14:06:31 请求结束
14:06:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:31 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:31 kwargs,  {'id': 1} <class 'dict'>
14:06:31 debug 0
14:06:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489191
}
14:06:34 完整请求
14:06:34 请求结束
14:06:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:34 path and query /api/todo/update {} {"id":"1","title":""}
14:06:34 kwargs,  {'id': 1} <class 'dict'>
14:06:34 debug 0
14:06:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489194
}
14:06:35 完整请求
14:06:35 请求结束
14:06:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:35 path and query /api/todo/update {} {"id":"1","title":""}
14:06:35 kwargs,  {'id': 1} <class 'dict'>
14:06:35 debug 0
14:06:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489195
}
14:06:35 完整请求
14:06:35 请求结束
14:06:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:35 path and query /api/todo/update {} {"id":"1","title":""}
14:06:35 kwargs,  {'id': 1} <class 'dict'>
14:06:35 debug 0
14:06:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489195
}
14:06:35 完整请求
14:06:35 请求结束
14:06:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:35 path and query /api/todo/update {} {"id":"1","title":""}
14:06:35 kwargs,  {'id': 1} <class 'dict'>
14:06:35 debug 0
14:06:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489195
}
14:06:36 完整请求
14:06:36 请求结束
14:06:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:36 path and query /api/todo/update {} {"id":"1","title":""}
14:06:36 kwargs,  {'id': 1} <class 'dict'>
14:06:36 debug 0
14:06:36 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489196
}
14:06:36 完整请求
14:06:36 请求结束
14:06:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:36 path and query /api/todo/update {} {"id":"1","title":""}
14:06:36 kwargs,  {'id': 1} <class 'dict'>
14:06:37 debug 0
14:06:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489197
}
14:06:38 完整请求
14:06:38 请求结束
14:06:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:38 path and query /api/todo/update {} {"id":"1","title":"下午2:06:04"}
14:06:38 kwargs,  {'id': 1} <class 'dict'>
14:06:38 debug 0
14:06:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489198
}
14:06:39 完整请求
14:06:39 请求结束
14:06:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:39 path and query /api/todo/delete {'id': '1'} 
14:06:39 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "下午2:06:04",
  "completed": false,
  "ct": 1520489164,
  "ut": 1520489198
}
14:06:40 完整请求
14:06:40 请求结束
14:06:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:40 path and query /api/todo/delete {'id': '2'} 
14:06:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "gua123",
  "completed": false,
  "ct": 1520489166,
  "ut": 1520489166
}
14:06:40 完整请求
14:06:40 请求结束
14:06:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:06:40 path and query /api/todo/delete {'id': '2'} 
14:16:49 完整请求
14:16:49 请求结束
16:05:06 完整请求
16:05:06 请求结束
16:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:06 path and query /todo/index {} 
16:05:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
16:05:06 完整请求
16:05:06 完整请求
16:05:06 请求结束
16:05:06 请求结束
16:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:06 path and query /static {'file': 'gua.js'} 
16:05:06 path and query /static {'file': 'todo.js'} 
16:05:06 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
16:05:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:05:06 完整请求
16:05:06 请求结束
16:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:07 path and query /api/todo/all {} 
16:05:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
16:05:10 完整请求
16:05:10 请求结束
16:05:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:10 path and query /todo {} 
16:05:10 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
16:05:11 完整请求
16:05:11 请求结束
16:05:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:11 path and query / {} 
16:05:11 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /todo/index


16:05:11 完整请求
16:05:11 请求结束
16:05:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:11 path and query /todo/index {} 
16:05:11 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
16:05:11 完整请求
16:05:11 完整请求
16:05:11 请求结束
16:05:11 请求结束
16:05:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:11 path and query /static {'file': 'todo.js'} 
16:05:11 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
16:05:11 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:05:12 完整请求
16:05:12 请求结束
16:05:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:12 path and query /api/todo/all {} 
16:05:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
16:05:20 完整请求
16:05:20 请求结束
16:05:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:21 path and query /weibo {} 
16:05:21 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
16:05:27 完整请求
16:05:27 请求结束
16:05:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:27 path and query /weibo/index {} 
16:05:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:05:27 完整请求
16:05:27 完整请求
16:05:27 请求结束
16:05:27 请求结束
16:05:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:27 path and query /static {'file': 'weibo.js'} 
16:05:27 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:05:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:05:27 完整请求
16:05:27 请求结束
16:05:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:05:27 path and query /api/weibo/all {} 
16:05:27 kwargs,  {'weibo_id': 1} <class 'dict'>
16:05:27 kwargs,  {'weibo_id': 2} <class 'dict'>
16:05:27 kwargs,  {'weibo_id': 3} <class 'dict'>
16:05:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "hello tweet",
    "user_id": 1,
    "comments": [
      {
        "id": 1,
        "content": "楼主说得对",
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "id": 2,
        "content": "lbvu is right",
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "你好",
    "user_id": 1,
    "comments": [
      {
        "id": 3,
        "content": "hello",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 4,
        "content": "123",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 5,
        "content": "asdf",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 7,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "id": 8,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "hahaha",
    "user_id": 1,
    "comments": [
      {
        "id": 6,
        "content": "123",
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
16:06:19 完整请求
16:06:19 请求结束
16:39:36 完整请求
16:39:36 请求结束
16:39:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:39:36 path and query /index {} 
16:39:36 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
16:39:44 完整请求
16:39:44 请求结束
16:39:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:39:44 path and query /weibo/index {} 
16:39:44 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:39:44 完整请求
16:39:44 完整请求
16:39:44 请求结束
16:39:44 请求结束
16:39:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:39:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:39:44 path and query /static {'file': 'weibo.js'} 
16:39:44 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:39:44 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:39:44 完整请求
16:39:44 请求结束
16:39:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:39:44 path and query /api/weibo/all {} 
16:39:44 kwargs,  {'weibo_id': 1} <class 'dict'>
16:39:44 kwargs,  {'weibo_id': 2} <class 'dict'>
16:39:44 kwargs,  {'weibo_id': 3} <class 'dict'>
16:39:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "hello tweet",
    "user_id": 1,
    "comments": [
      {
        "id": 1,
        "content": "楼主说得对",
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "id": 2,
        "content": "lbvu is right",
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "你好",
    "user_id": 1,
    "comments": [
      {
        "id": 3,
        "content": "hello",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 4,
        "content": "123",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 5,
        "content": "asdf",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 7,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "id": 8,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "hahaha",
    "user_id": 1,
    "comments": [
      {
        "id": 6,
        "content": "123",
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
16:54:09 完整请求
16:54:10 请求结束
16:54:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:10 path and query / {} 
16:54:10 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /todo/index


16:54:10 完整请求
16:54:10 请求结束
16:54:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:10 path and query /todo/index {} 
16:54:10 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
16:54:10 完整请求
16:54:10 请求结束
16:54:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:10 path and query /static {'file': 'gua.js'} 
16:54:10 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:54:10 完整请求
16:54:10 请求结束
16:54:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:10 path and query /static {'file': 'todo.js'} 
16:54:10 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
16:54:10 完整请求
16:54:10 请求结束
16:54:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:10 path and query /api/todo/all {} 
16:54:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
16:54:37 完整请求
16:54:37 请求结束
16:54:38 完整请求
16:54:38 请求结束
16:54:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:38 path and query /api/todo/add {} {"title":"23333"}
16:54:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "23333",
  "completed": false,
  "ct": 1520499278,
  "ut": 1520499278
}
16:55:12 完整请求
16:55:12 请求结束
16:55:58 完整请求
16:55:58 请求结束
16:55:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:58 path and query /todo/index {} 
16:55:58 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
16:55:58 完整请求
16:55:58 完整请求
16:55:58 请求结束
16:55:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:58 path and query /static {'file': 'todo.js'} 
16:55:58 path and query /static {'file': 'gua.js'} 
16:55:58 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
16:55:58 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:55:58 完整请求
16:55:58 请求结束
16:55:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:58 path and query /api/todo/all {} 
16:55:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "title": "23333",
    "completed": false,
    "ct": 1520499278,
    "ut": 1520499278
  }
]
16:56:04 完整请求
16:56:04 请求结束
16:56:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:04 path and query /api/todo/add {} 
16:56:12 完整请求
16:56:12 请求结束
16:56:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:12 path and query /api/todo/add {} {"title":"456"}
16:56:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "456",
  "completed": false,
  "ct": 1520499372,
  "ut": 1520499372
}
16:56:12 完整请求
16:56:12 请求结束
16:56:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:12 path and query /api/todo/add {} {"title":"123"}
16:56:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "123",
  "completed": false,
  "ct": 1520499372,
  "ut": 1520499372
}
16:56:14 完整请求
16:56:14 请求结束
16:56:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:14 path and query /api/todo/delete {'id': '3'} 
16:56:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "123",
  "completed": false,
  "ct": 1520499372,
  "ut": 1520499372
}
16:56:16 完整请求
16:56:16 请求结束
16:56:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:16 path and query /api/todo/delete {'id': '2'} 
16:56:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "456",
  "completed": false,
  "ct": 1520499372,
  "ut": 1520499372
}
16:56:18 完整请求
16:56:18 请求结束
16:56:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:18 path and query /api/todo/delete {'id': '1'} 
16:56:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "23333",
  "completed": false,
  "ct": 1520499278,
  "ut": 1520499278
}
16:57:11 完整请求
16:57:11 请求结束
16:57:11 完整请求
16:57:11 请求结束
16:57:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:57:11 path and query /todo/index {} 
16:57:11 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
16:57:11 完整请求
16:57:11 完整请求
16:57:11 请求结束
16:57:11 请求结束
16:57:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:57:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:57:12 path and query /static {'file': 'gua.js'} 

16:57:12 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

16:57:12 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 插入 todo-list
    var todoList = e('.todo-list')
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            // 删除这个 todo
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
16:57:12 完整请求
16:57:12 请求结束
16:57:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:57:12 path and query /api/todo/all {} 
16:57:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
17:01:10 完整请求
17:01:10 请求结束
21:07:41 完整请求
21:07:41 请求结束
21:07:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:07:41 path and query /todo {} 
21:07:41 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:07:42 完整请求
21:07:42 请求结束
21:07:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:07:42 path and query /todo {} 
21:07:42 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:07:42 完整请求
21:07:42 请求结束
21:07:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:07:42 path and query /favicon.ico {} 
21:07:42 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:07:57 完整请求
21:07:57 请求结束
21:07:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:07:57 path and query /admin/users {} 
21:07:57 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:08:02 完整请求
21:08:02 请求结束
21:08:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:02 path and query /api/todo {} 
21:08:02 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:08:13 完整请求
21:08:13 完整请求
21:08:13 完整请求
21:08:13 请求结束
21:08:13 请求结束
21:08:13 请求结束
21:08:14 完整请求
21:08:14 请求结束
21:08:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:14 path and query /api/todo/all {} 
21:08:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
21:08:34 完整请求
21:08:34 完整请求
21:08:34 完整请求
21:08:34 请求结束
21:08:34 请求结束
21:08:34 请求结束
21:08:34 完整请求
21:08:34 请求结束
21:08:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:35 path and query / {} 
21:08:35 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /todo/index


21:08:35 完整请求
21:08:35 请求结束
21:08:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:35 path and query /todo/index {} 
21:08:35 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
21:08:35 完整请求
21:08:35 请求结束
21:08:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:35 path and query /static {'file': 'gua.js'} 
21:08:35 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

21:08:35 完整请求
21:08:35 请求结束
21:08:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:35 path and query /static {'file': 'todo.js'} 
21:08:35 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{实参来自服务器的响应}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给父节点todoList
        var self = event.target //找到click动作的目标位置
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
21:08:36 完整请求
21:08:36 请求结束
21:08:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
21:08:36 path and query /api/todo/all {} 
21:08:36 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
21:08:47 完整请求
21:08:47 请求结束
22:30:15 完整请求
22:30:15 请求结束
22:30:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:15 path and query /todo/all {} 
22:30:15 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:30:20 完整请求
22:30:20 请求结束
22:30:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:20 path and query /todo/ {} 
22:30:20 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:30:22 完整请求
22:30:22 请求结束
22:30:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:22 path and query /todo/ {} 
22:30:22 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:30:29 完整请求
22:30:29 请求结束
22:30:29 完整请求
22:30:29 请求结束
22:30:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:29 path and query /todo/ {} 
22:30:29 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:30:33 完整请求
22:30:33 请求结束
22:30:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:33 path and query /todo/index {} 
22:30:34 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
22:30:34 完整请求
22:30:34 完整请求
22:30:34 请求结束
22:30:34 请求结束
22:30:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:34 path and query /static {'file': 'todo.js'} 
22:30:34 path and query /static {'file': 'gua.js'} 
22:30:34 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

22:30:34 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给父节点todoList
        var self = event.target //找到click动作的目标位置
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
22:30:34 完整请求
22:30:34 请求结束
22:30:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:30:34 path and query /api/todo/all {} 
22:30:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
22:30:45 完整请求
22:30:45 请求结束
22:32:00 完整请求
22:32:00 请求结束
22:32:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:00 path and query /todo/add {} 
22:32:00 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:32:06 完整请求
22:32:06 请求结束
22:32:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:06 path and query /todo/index {} 
22:32:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
22:32:06 完整请求
22:32:06 完整请求
22:32:06 请求结束
22:32:06 请求结束
22:32:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:06 path and query /static {'file': 'todo.js'} 
22:32:06 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给父节点todoList
        var self = event.target //找到click动作的目标位置
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
22:32:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

22:32:06 完整请求
22:32:06 请求结束
22:32:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:06 path and query /api/todo/all {} 
22:32:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
22:32:09 完整请求
22:32:09 请求结束
22:32:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:09 path and query /api/todo/add {} {"title":"123"}
22:32:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "123",
  "completed": false,
  "ct": 1520692329,
  "ut": 1520692329
}
22:32:29 完整请求
22:32:29 请求结束
22:32:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:29 path and query /todo/all {} 
22:32:29 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:32:33 完整请求
22:32:33 请求结束
22:32:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:33 path and query /todo/index {} 
22:32:33 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
22:32:33 完整请求
22:32:33 完整请求
22:32:33 请求结束
22:32:33 请求结束
22:32:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:33 path and query /static {'file': 'gua.js'} 
22:32:33 path and query /static {'file': 'todo.js'} 
22:32:33 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给父节点todoList
        var self = event.target //找到click动作的目标位置
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
22:32:33 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

22:32:33 完整请求
22:32:33 请求结束
22:32:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:32:33 path and query /api/todo/all {} 
22:32:33 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "title": "123",
    "completed": false,
    "ct": 1520692329,
    "ut": 1520692329
  }
]
22:32:51 完整请求
22:32:51 请求结束
22:33:37 完整请求
22:33:37 请求结束
22:33:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:33:37 path and query / {} 
22:33:37 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /todo/index


22:33:37 完整请求
22:33:37 请求结束
22:33:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:33:37 path and query /todo/index {} 
22:33:37 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
22:33:38 完整请求
22:33:38 请求结束
22:33:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:33:38 path and query /static {'file': 'gua.js'} 
22:33:38 完整请求
22:33:38 请求结束
22:33:38 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

22:33:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:33:38 path and query /static {'file': 'todo.js'} 
22:33:38 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给父节点todoList
        var self = event.target //找到click动作的目标位置
        if(self.classList.contains('todo-delete')){
            // 删除这个 todo
            var todoCell = self.parentElement
            var todo_id = todoCell.dataset.id
            apiTodoDelete(todo_id, function(r){
                log('删除成功', todo_id)
                todoCell.remove()
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-edit')){
            var todoCell = self.parentElement
            insertEditForm(todoCell)
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('todo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var todoCell = self.closest('.todo-cell')
            var todo_id = todoCell.dataset.id
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){
                log('更新成功', todo_id)
                var todo = JSON.parse(r)
                var selector = '#todo-' + todo.id
                var todoCell = e(selector)
                var titleSpan = todoCell.querySelector('.todo-title')
                titleSpan.innerHTML = todo.title
//                todoCell.remove()
            })
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()






/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
22:33:38 完整请求
22:33:38 请求结束
22:33:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
22:33:38 path and query /api/todo/all {} 
22:33:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "title": "123",
    "completed": false,
    "ct": 1520692329,
    "ut": 1520692329
  }
]
22:33:50 完整请求
22:33:50 请求结束
00:18:41 完整请求
00:18:41 请求结束
00:18:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:18:41 path and query /api/todo/delete {'id': '1'} 
00:18:41 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "123",
  "completed": false,
  "ct": 1520692329,
  "ut": 1520692329
}
00:18:45 完整请求
00:18:45 请求结束
00:18:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:18:45 path and query /api/todo/add {} {"title":"123"}
00:18:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "title": "123",
  "completed": false,
  "ct": 1520698725,
  "ut": 1520698725
}
00:18:49 完整请求
00:18:49 请求结束
00:18:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:18:49 path and query /api/todo/add {} {"title":"456"}
00:18:49 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "title": "456",
  "completed": false,
  "ct": 1520698729,
  "ut": 1520698729
}
00:18:53 完整请求
00:18:53 请求结束
00:18:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:18:53 path and query /api/todo/add {} {"title":"789"}
00:18:53 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "789",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520698733
}
00:19:04 完整请求
00:19:04 请求结束
00:19:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:19:04 path and query /api/todo/update {} {"id":"3","title":"678888"}
00:19:04 kwargs,  {'id': 3} <class 'dict'>
00:19:04 debug 2
00:19:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "678888",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520698744
}
00:19:06 完整请求
00:19:07 请求结束
00:19:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:19:07 path and query /api/todo/update {} {"id":"3","title":"678888"}
00:19:07 kwargs,  {'id': 3} <class 'dict'>
00:19:07 debug 2
00:19:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "678888",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520698747
}
00:19:09 完整请求
00:19:09 请求结束
00:19:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:19:09 path and query /api/todo/update {} {"id":"3","title":"678888"}
00:19:09 kwargs,  {'id': 3} <class 'dict'>
00:19:09 debug 2
00:19:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "678888",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520698749
}
00:19:12 完整请求
00:19:12 请求结束
00:19:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:19:12 path and query /api/todo/update {} {"id":"3","title":"福州市地方郭德纲"}
00:19:12 kwargs,  {'id': 3} <class 'dict'>
00:19:12 debug 2
00:19:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "福州市地方郭德纲",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520698752
}
00:24:39 完整请求
00:24:39 请求结束
00:24:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:39 path and query /todo/index {} 
00:24:39 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
00:24:39 完整请求
00:24:39 完整请求
00:24:39 请求结束
00:24:39 请求结束
00:24:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:39 path and query /static {'file': 'gua.js'} 
00:24:39 path and query /static {'file': 'todo.js'} 
00:24:39 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

00:24:39 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
//                todoCell.remove()
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
00:24:39 完整请求
00:24:39 请求结束
00:24:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:39 path and query /api/todo/all {} 
00:24:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "title": "123",
    "completed": false,
    "ct": 1520698725,
    "ut": 1520698725
  },
  {
    "id": 2,
    "title": "456",
    "completed": false,
    "ct": 1520698729,
    "ut": 1520698729
  },
  {
    "id": 3,
    "title": "福州市地方郭德纲",
    "completed": false,
    "ct": 1520698733,
    "ut": 1520698752
  }
]
00:24:45 完整请求
00:24:45 请求结束
00:24:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:45 path and query /api/todo/update {} {"id":"3","title":"的冯绍峰"}
00:24:45 kwargs,  {'id': 3} <class 'dict'>
00:24:45 debug 2
00:24:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "的冯绍峰",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520699085
}
00:24:50 完整请求
00:24:50 请求结束
00:24:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:50 path and query /api/todo/update {} {"id":"3","title":"阿说三道四"}
00:24:51 kwargs,  {'id': 3} <class 'dict'>
00:24:51 debug 2
00:24:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "阿说三道四",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520699091
}
00:24:55 完整请求
00:24:55 请求结束
00:24:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:24:55 path and query /api/todo/update {} {"id":"3","title":"阿萨德发的"}
00:24:55 kwargs,  {'id': 3} <class 'dict'>
00:24:55 debug 2
00:24:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "阿萨德发的",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520699095
}
00:25:01 完整请求
00:25:01 请求结束
00:25:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
00:25:01 path and query /api/todo/update {} {"id":"3","title":"啊实打实"}
00:25:01 kwargs,  {'id': 3} <class 'dict'>
00:25:01 debug 2
00:25:01 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "title": "啊实打实",
  "completed": false,
  "ct": 1520698733,
  "ut": 1520699101
}
00:25:24 完整请求
00:25:24 请求结束
13:57:20 完整请求
13:57:20 请求结束
13:57:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
13:57:20 path and query /todo/index {} 
13:57:20 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
13:57:20 完整请求
13:57:20 完整请求
13:57:20 请求结束
13:57:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
13:57:20 path and query /static {'file': 'gua.js'} 
13:57:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
13:57:20 path and query /static {'file': 'todo.js'} 
13:57:20 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
            })
            // 如果上面的update成功，就把editForm这个div干掉
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
13:57:20 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

13:57:21 完整请求
13:57:21 完整请求
13:57:21 请求结束
13:57:21 请求结束
13:57:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
13:57:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
13:57:21 path and query /api/todo/all {} 
13:57:21 path and query /favicon.ico {} 
13:57:21 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
13:57:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "title": "123",
    "completed": false,
    "ct": 1520698725,
    "ut": 1520698725
  },
  {
    "id": 2,
    "title": "456",
    "completed": false,
    "ct": 1520698729,
    "ut": 1520698729
  },
  {
    "id": 3,
    "title": "啊实打实",
    "completed": false,
    "ct": 1520698733,
    "ut": 1520699101
  }
]
13:57:34 完整请求
13:57:34 请求结束
14:28:25 完整请求
14:28:25 请求结束
14:28:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:28:25 path and query /todo {} 
14:28:25 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
14:28:30 完整请求
14:28:30 请求结束
14:28:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:28:30 path and query /weibo/index {} 
14:28:30 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
14:28:30 完整请求
14:28:30 完整请求
14:28:30 请求结束
14:28:30 请求结束
14:28:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:28:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:28:30 path and query /static {'file': 'weibo.js'} 
14:28:30 path and query /static {'file': 'gua.js'} 
14:28:30 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 插入 Weibo-list
    var WeiboList = e('.weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

14:28:30 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

14:28:30 完整请求
14:28:30 请求结束
14:28:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
14:28:30 path and query /api/weibo/all {} 
14:28:30 kwargs,  {'weibo_id': 1} <class 'dict'>
14:28:30 kwargs,  {'weibo_id': 2} <class 'dict'>
14:28:30 kwargs,  {'weibo_id': 3} <class 'dict'>
14:28:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "hello tweet",
    "user_id": 1,
    "comments": [
      {
        "id": 1,
        "content": "楼主说得对",
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "id": 2,
        "content": "lbvu is right",
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "你好",
    "user_id": 1,
    "comments": [
      {
        "id": 3,
        "content": "hello",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 4,
        "content": "123",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 5,
        "content": "asdf",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 7,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "id": 8,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "hahaha",
    "user_id": 1,
    "comments": [
      {
        "id": 6,
        "content": "123",
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
14:28:58 完整请求
14:28:58 请求结束
15:06:14 完整请求
15:06:14 请求结束
15:06:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:06:14 path and query /weibo/index {} 
15:06:14 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:06:14 完整请求
15:06:14 完整请求
15:06:14 请求结束
15:06:14 请求结束
15:06:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:06:14 path and query /static {'file': 'weibo.js'} 
15:06:14 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


/*  Weibo的API */
var apiWeiboAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}
15:06:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // 找到Weibo-list
    var WeiboList = e('.weibo-list')
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:06:14 完整请求
15:06:14 请求结束
15:06:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:06:14 path and query /api/weibo/all {} 
15:06:14 kwargs,  {'weibo_id': 1} <class 'dict'>
15:06:14 kwargs,  {'weibo_id': 2} <class 'dict'>
15:06:14 kwargs,  {'weibo_id': 3} <class 'dict'>
15:06:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "hello tweet",
    "user_id": 1,
    "comments": [
      {
        "id": 1,
        "content": "楼主说得对",
        "weibo_id": 1,
        "user_id": 2
      },
      {
        "id": 2,
        "content": "lbvu is right",
        "weibo_id": 1,
        "user_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "你好",
    "user_id": 1,
    "comments": [
      {
        "id": 3,
        "content": "hello",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 4,
        "content": "123",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 5,
        "content": "asdf",
        "weibo_id": 2,
        "user_id": 1
      },
      {
        "id": 7,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      },
      {
        "id": 8,
        "content": "说得好",
        "weibo_id": 2,
        "user_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "hahaha",
    "user_id": 1,
    "comments": [
      {
        "id": 6,
        "content": "123",
        "weibo_id": 3,
        "user_id": 1
      }
    ]
  }
]
15:26:57 完整请求
15:26:57 请求结束
15:26:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:26:57 path and query /weibo/index {} 
15:26:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list"
         data-method="get"
         data-path="/api/weibo/all"
         data-template="xxtemplate"
    >
        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->

        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:26:57 完整请求
15:26:57 完整请求
15:26:57 请求结束
15:26:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:26:57 path and query /static {'file': 'gua.js'} 
15:26:57 path and query /static {'file': 'weibo.js'} 
15:26:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}


// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}
15:26:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:26:57 完整请求
15:26:57 请求结束
15:26:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:26:57 path and query /api/weibo/all {} 
15:26:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:27:12 完整请求
15:27:12 请求结束
15:34:15 完整请求
15:34:15 请求结束
15:34:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:34:15 path and query /weibo/index {} 
15:34:15 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
        <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->
        
        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <input type="hidden" name="weibo_id" value="">
            <input name="content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:34:15 完整请求
15:34:15 完整请求
15:34:15 请求结束
15:34:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:34:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:34:15 path and query /static {'file': 'gua.js'} 
15:34:15 path and query /static {'file': 'weibo.js'} 
15:34:15 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:34:15 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}


// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}
15:34:15 完整请求
15:34:15 请求结束
15:34:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:34:15 path and query /api/weibo/all {} 
15:34:15 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:34:31 完整请求
15:34:31 请求结束
15:36:20 完整请求
15:36:20 请求结束
15:36:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:36:20 path and query /weibo/index {} 
15:36:20 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
        <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:36:20 完整请求
15:36:20 完整请求
15:36:21 请求结束
15:36:21 请求结束
15:36:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:36:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:36:21 path and query /static {'file': 'gua.js'} 
15:36:21 path and query /static {'file': 'weibo.js'} 
15:36:21 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:36:21 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}


// 增加一个 todo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}
15:36:21 完整请求
15:36:21 请求结束
15:36:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:36:21 path and query /api/weibo/all {} 
15:36:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:36:47 完整请求
15:36:47 请求结束
15:37:59 完整请求
15:37:59 请求结束
15:37:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:37:59 path and query /weibo/index {} 
15:37:59 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
        <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:37:59 完整请求
15:37:59 完整请求
15:37:59 请求结束
15:37:59 请求结束
15:37:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:37:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:37:59 path and query /static {'file': 'gua.js'} 
15:37:59 path and query /static {'file': 'weibo.js'} 
15:37:59 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:37:59 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:37:59 完整请求
15:37:59 请求结束
15:37:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:37:59 path and query /api/weibo/all {} 
15:37:59 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:38:10 完整请求
15:38:10 请求结束
15:38:18 完整请求
15:38:18 请求结束
15:38:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:38:18 path and query /weibo/index {} 
15:38:18 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
        <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:38:18 完整请求
15:38:18 完整请求
15:38:18 请求结束
15:38:18 请求结束
15:38:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:38:18 path and query /static {'file': 'gua.js'} 
15:38:18 path and query /static {'file': 'weibo.js'} 
15:38:18 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
//    bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:38:18 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:38:19 完整请求
15:38:19 请求结束
15:38:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:38:19 path and query /api/weibo/all {} 
15:38:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:38:39 完整请求
15:38:39 请求结束
15:40:51 完整请求
15:40:51 请求结束
15:40:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:40:51 path and query /weibo/index {} 
15:40:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:40:51 完整请求
15:40:51 完整请求
15:40:51 请求结束
15:40:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:40:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:40:51 path and query /static {'file': 'weibo.js'} 
15:40:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:40:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:41:15 完整请求
15:41:15 请求结束
15:41:15 请求结束
15:42:42 完整请求
15:42:42 请求结束
15:42:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:42:42 path and query /weibo/index {} 
15:42:42 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:42:42 完整请求
15:42:42 完整请求
15:42:42 请求结束
15:42:42 请求结束
15:42:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:42:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:42:42 path and query /static {'file': 'weibo.js'} 
15:42:42 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:42:43 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:42:43 完整请求
15:42:43 请求结束
15:42:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:42:43 path and query /api/weibo/all {} 
15:42:43 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:43:21 完整请求
15:43:21 请求结束
15:45:13 完整请求
15:45:13 请求结束
15:45:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:45:13 path and query /weibo/index {} 
15:45:13 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:45:13 完整请求
15:45:13 完整请求
15:45:14 请求结束
15:45:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:45:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:45:14 path and query /static {'file': 'weibo.js'} 
15:45:14 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:45:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-Weibo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:45:14 完整请求
15:45:14 请求结束
15:45:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:45:14 path and query /api/weibo/all {} 
15:45:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:45:27 完整请求
15:45:27 请求结束
15:46:49 完整请求
15:46:49 请求结束
15:46:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:46:49 path and query /weibo/index {} 
15:46:49 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:46:49 完整请求
15:46:49 完整请求
15:46:49 请求结束
15:46:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:46:49 path and query /static {'file': 'gua.js'} 

15:46:49 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
       // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:46:49 完整请求
15:46:49 请求结束
15:46:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:46:49 path and query /api/weibo/all {} 
15:46:49 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:47:24 完整请求
15:47:24 请求结束
15:47:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:24 path and query /weibo/index {} 
15:47:24 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:47:24 完整请求
15:47:24 完整请求
15:47:24 请求结束
15:47:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:24 path and query /static {'file': 'gua.js'} 
15:47:24 path and query /static {'file': 'weibo.js'} 
15:47:24 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        log("input,", input)
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:47:24 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:47:24 完整请求
15:47:24 请求结束
15:47:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:24 path and query /api/weibo/all {} 
15:47:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:47:27 完整请求
15:47:27 请求结束
15:47:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:27 path and query /api/weibo/add {} 
15:47:33 完整请求
15:47:33 请求结束
15:47:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:34 path and query /api/weibo/add {} {"title":"123"}
15:47:34 kwargs,  {'weibo_id': 1} <class 'dict'>
15:47:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "",
  "comments": []
}
15:47:34 完整请求
15:47:34 请求结束
15:47:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:34 path and query /api/weibo/add {} {"title":"123"}
15:47:34 kwargs,  {'weibo_id': 2} <class 'dict'>
15:47:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "",
  "comments": []
}
15:47:34 完整请求
15:47:34 请求结束
15:47:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:34 path and query /api/weibo/add {} {"title":"123"}
15:47:34 kwargs,  {'weibo_id': 3} <class 'dict'>
15:47:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "",
  "comments": []
}
15:47:35 完整请求
15:47:35 请求结束
15:47:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:35 path and query /api/weibo/add {} {"title":"123"}
15:47:35 kwargs,  {'weibo_id': 4} <class 'dict'>
15:47:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "",
  "comments": []
}
15:47:47 完整请求
15:47:47 请求结束
15:47:47 完整请求
15:47:47 请求结束
15:47:47 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:47 path and query /weibo/index {} 
15:47:47 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:47:47 完整请求
15:47:47 完整请求
15:47:47 请求结束
15:47:47 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:47 path and query /static {'file': 'weibo.js'} 
15:47:47 path and query /static {'file': 'gua.js'} 
15:47:48 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        log("input,", input)
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:47:48 完整请求
15:47:48 请求结束
15:47:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:47:48 path and query /api/weibo/all {} 
15:47:48 kwargs,  {'weibo_id': 1} <class 'dict'>
15:47:48 kwargs,  {'weibo_id': 2} <class 'dict'>
15:47:48 kwargs,  {'weibo_id': 3} <class 'dict'>
15:47:48 kwargs,  {'weibo_id': 4} <class 'dict'>
15:47:48 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "",
    "comments": []
  },
  {
    "id": 2,
    "content": "",
    "comments": []
  },
  {
    "id": 3,
    "content": "",
    "comments": []
  },
  {
    "id": 4,
    "content": "",
    "comments": []
  }
]
15:48:04 完整请求
15:48:04 完整请求
15:48:04 请求结束
15:48:04 请求结束
15:49:04 完整请求
15:49:04 请求结束
15:49:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:05 path and query /weibo/index {} 
15:49:05 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:49:05 完整请求
15:49:05 完整请求
15:49:05 请求结束
15:49:05 请求结束
15:49:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:05 path and query /static {'file': 'gua.js'} 
15:49:05 path and query /static {'file': 'weibo.js'} 
15:49:05 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        //log("input,", input)
        var title = input.value
        //log('click add', title)
        var form = {
            'title': title,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:49:05 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:49:05 完整请求
15:49:05 请求结束
15:49:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:05 path and query /api/weibo/all {} 
15:49:05 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:49:08 完整请求
15:49:08 请求结束
15:49:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:08 path and query /api/weibo/add {} 
15:49:08 完整请求
15:49:08 请求结束
15:49:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:08 path and query /api/weibo/add {} 
15:49:13 完整请求
15:49:13 请求结束
15:49:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:13 path and query /api/weibo/add {} {"title":"123"}
15:49:13 kwargs,  {'weibo_id': 1} <class 'dict'>
15:49:13 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "",
  "comments": []
}
15:49:14 完整请求
15:49:14 请求结束
15:49:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:49:14 path and query /api/weibo/add {} {"title":"123"}
15:49:14 kwargs,  {'weibo_id': 2} <class 'dict'>
15:49:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "",
  "comments": []
}
15:53:38 完整请求
15:53:38 请求结束
15:53:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:53:38 path and query /weibo/index {} 
15:53:38 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:53:39 完整请求
15:53:39 请求结束
15:53:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:53:39 path and query /static {'file': 'gua.js'} 
15:53:39 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
15:53:39 完整请求
15:53:39 请求结束
15:53:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:53:39 path and query /static {'file': 'weibo.js'} 
15:53:39 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-delete')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:53:39 完整请求
15:53:39 请求结束
15:53:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:53:39 path and query /api/weibo/all {} 
15:53:39 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
15:53:42 完整请求
15:53:42 请求结束
15:53:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:53:42 path and query /api/weibo/add {} {"content":"123"}
15:53:42 kwargs,  {'weibo_id': 1} <class 'dict'>
15:53:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "123",
  "comments": []
}
15:53:49 完整请求
15:53:49 请求结束
15:53:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:53:50 path and query /api/weibo/add {} 
15:54:08 完整请求
15:54:08 请求结束
15:54:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:54:08 path and query /api/weibo/add {} {"content":"456"}
15:54:08 kwargs,  {'weibo_id': 2} <class 'dict'>
15:54:08 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "456",
  "comments": []
}
15:54:08 完整请求
15:54:08 请求结束
15:54:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
15:54:08 path and query /api/weibo/add {} {"content":"456"}
15:54:08 kwargs,  {'weibo_id': 3} <class 'dict'>
15:54:08 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "456",
  "comments": []
}
16:42:01 完整请求
16:42:01 请求结束
16:42:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:01 path and query /weibo/index {} 
16:42:01 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:42:01 完整请求
16:42:01 完整请求
16:42:01 请求结束
16:42:01 请求结束
16:42:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:01 path and query /static {'file': 'gua.js'} 
16:42:01 path and query /static {'file': 'weibo.js'} 
16:42:01 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:42:01 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:42:01 完整请求
16:42:01 请求结束
16:42:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:02 path and query /api/weibo/all {} 
16:42:02 kwargs,  {'weibo_id': 1} <class 'dict'>
16:42:02 kwargs,  {'weibo_id': 2} <class 'dict'>
16:42:02 kwargs,  {'weibo_id': 3} <class 'dict'>
16:42:02 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  }
]
16:42:21 完整请求
16:42:21 完整请求
16:42:21 请求结束
16:42:21 请求结束
16:42:22 完整请求
16:42:22 请求结束
16:42:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:22 path and query /weibo/index {} 
16:42:22 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:42:22 完整请求
16:42:22 完整请求
16:42:22 请求结束
16:42:22 请求结束
16:42:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:22 path and query /static {'file': 'weibo.js'} 
16:42:22 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:42:22 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:42:22 完整请求
16:42:22 请求结束
16:42:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:22 path and query /api/weibo/all {} 
16:42:22 kwargs,  {'weibo_id': 1} <class 'dict'>
16:42:22 kwargs,  {'weibo_id': 2} <class 'dict'>
16:42:22 kwargs,  {'weibo_id': 3} <class 'dict'>
16:42:22 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  }
]
16:42:27 完整请求
16:42:27 请求结束
16:42:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:27 path and query /weibo/index {} 
16:42:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:42:27 完整请求
16:42:27 请求结束
16:42:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:27 path and query /static {'file': 'gua.js'} 
16:42:27 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:42:27 完整请求
16:42:27 请求结束
16:42:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:27 path and query /static {'file': 'weibo.js'} 
16:42:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:42:27 完整请求
16:42:27 请求结束
16:42:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:27 path and query /api/weibo/all {} 
16:42:27 kwargs,  {'weibo_id': 1} <class 'dict'>
16:42:27 kwargs,  {'weibo_id': 2} <class 'dict'>
16:42:27 kwargs,  {'weibo_id': 3} <class 'dict'>
16:42:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  }
]
16:42:37 完整请求
16:42:37 请求结束
16:42:37 请求结束
16:42:41 完整请求
16:42:41 请求结束
16:42:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:41 path and query /api/weibo/add {} {"content":"789"}
16:42:41 kwargs,  {'weibo_id': 4} <class 'dict'>
16:42:41 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "789",
  "comments": []
}
16:42:46 完整请求
16:42:46 请求结束
16:42:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:46 path and query /api/weibo/add {} 
16:42:54 完整请求
16:42:54 完整请求
16:42:54 请求结束
16:42:54 请求结束
16:42:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:54 path and query /api/weibo/add {} 
16:42:54 path and query /weibo/index {} 
16:42:54 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:42:54 完整请求
16:42:54 完整请求
16:42:54 请求结束
16:42:54 请求结束
16:42:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:54 path and query /api/weibo/add {} 
16:42:54 path and query /static {'file': 'gua.js'} 
16:42:54 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:42:54 完整请求
16:42:54 请求结束
16:42:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:54 path and query /static {'file': 'weibo.js'} 
16:42:54 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:42:55 完整请求
16:42:55 请求结束
16:42:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:42:55 path and query /api/weibo/all {} 
16:42:55 kwargs,  {'weibo_id': 1} <class 'dict'>
16:42:55 kwargs,  {'weibo_id': 2} <class 'dict'>
16:42:55 kwargs,  {'weibo_id': 3} <class 'dict'>
16:42:55 kwargs,  {'weibo_id': 4} <class 'dict'>
16:42:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  },
  {
    "id": 4,
    "content": "789",
    "comments": []
  }
]
16:43:00 完整请求
16:43:00 请求结束
16:43:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:00 path and query /api/weibo/add {} 
16:43:14 完整请求
16:43:14 完整请求
16:43:14 请求结束
16:43:14 请求结束
16:43:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:14 path and query /weibo/index {} 
16:43:14 path and query /api/weibo/add {} 
16:43:14 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:43:14 完整请求
16:43:14 完整请求
16:43:14 请求结束
16:43:14 请求结束
16:43:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:14 path and query /static {'file': 'gua.js'} 
-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:14 path and query /api/weibo/add {} 
16:43:14 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:43:14 完整请求
16:43:14 请求结束
16:43:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:14 path and query /static {'file': 'weibo.js'} 
16:43:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
//    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:43:14 完整请求
16:43:14 请求结束
16:43:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:14 path and query /api/weibo/all {} 
16:43:14 kwargs,  {'weibo_id': 1} <class 'dict'>
16:43:14 kwargs,  {'weibo_id': 2} <class 'dict'>
16:43:14 kwargs,  {'weibo_id': 3} <class 'dict'>
16:43:15 kwargs,  {'weibo_id': 4} <class 'dict'>
16:43:15 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  },
  {
    "id": 4,
    "content": "789",
    "comments": []
  }
]
16:43:20 完整请求
16:43:20 请求结束
16:43:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:20 path and query /api/weibo/add {} 
16:43:21 完整请求
16:43:21 请求结束
16:43:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:21 path and query /api/weibo/add {} {"content":"12233333"}
16:43:21 kwargs,  {'weibo_id': 5} <class 'dict'>
16:43:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "12233333",
  "comments": []
}
16:43:21 完整请求
16:43:21 请求结束
16:43:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:21 path and query /api/weibo/add {} {"content":"12233333"}
16:43:21 kwargs,  {'weibo_id': 6} <class 'dict'>
16:43:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "12233333",
  "comments": []
}
16:43:41 完整请求
16:43:41 请求结束
16:43:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:43:41 path and query /api/weibo/add {} {"content":"12233333"}
16:43:41 kwargs,  {'weibo_id': 7} <class 'dict'>
16:43:41 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "12233333",
  "comments": []
}
16:43:53 完整请求
16:43:53 请求结束
16:44:56 完整请求
16:44:56 请求结束
16:44:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:44:56 path and query /weibo/index {} 
16:44:56 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:44:57 完整请求
16:44:57 完整请求
16:44:57 请求结束
16:44:57 请求结束
16:44:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:44:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:44:57 path and query /static {'file': 'weibo.js'} 
16:44:57 path and query /static {'file': 'gua.js'} 
16:44:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:44:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.Weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:45:13 完整请求
16:45:13 完整请求
16:45:13 请求结束
16:45:13 请求结束
16:45:13 请求结束
16:46:10 完整请求
16:46:10 请求结束
16:46:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:46:10 path and query /weibo/index {} 
16:46:10 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:46:10 完整请求
16:46:10 完整请求
16:46:10 请求结束
16:46:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:46:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:46:10 path and query /static {'file': 'weibo.js'} 
16:46:10 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:46:10 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:46:10 完整请求
16:46:10 请求结束
16:46:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:46:10 path and query /api/weibo/all {} 
16:46:10 kwargs,  {'weibo_id': 1} <class 'dict'>
16:46:10 kwargs,  {'weibo_id': 2} <class 'dict'>
16:46:10 kwargs,  {'weibo_id': 3} <class 'dict'>
16:46:10 kwargs,  {'weibo_id': 4} <class 'dict'>
16:46:10 kwargs,  {'weibo_id': 5} <class 'dict'>
16:46:10 kwargs,  {'weibo_id': 6} <class 'dict'>
16:46:10 kwargs,  {'weibo_id': 7} <class 'dict'>
16:46:11 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  },
  {
    "id": 4,
    "content": "789",
    "comments": []
  },
  {
    "id": 5,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 6,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 7,
    "content": "12233333",
    "comments": []
  }
]
16:47:06 完整请求
16:47:06 请求结束
16:47:06 请求结束
16:48:12 完整请求
16:48:12 请求结束
16:48:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:12 path and query /weibo/index {} 
16:48:12 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:48:12 完整请求
16:48:12 完整请求
16:48:12 请求结束
16:48:12 请求结束
16:48:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:12 path and query /static {'file': 'weibo.js'} 
16:48:12 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:48:12 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:48:12 完整请求
16:48:12 请求结束
16:48:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:12 path and query /api/weibo/all {} 
16:48:12 kwargs,  {'weibo_id': 1} <class 'dict'>
16:48:12 kwargs,  {'weibo_id': 2} <class 'dict'>
16:48:12 kwargs,  {'weibo_id': 3} <class 'dict'>
16:48:12 kwargs,  {'weibo_id': 4} <class 'dict'>
16:48:12 kwargs,  {'weibo_id': 5} <class 'dict'>
16:48:12 kwargs,  {'weibo_id': 6} <class 'dict'>
16:48:12 kwargs,  {'weibo_id': 7} <class 'dict'>
16:48:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  },
  {
    "id": 4,
    "content": "789",
    "comments": []
  },
  {
    "id": 5,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 6,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 7,
    "content": "12233333",
    "comments": []
  }
]
16:48:13 完整请求
16:48:13 请求结束
16:48:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:13 path and query /api/weibo/delete {'id': '1'} 
16:48:13 完整请求
16:48:13 请求结束
16:48:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:13 path and query /api/weibo/delete {'id': '1'} 
16:48:23 完整请求
16:48:23 完整请求
16:48:23 请求结束
16:48:23 请求结束
16:48:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:23 path and query /api/weibo/delete {'id': '1'} 
16:48:23 path and query /weibo/index {} 
16:48:23 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:48:23 完整请求
16:48:23 完整请求
16:48:23 请求结束
16:48:23 请求结束
16:48:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:24 path and query /api/weibo/delete {'id': '1'} 
16:48:24 path and query /api/weibo/delete {'id': '1'} 
16:48:24 完整请求
16:48:24 完整请求
16:48:24 请求结束
16:48:24 请求结束
16:48:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:24 path and query /static {'file': 'weibo.js'} 
16:48:24 path and query /static {'file': 'gua.js'} 
16:48:24 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:48:24 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:48:24 完整请求
16:48:24 请求结束
16:48:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:24 path and query /api/weibo/all {} 
16:48:24 kwargs,  {'weibo_id': 1} <class 'dict'>
16:48:24 kwargs,  {'weibo_id': 2} <class 'dict'>
16:48:24 kwargs,  {'weibo_id': 3} <class 'dict'>
16:48:24 kwargs,  {'weibo_id': 4} <class 'dict'>
16:48:24 kwargs,  {'weibo_id': 5} <class 'dict'>
16:48:24 kwargs,  {'weibo_id': 6} <class 'dict'>
16:48:24 kwargs,  {'weibo_id': 7} <class 'dict'>
16:48:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  },
  {
    "id": 4,
    "content": "789",
    "comments": []
  },
  {
    "id": 5,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 6,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 7,
    "content": "12233333",
    "comments": []
  }
]
16:48:32 完整请求
16:48:32 请求结束
16:48:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:48:32 path and query /api/weibo/delete {'id': '1'} 
16:51:59 完整请求
16:51:59 请求结束
16:51:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:51:59 path and query /weibo/index {} 
16:51:59 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:52:00 完整请求
16:52:00 完整请求
16:52:00 请求结束
16:52:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:00 path and query /static {'file': 'gua.js'} 
16:52:00 path and query /static {'file': 'weibo.js'} 
16:52:00 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:52:00 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:52:00 完整请求
16:52:00 请求结束
16:52:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:00 path and query /api/weibo/all {} 
16:52:00 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:00 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:00 kwargs,  {'weibo_id': 3} <class 'dict'>
16:52:00 kwargs,  {'weibo_id': 4} <class 'dict'>
16:52:00 kwargs,  {'weibo_id': 5} <class 'dict'>
16:52:00 kwargs,  {'weibo_id': 6} <class 'dict'>
16:52:00 kwargs,  {'weibo_id': 7} <class 'dict'>
16:52:00 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "456",
    "comments": []
  },
  {
    "id": 3,
    "content": "456",
    "comments": []
  },
  {
    "id": 4,
    "content": "789",
    "comments": []
  },
  {
    "id": 5,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 6,
    "content": "12233333",
    "comments": []
  },
  {
    "id": 7,
    "content": "12233333",
    "comments": []
  }
]
16:52:03 完整请求
16:52:03 请求结束
16:52:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:03 path and query /api/weibo/delete {'id': '7'} 
16:52:03 kwargs,  {'weibo_id': 7} <class 'dict'>
16:52:03 kwargs,  {'weibo_id': 7} <class 'dict'>
16:52:03 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "12233333",
  "comments": []
}
16:52:04 完整请求
16:52:04 请求结束
16:52:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:04 path and query /api/weibo/delete {'id': '6'} 
16:52:04 kwargs,  {'weibo_id': 6} <class 'dict'>
16:52:04 kwargs,  {'weibo_id': 6} <class 'dict'>
16:52:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "12233333",
  "comments": []
}
16:52:17 完整请求
16:52:17 请求结束
16:52:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:17 path and query /api/weibo/delete {'id': '5'} 
16:52:17 kwargs,  {'weibo_id': 5} <class 'dict'>
16:52:17 kwargs,  {'weibo_id': 5} <class 'dict'>
16:52:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "12233333",
  "comments": []
}
16:52:18 完整请求
16:52:18 请求结束
16:52:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:18 path and query /api/weibo/delete {'id': '4'} 
16:52:18 kwargs,  {'weibo_id': 4} <class 'dict'>
16:52:18 kwargs,  {'weibo_id': 4} <class 'dict'>
16:52:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "789",
  "comments": []
}
16:52:19 完整请求
16:52:19 请求结束
16:52:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:19 path and query /api/weibo/delete {'id': '3'} 
16:52:19 kwargs,  {'weibo_id': 3} <class 'dict'>
16:52:19 kwargs,  {'weibo_id': 3} <class 'dict'>
16:52:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "456",
  "comments": []
}
16:52:20 完整请求
16:52:20 请求结束
16:52:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:20 path and query /api/weibo/delete {'id': '2'} 
16:52:20 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:20 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "456",
  "comments": []
}
16:52:28 完整请求
16:52:28 请求结束
16:52:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:28 path and query /api/weibo/delete {'id': '1'} 
16:52:28 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:28 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "123",
  "comments": []
}
16:52:31 完整请求
16:52:31 请求结束
16:52:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:31 path and query /api/weibo/add {} 
16:52:35 完整请求
16:52:35 完整请求
16:52:35 请求结束
16:52:35 请求结束
16:52:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:35 path and query /weibo/index {} 
16:52:35 path and query /api/weibo/add {} 
16:52:35 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:52:35 完整请求
16:52:35 完整请求
16:52:35 完整请求
16:52:35 请求结束
16:52:35 请求结束
16:52:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:35 path and query /api/weibo/add {} 
16:52:35 path and query /static {'file': 'gua.js'} 
16:52:35 path and query /static {'file': 'weibo.js'} 
16:52:35 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:52:35 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:52:36 完整请求
16:52:36 请求结束
16:52:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:36 path and query /api/weibo/all {} 
16:52:36 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
16:52:38 完整请求
16:52:38 请求结束
16:52:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:38 path and query /api/weibo/add {} 
16:52:39 完整请求
16:52:40 请求结束
16:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:40 path and query /api/weibo/add {} {"content":"aaa"}
16:52:40 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
16:52:40 完整请求
16:52:40 请求结束
16:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:40 path and query /api/weibo/add {} {"content":"aaa"}
16:52:40 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "aaa",
  "comments": []
}
16:52:42 完整请求
16:52:42 请求结束
16:52:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:42 path and query /api/weibo/delete {'id': '2'} 
16:52:42 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:42 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "aaa",
  "comments": []
}
16:52:42 完整请求
16:52:42 请求结束
16:52:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:42 path and query /api/weibo/delete {'id': '1'} 
16:52:42 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:42 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
16:52:44 完整请求
16:52:44 请求结束
16:52:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:44 path and query /api/weibo/add {} {"content":"aaa"}
16:52:44 kwargs,  {'weibo_id': 1} <class 'dict'>
16:52:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
16:52:48 完整请求
16:52:48 请求结束
16:52:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:48 path and query /api/weibo/add {} 
16:52:55 完整请求
16:52:55 请求结束
16:52:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:55 path and query /api/weibo/add {} {"content":"bbb"}
16:52:55 kwargs,  {'weibo_id': 2} <class 'dict'>
16:52:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "bbb",
  "comments": []
}
16:52:55 完整请求
16:52:55 请求结束
16:52:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:55 path and query /api/weibo/add {} {"content":"bbb"}
16:52:55 kwargs,  {'weibo_id': 3} <class 'dict'>
16:52:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "bbb",
  "comments": []
}
16:52:57 完整请求
16:52:57 请求结束
16:52:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:52:57 path and query /api/weibo/delete {'id': '3'} 
16:52:57 kwargs,  {'weibo_id': 3} <class 'dict'>
16:52:57 kwargs,  {'weibo_id': 3} <class 'dict'>
16:52:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "bbb",
  "comments": []
}
16:53:02 完整请求
16:53:02 请求结束
16:53:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:02 path and query /api/weibo/add {} 
16:53:06 完整请求
16:53:06 完整请求
16:53:06 请求结束
16:53:06 请求结束
16:53:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:06 path and query /api/weibo/add {} {"content":"ccc"}
16:53:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:53:06 kwargs,  {'weibo_id': 3} <class 'dict'>
16:53:06 完整请求
16:53:06 完整请求
16:53:06 请求结束
16:53:06 请求结束
16:53:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
16:53:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:06 path and query /static {'file': 'weibo.js'} 
16:53:06 path and query /static {'file': 'gua.js'} 
16:53:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:53:06 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:53:06 完整请求
16:53:06 请求结束
16:53:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:06 path and query /api/weibo/all {} 
16:53:06 kwargs,  {'weibo_id': 1} <class 'dict'>
16:53:06 kwargs,  {'weibo_id': 2} <class 'dict'>
16:53:06 kwargs,  {'weibo_id': 3} <class 'dict'>
16:53:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
16:53:10 完整请求
16:53:10 请求结束
16:53:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:10 path and query /api/weibo/add {} {"content":"ddd"}
16:53:10 kwargs,  {'weibo_id': 4} <class 'dict'>
16:53:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "ddd",
  "comments": []
}
16:53:19 完整请求
16:53:19 请求结束
16:53:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:19 path and query /api/weibo/add {} 
16:53:44 完整请求
16:53:44 请求结束
16:53:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:44 path and query /api/weibo/add {} {"content":"fff"}
16:53:44 kwargs,  {'weibo_id': 5} <class 'dict'>
16:53:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "fff",
  "comments": []
}
16:53:44 完整请求
16:53:44 请求结束
16:53:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:44 path and query /api/weibo/add {} {"content":"eee"}
16:53:45 kwargs,  {'weibo_id': 6} <class 'dict'>
16:53:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "eee",
  "comments": []
}
16:53:50 完整请求
16:53:50 请求结束
16:53:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:50 path and query /api/weibo/delete {'id': '6'} 
16:53:50 kwargs,  {'weibo_id': 6} <class 'dict'>
16:53:50 kwargs,  {'weibo_id': 6} <class 'dict'>
16:53:50 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "eee",
  "comments": []
}
16:53:53 完整请求
16:53:53 请求结束
16:53:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:53 path and query /api/weibo/add {} 
16:53:57 完整请求
16:53:57 完整请求
16:53:57 请求结束
16:53:57 请求结束
16:53:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:57 path and query /weibo/index {} 
16:53:57 path and query /api/weibo/add {} 
16:53:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:53:57 完整请求
16:53:57 完整请求
16:53:57 完整请求
16:53:57 请求结束
16:53:57 请求结束
16:53:57 请求结束
16:53:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:57 path and query /static {'file': 'weibo.js'} 
16:53:57 path and query /static {'file': 'gua.js'} 
16:53:57 path and query /api/weibo/add {} 
16:53:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:53:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:53:57 完整请求
16:53:57 请求结束
16:53:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:53:57 path and query /api/weibo/all {} 
16:53:57 kwargs,  {'weibo_id': 1} <class 'dict'>
16:53:57 kwargs,  {'weibo_id': 2} <class 'dict'>
16:53:58 kwargs,  {'weibo_id': 3} <class 'dict'>
16:53:58 kwargs,  {'weibo_id': 4} <class 'dict'>
16:53:58 kwargs,  {'weibo_id': 5} <class 'dict'>
16:53:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  }
]
16:54:01 完整请求
16:54:01 请求结束
16:54:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:01 path and query /api/weibo/add {} 
16:54:05 完整请求
16:54:05 完整请求
16:54:05 请求结束
16:54:05 请求结束
16:54:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:05 path and query /weibo/index {} 
16:54:05 path and query /api/weibo/add {} 
16:54:05 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:54:05 完整请求
16:54:05 完整请求
16:54:05 请求结束
16:54:05 请求结束
16:54:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:05 path and query /static {'file': 'gua.js'} 
16:54:05 path and query /static {'file': 'weibo.js'} 
16:54:05 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:54:05 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:54:05 完整请求
16:54:06 请求结束
16:54:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:54:06 path and query /api/weibo/all {} 
16:54:06 kwargs,  {'weibo_id': 1} <class 'dict'>
16:54:06 kwargs,  {'weibo_id': 2} <class 'dict'>
16:54:06 kwargs,  {'weibo_id': 3} <class 'dict'>
16:54:06 kwargs,  {'weibo_id': 4} <class 'dict'>
16:54:06 kwargs,  {'weibo_id': 5} <class 'dict'>
16:54:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  }
]
16:55:20 完整请求
16:55:20 请求结束
16:55:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:20 path and query /weibo/index {} 
16:55:20 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:55:20 完整请求
16:55:20 完整请求
16:55:20 请求结束
16:55:20 请求结束
16:55:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:20 path and query /static {'file': 'gua.js'} 
16:55:20 path and query /static {'file': 'weibo.js'} 
16:55:20 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:55:20 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:55:20 完整请求
16:55:20 请求结束
16:55:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:20 path and query /api/weibo/all {} 
16:55:20 kwargs,  {'weibo_id': 1} <class 'dict'>
16:55:20 kwargs,  {'weibo_id': 2} <class 'dict'>
16:55:20 kwargs,  {'weibo_id': 3} <class 'dict'>
16:55:20 kwargs,  {'weibo_id': 4} <class 'dict'>
16:55:20 kwargs,  {'weibo_id': 5} <class 'dict'>
16:55:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  }
]
16:55:25 完整请求
16:55:25 请求结束
16:55:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:25 path and query /api/weibo/add {} 
16:55:25 完整请求
16:55:25 请求结束
16:55:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:25 path and query /api/weibo/add {} 
16:55:27 完整请求
16:55:27 请求结束
16:55:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:27 path and query /api/weibo/add {} {"content":"kkk"}
16:55:27 kwargs,  {'weibo_id': 6} <class 'dict'>
16:55:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "kkk",
  "comments": []
}
16:55:27 完整请求
16:55:27 请求结束
16:55:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:27 path and query /api/weibo/add {} {"content":"kkk"}
16:55:27 kwargs,  {'weibo_id': 7} <class 'dict'>
16:55:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "kkk",
  "comments": []
}
16:55:55 完整请求
16:55:55 请求结束
16:55:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:55:55 path and query /api/weibo/delete {'id': '7'} 
16:55:55 kwargs,  {'weibo_id': 7} <class 'dict'>
16:55:55 kwargs,  {'weibo_id': 7} <class 'dict'>
16:55:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "kkk",
  "comments": []
}
16:56:09 完整请求
16:56:09 请求结束
16:56:10 完整请求
16:56:10 请求结束
16:56:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:10 path and query /api/weibo/add {} {"content":"kkk"}
16:56:10 kwargs,  {'weibo_id': 7} <class 'dict'>
16:56:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "kkk",
  "comments": []
}
16:56:12 完整请求
16:56:12 请求结束
16:56:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:12 path and query /api/weibo/delete {'id': '7'} 
16:56:12 kwargs,  {'weibo_id': 7} <class 'dict'>
16:56:12 kwargs,  {'weibo_id': 7} <class 'dict'>
16:56:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "kkk",
  "comments": []
}
16:56:16 完整请求
16:56:16 请求结束
16:56:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:16 path and query /api/weibo/add {} {"content":"kkk"}
16:56:16 kwargs,  {'weibo_id': 7} <class 'dict'>
16:56:16 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "kkk",
  "comments": []
}
16:56:17 完整请求
16:56:17 请求结束
16:56:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:17 path and query /api/weibo/delete {'id': '7'} 
16:56:17 kwargs,  {'weibo_id': 7} <class 'dict'>
16:56:17 kwargs,  {'weibo_id': 7} <class 'dict'>
16:56:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 7,
  "content": "kkk",
  "comments": []
}
16:56:21 完整请求
16:56:21 请求结束
16:56:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:21 path and query /weibo/index {} 
16:56:21 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:56:21 完整请求
16:56:21 完整请求
16:56:21 请求结束
16:56:21 请求结束
16:56:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:21 path and query /static {'file': 'weibo.js'} 
16:56:21 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:56:21 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:56:21 完整请求
16:56:21 请求结束
16:56:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:21 path and query /api/weibo/all {} 
16:56:21 kwargs,  {'weibo_id': 1} <class 'dict'>
16:56:21 kwargs,  {'weibo_id': 2} <class 'dict'>
16:56:21 kwargs,  {'weibo_id': 3} <class 'dict'>
16:56:21 kwargs,  {'weibo_id': 4} <class 'dict'>
16:56:21 kwargs,  {'weibo_id': 5} <class 'dict'>
16:56:21 kwargs,  {'weibo_id': 6} <class 'dict'>
16:56:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
16:56:27 完整请求
16:56:27 请求结束
16:56:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:27 path and query /weibo/index {} 
16:56:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
16:56:27 完整请求
16:56:27 请求结束
16:56:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:27 path and query /static {'file': 'gua.js'} 
16:56:27 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
16:56:27 完整请求
16:56:27 请求结束
16:56:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:27 path and query /static {'file': 'weibo.js'} 
16:56:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' data-id=${id}>
            <div>
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='Weibo-edit-form'>
            <input class="Weibo-edit-input">
            <button class='Weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-edit')){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('Weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.Weibo-edit-input')
            var title = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.Weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'title': title,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#Weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.Weibo-title')
                titleSpan.innerHTML = Weibo.title
//                WeiboCell.remove()
            })
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

16:56:27 完整请求
16:56:27 请求结束
16:56:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:27 path and query /api/weibo/all {} 
16:56:27 kwargs,  {'weibo_id': 1} <class 'dict'>
16:56:27 kwargs,  {'weibo_id': 2} <class 'dict'>
16:56:28 kwargs,  {'weibo_id': 3} <class 'dict'>
16:56:28 kwargs,  {'weibo_id': 4} <class 'dict'>
16:56:28 kwargs,  {'weibo_id': 5} <class 'dict'>
16:56:28 kwargs,  {'weibo_id': 6} <class 'dict'>
16:56:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
16:56:35 完整请求
16:56:35 请求结束
16:56:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
16:56:35 path and query /api/weibo/add {} 
17:47:40 完整请求
17:47:40 完整请求
17:47:40 请求结束
17:47:40 请求结束
17:47:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:47:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:47:40 path and query /weibo/index {} 
17:47:40 path and query /api/weibo/add {} 
17:47:40 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
17:47:40 完整请求
17:47:40 完整请求
17:47:40 请求结束
17:47:40 请求结束
17:47:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:47:40 path and query /static {'file': 'gua.js'} 
17:47:40 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
17:47:40 完整请求
17:47:40 请求结束
17:47:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:47:40 path and query /static {'file': 'weibo.js'} 
17:47:40 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

17:47:41 完整请求
17:47:41 请求结束
17:47:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:47:41 path and query /api/weibo/all {} 
17:47:41 kwargs,  {'weibo_id': 1} <class 'dict'>
17:47:41 kwargs,  {'weibo_id': 2} <class 'dict'>
17:47:41 kwargs,  {'weibo_id': 3} <class 'dict'>
17:47:41 kwargs,  {'weibo_id': 4} <class 'dict'>
17:47:41 kwargs,  {'weibo_id': 5} <class 'dict'>
17:47:41 kwargs,  {'weibo_id': 6} <class 'dict'>
17:47:41 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
17:51:12 完整请求
17:51:12 请求结束
17:51:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:51:12 path and query /weibo/index {} 
17:51:12 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
17:51:12 完整请求
17:51:12 完整请求
17:51:12 请求结束
17:51:12 请求结束
17:51:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:51:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:51:13 path and query /static {'file': 'weibo.js'} 
17:51:13 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

17:51:13 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
17:51:13 完整请求
17:51:13 请求结束
17:51:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:51:13 path and query /api/weibo/all {} 
17:51:13 kwargs,  {'weibo_id': 1} <class 'dict'>
17:51:13 kwargs,  {'weibo_id': 2} <class 'dict'>
17:51:13 kwargs,  {'weibo_id': 3} <class 'dict'>
17:51:13 kwargs,  {'weibo_id': 4} <class 'dict'>
17:51:13 kwargs,  {'weibo_id': 5} <class 'dict'>
17:51:13 kwargs,  {'weibo_id': 6} <class 'dict'>
17:51:13 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
17:51:19 完整请求
17:51:19 请求结束
17:51:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:51:19 path and query /api/todo/update {} 
17:51:19 完整请求
17:51:19 请求结束
17:51:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:51:19 path and query /api/todo/update {} 
17:51:59 完整请求
17:51:59 请求结束
17:52:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:52:00 path and query /api/todo/update {} {"id":"1","content":"aaa123"}
17:52:00 kwargs,  {'id': 1} <class 'dict'>
17:52:00 完整请求
17:52:00 请求结束
17:52:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:52:00 path and query /api/todo/update {} {"id":"1","content":"aaa123"}
17:52:00 kwargs,  {'id': 1} <class 'dict'>
17:53:16 完整请求
17:53:16 请求结束
17:53:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:53:16 path and query /weibo/index {} 
17:53:16 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
17:53:16 完整请求
17:53:16 完整请求
17:53:16 请求结束
17:53:16 请求结束
17:53:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:53:16 path and query /static {'file': 'weibo.js'} 
17:53:16 path and query /static {'file': 'gua.js'} 
17:53:16 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */
///////////////////////////

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}


// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
17:53:16 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

17:53:16 完整请求
17:53:16 请求结束
17:53:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:53:16 path and query /api/weibo/all {} 
17:53:16 kwargs,  {'weibo_id': 1} <class 'dict'>
17:53:16 kwargs,  {'weibo_id': 2} <class 'dict'>
17:53:16 kwargs,  {'weibo_id': 3} <class 'dict'>
17:53:16 kwargs,  {'weibo_id': 4} <class 'dict'>
17:53:16 kwargs,  {'weibo_id': 5} <class 'dict'>
17:53:16 kwargs,  {'weibo_id': 6} <class 'dict'>
17:53:16 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
17:53:22 完整请求
17:53:22 请求结束
17:53:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:53:22 path and query /api/todo/update {} 
17:53:22 完整请求
17:53:22 请求结束
17:53:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:53:22 path and query /api/todo/update {} 
17:54:12 完整请求
17:54:12 请求结束
17:54:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:54:12 path and query /api/todo/update {} {"id":"1","content":"123"}
17:54:12 kwargs,  {'id': 1} <class 'dict'>
17:54:13 完整请求
17:54:13 请求结束
17:54:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:54:13 path and query /api/todo/update {} {"id":"1","content":"aaa123"}
17:54:13 kwargs,  {'id': 1} <class 'dict'>
17:57:08 完整请求
17:57:08 请求结束
17:57:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:08 path and query /weibo/index {} 
17:57:08 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
17:57:08 完整请求
17:57:08 完整请求
17:57:08 请求结束
17:57:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:08 path and query /static {'file': 'gua.js'} 
17:57:08 path and query /static {'file': 'weibo.js'} 
17:57:08 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

17:57:08 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
17:57:08 完整请求
17:57:08 请求结束
17:57:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:08 path and query /api/weibo/all {} 
17:57:08 kwargs,  {'weibo_id': 1} <class 'dict'>
17:57:08 kwargs,  {'weibo_id': 2} <class 'dict'>
17:57:08 kwargs,  {'weibo_id': 3} <class 'dict'>
17:57:08 kwargs,  {'weibo_id': 4} <class 'dict'>
17:57:08 kwargs,  {'weibo_id': 5} <class 'dict'>
17:57:08 kwargs,  {'weibo_id': 6} <class 'dict'>
17:57:08 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
17:57:14 完整请求
17:57:14 请求结束
17:57:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:15 path and query /api/weibo/update {} 
17:57:15 完整请求
17:57:15 请求结束
17:57:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:15 path and query /api/weibo/update {} 
17:57:45 完整请求
17:57:45 请求结束
17:57:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:45 path and query /api/weibo/update {} {"id":"1","content":"111111"}
17:57:45 完整请求
17:57:46 请求结束
17:57:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
17:57:46 path and query /api/weibo/update {} {"id":"1","content":"aaa123"}
18:01:50 完整请求
18:01:50 请求结束
18:01:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:01:51 path and query /weibo/index {} 
18:01:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
18:01:51 完整请求
18:01:51 完整请求
18:01:51 请求结束
18:01:51 请求结束
18:01:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:01:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:01:51 path and query /static {'file': 'weibo.js'} 
18:01:51 path and query /static {'file': 'gua.js'} 
18:01:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

18:01:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
18:01:51 完整请求
18:01:51 请求结束
18:01:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:01:51 path and query /api/weibo/all {} 
18:01:51 kwargs,  {'weibo_id': 1} <class 'dict'>
18:01:51 kwargs,  {'weibo_id': 2} <class 'dict'>
18:01:51 kwargs,  {'weibo_id': 3} <class 'dict'>
18:01:51 kwargs,  {'weibo_id': 4} <class 'dict'>
18:01:51 kwargs,  {'weibo_id': 5} <class 'dict'>
18:01:51 kwargs,  {'weibo_id': 6} <class 'dict'>
18:01:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
18:01:56 完整请求
18:01:56 请求结束
18:01:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:01:56 path and query /api/weibo/update {} 
18:01:56 完整请求
18:01:56 请求结束
18:01:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:01:56 path and query /api/weibo/update {} 
18:06:18 完整请求
18:06:18 请求结束
18:06:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:06:18 path and query /weibo/index {} 
18:06:18 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
18:06:18 完整请求
18:06:18 完整请求
18:06:18 请求结束
18:06:18 请求结束
18:06:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:06:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:06:19 path and query /static {'file': 'gua.js'} 
18:06:19 path and query /static {'file': 'weibo.js'} 
18:06:19 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

18:06:19 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
18:06:19 完整请求
18:06:19 请求结束
18:06:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:06:19 path and query /api/weibo/all {} 
18:06:19 kwargs,  {'weibo_id': 1} <class 'dict'>
18:06:19 kwargs,  {'weibo_id': 2} <class 'dict'>
18:06:19 kwargs,  {'weibo_id': 3} <class 'dict'>
18:06:19 kwargs,  {'weibo_id': 4} <class 'dict'>
18:06:19 kwargs,  {'weibo_id': 5} <class 'dict'>
18:06:19 kwargs,  {'weibo_id': 6} <class 'dict'>
18:06:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
18:06:38 完整请求
18:06:38 请求结束
18:06:38 请求结束
18:06:38 完整请求
18:06:38 请求结束
18:06:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:06:38 path and query /api/weibo/update {} {"id":"1","content":"123"}
18:06:38 kwargs,  {'id': 1} <class 'dict'>
18:06:38 debug 0
18:06:38 kwargs,  {'weibo_id': 1} <class 'dict'>
18:06:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "123",
  "comments": []
}
18:06:55 完整请求
18:06:55 请求结束
18:07:06 完整请求
18:07:06 请求结束
18:07:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:07:06 path and query /api/weibo/update {} {"id":"1","content":"456"}
18:07:06 kwargs,  {'id': 1} <class 'dict'>
18:07:06 debug 0
18:07:06 kwargs,  {'weibo_id': 1} <class 'dict'>
18:07:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "456",
  "comments": []
}
18:07:22 完整请求
18:07:22 请求结束
18:07:28 完整请求
18:07:28 请求结束
18:07:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:07:28 path and query /weibo/index {} 
18:07:28 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
18:07:28 完整请求
18:07:28 完整请求
18:07:28 请求结束
18:07:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:07:28 path and query /static {'file': 'weibo.js'} 
18:07:28 path and query /static {'file': 'gua.js'} 
18:07:28 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

18:07:28 完整请求
18:07:28 请求结束
18:07:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:07:28 path and query /api/weibo/all {} 
18:07:28 kwargs,  {'weibo_id': 1} <class 'dict'>
18:07:28 kwargs,  {'weibo_id': 2} <class 'dict'>
18:07:28 kwargs,  {'weibo_id': 3} <class 'dict'>
18:07:29 kwargs,  {'weibo_id': 4} <class 'dict'>
18:07:29 kwargs,  {'weibo_id': 5} <class 'dict'>
18:07:29 kwargs,  {'weibo_id': 6} <class 'dict'>
18:07:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "456",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
18:07:33 完整请求
18:07:33 请求结束
18:07:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:07:33 path and query /api/weibo/update {} 
18:07:33 完整请求
18:07:33 请求结束
18:07:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:07:33 path and query /api/weibo/update {} 
18:08:04 完整请求
18:08:04 请求结束
18:08:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:04 path and query /api/weibo/update {} {"id":"1","content":"123"}
18:08:04 kwargs,  {'id': 1} <class 'dict'>
18:08:04 debug 0
18:08:04 kwargs,  {'weibo_id': 1} <class 'dict'>
18:08:05 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "123",
  "comments": []
}
18:08:05 完整请求
18:08:05 请求结束
18:08:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:05 path and query /api/weibo/update {} {"id":"1","content":"789"}
18:08:05 kwargs,  {'id': 1} <class 'dict'>
18:08:05 debug 0
18:08:05 kwargs,  {'weibo_id': 1} <class 'dict'>
18:08:05 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "789",
  "comments": []
}
18:08:15 完整请求
18:08:15 请求结束
18:08:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:15 path and query /api/weibo/update {} {"id":"2","content":"4444444444444444"}
18:08:15 kwargs,  {'id': 2} <class 'dict'>
18:08:15 debug 1
18:08:15 kwargs,  {'weibo_id': 2} <class 'dict'>
18:08:15 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "4444444444444444",
  "comments": []
}
18:08:22 完整请求
18:08:22 请求结束
18:08:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:22 path and query /api/weibo/update {} 
18:08:31 完整请求
18:08:31 请求结束
18:08:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:31 path and query /api/weibo/update {} {"id":"3","content":"111111111111111"}
18:08:31 kwargs,  {'id': 3} <class 'dict'>
18:08:31 debug 2
18:08:31 kwargs,  {'weibo_id': 3} <class 'dict'>
18:08:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "111111111111111",
  "comments": []
}
18:08:32 完整请求
18:08:32 请求结束
18:08:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:32 path and query /api/weibo/update {} {"id":"3","content":"123333"}
18:08:32 kwargs,  {'id': 3} <class 'dict'>
18:08:32 debug 2
18:08:32 kwargs,  {'weibo_id': 3} <class 'dict'>
18:08:32 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "123333",
  "comments": []
}
18:08:44 完整请求
18:08:44 请求结束
18:08:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:44 path and query /weibo/index {} 
18:08:44 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
18:08:44 完整请求
18:08:44 完整请求
18:08:44 请求结束
18:08:44 请求结束
18:08:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:44 path and query /static {'file': 'gua.js'} 

18:08:44 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

18:08:44 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
18:08:44 完整请求
18:08:44 请求结束
18:08:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:44 path and query /api/weibo/all {} 
18:08:44 kwargs,  {'weibo_id': 1} <class 'dict'>
18:08:44 kwargs,  {'weibo_id': 2} <class 'dict'>
18:08:44 kwargs,  {'weibo_id': 3} <class 'dict'>
18:08:44 kwargs,  {'weibo_id': 4} <class 'dict'>
18:08:44 kwargs,  {'weibo_id': 5} <class 'dict'>
18:08:45 kwargs,  {'weibo_id': 6} <class 'dict'>
18:08:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "789",
    "comments": []
  },
  {
    "id": 2,
    "content": "4444444444444444",
    "comments": []
  },
  {
    "id": 3,
    "content": "123333",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk",
    "comments": []
  }
]
18:08:51 完整请求
18:08:51 请求结束
18:08:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:51 path and query /api/weibo/update {} 
18:08:51 完整请求
18:08:51 请求结束
18:08:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:51 path and query /api/weibo/update {} 
18:08:57 完整请求
18:08:57 请求结束
18:08:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:57 path and query /api/weibo/update {} {"id":"2","content":"bbb"}
18:08:57 kwargs,  {'id': 2} <class 'dict'>
18:08:57 debug 1
18:08:58 kwargs,  {'weibo_id': 2} <class 'dict'>
18:08:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "bbb",
  "comments": []
}
18:08:58 完整请求
18:08:58 请求结束
18:08:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:08:58 path and query /api/weibo/update {} {"id":"1","content":"aaa"}
18:08:58 kwargs,  {'id': 1} <class 'dict'>
18:08:58 debug 0
18:08:58 kwargs,  {'weibo_id': 1} <class 'dict'>
18:08:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
18:09:06 完整请求
18:09:07 请求结束
18:09:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:07 path and query /api/weibo/update {} {"id":"1","content":"aaa"}
18:09:07 kwargs,  {'id': 1} <class 'dict'>
18:09:07 debug 0
18:09:07 kwargs,  {'weibo_id': 1} <class 'dict'>
18:09:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
18:09:13 完整请求
18:09:13 请求结束
18:09:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:13 path and query /api/weibo/update {} 
18:09:21 完整请求
18:09:21 请求结束
18:09:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:21 path and query /api/weibo/update {} 
18:09:21 完整请求
18:09:21 请求结束
18:09:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:21 path and query /api/weibo/update {} {"id":"3","content":"ccc"}
18:09:21 kwargs,  {'id': 3} <class 'dict'>
18:09:21 debug 2
18:09:21 kwargs,  {'weibo_id': 3} <class 'dict'>
18:09:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
18:09:28 完整请求
18:09:28 请求结束
18:09:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:28 path and query /api/weibo/update {} {"id":"4","content":"ddd123"}
18:09:28 kwargs,  {'id': 4} <class 'dict'>
18:09:28 debug 3
18:09:28 kwargs,  {'weibo_id': 4} <class 'dict'>
18:09:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "ddd123",
  "comments": []
}
18:09:35 完整请求
18:09:35 请求结束
18:09:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:35 path and query /api/weibo/update {} 
18:09:53 完整请求
18:09:53 请求结束
18:09:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:53 path and query /api/weibo/update {} {"id":"5","content":"fff233"}
18:09:53 kwargs,  {'id': 5} <class 'dict'>
18:09:53 debug 4
18:09:53 kwargs,  {'weibo_id': 5} <class 'dict'>
18:09:53 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "fff233",
  "comments": []
}
18:09:53 完整请求
18:09:53 请求结束
18:09:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:09:53 path and query /api/weibo/update {} {"id":"5","content":"222fff"}
18:09:53 kwargs,  {'id': 5} <class 'dict'>
18:09:53 debug 4
18:09:53 kwargs,  {'weibo_id': 5} <class 'dict'>
18:09:53 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "222fff",
  "comments": []
}
18:10:07 完整请求
18:10:07 请求结束
18:10:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:10:07 path and query /api/weibo/update {} {"id":"6","content":"kkk233"}
18:10:07 kwargs,  {'id': 6} <class 'dict'>
18:10:07 debug 5
18:10:07 kwargs,  {'weibo_id': 6} <class 'dict'>
18:10:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "kkk233",
  "comments": []
}
18:10:32 完整请求
18:10:32 请求结束
18:11:28 完整请求
18:11:28 请求结束
18:11:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:11:28 path and query /weibo/index {} 
18:11:28 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
18:11:28 完整请求
18:11:28 完整请求
18:11:28 请求结束
18:11:28 请求结束
18:11:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:11:28 path and query /static {'file': 'gua.js'} 
18:11:28 path and query /static {'file': 'weibo.js'} 
18:11:28 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

18:11:28 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
18:11:28 完整请求
18:11:28 请求结束
18:11:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:11:28 path and query /api/weibo/all {} 
18:11:28 kwargs,  {'weibo_id': 1} <class 'dict'>
18:11:28 kwargs,  {'weibo_id': 2} <class 'dict'>
18:11:28 kwargs,  {'weibo_id': 3} <class 'dict'>
18:11:28 kwargs,  {'weibo_id': 4} <class 'dict'>
18:11:29 kwargs,  {'weibo_id': 5} <class 'dict'>
18:11:29 kwargs,  {'weibo_id': 6} <class 'dict'>
18:11:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "222fff",
    "comments": []
  },
  {
    "id": 6,
    "content": "kkk233",
    "comments": []
  }
]
18:11:54 完整请求
18:11:54 完整请求
18:11:54 请求结束
18:11:55 完整请求
18:11:55 请求结束
18:11:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:11:55 path and query /api/weibo/delete {'id': '6'} 
18:11:55 kwargs,  {'weibo_id': 6} <class 'dict'>
18:11:55 kwargs,  {'weibo_id': 6} <class 'dict'>
18:11:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 6,
  "content": "kkk233",
  "comments": []
}
18:12:08 完整请求
18:12:08 请求结束
18:12:18 完整请求
18:12:18 请求结束
18:12:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:12:18 path and query /weibo/index {} 
18:12:18 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
18:12:18 完整请求
18:12:18 完整请求
18:12:19 请求结束
18:12:19 请求结束
18:12:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:12:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:12:19 path and query /static {'file': 'weibo.js'} 
18:12:19 path and query /static {'file': 'gua.js'} 
18:12:19 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
18:12:19 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

18:12:19 完整请求
18:12:19 请求结束
18:12:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
18:12:19 path and query /api/weibo/all {} 
18:12:19 kwargs,  {'weibo_id': 1} <class 'dict'>
18:12:19 kwargs,  {'weibo_id': 2} <class 'dict'>
18:12:19 kwargs,  {'weibo_id': 3} <class 'dict'>
18:12:19 kwargs,  {'weibo_id': 4} <class 'dict'>
18:12:19 kwargs,  {'weibo_id': 5} <class 'dict'>
18:12:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "222fff",
    "comments": []
  }
]
18:13:08 完整请求
18:13:08 完整请求
18:13:08 请求结束
18:13:08 请求结束
19:07:36 完整请求
19:07:36 请求结束
19:07:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:36 path and query /weibo/index {} 
19:07:36 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:07:36 完整请求
19:07:36 完整请求
19:07:36 请求结束
19:07:36 请求结束
19:07:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:37 path and query /static {'file': 'gua.js'} 
19:07:37 path and query /static {'file': 'weibo.js'} 
19:07:37 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:07:37 完整请求
19:07:37 请求结束
19:07:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:37 path and query /api/weibo/all {} 
19:07:37 kwargs,  {'weibo_id': 1} <class 'dict'>
19:07:37 kwargs,  {'weibo_id': 2} <class 'dict'>
19:07:37 kwargs,  {'weibo_id': 3} <class 'dict'>
19:07:37 kwargs,  {'weibo_id': 4} <class 'dict'>
19:07:37 kwargs,  {'weibo_id': 5} <class 'dict'>
19:07:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "222fff",
    "comments": []
  }
]
19:07:43 完整请求
19:07:43 请求结束
19:07:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:43 path and query /api/weibo/update {} 
19:07:43 完整请求
19:07:43 请求结束
19:07:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:43 path and query /api/weibo/update {} 
19:07:51 完整请求
19:07:51 完整请求
19:07:51 请求结束
19:07:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:51 path and query /api/weibo/update {} 
19:07:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:07:51 完整请求
19:07:51 完整请求
19:07:51 请求结束
19:07:51 请求结束
19:07:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:51 path and query /api/weibo/update {} 
19:07:51 path and query /static {'file': 'gua.js'} 
19:07:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:07:51 完整请求
19:07:51 请求结束
19:07:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:51 path and query /static {'file': 'weibo.js'} 
19:07:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:07:52 完整请求
19:07:52 请求结束
19:07:52 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:52 path and query /api/weibo/all {} 
19:07:52 kwargs,  {'weibo_id': 1} <class 'dict'>
19:07:52 kwargs,  {'weibo_id': 2} <class 'dict'>
19:07:52 kwargs,  {'weibo_id': 3} <class 'dict'>
19:07:52 kwargs,  {'weibo_id': 4} <class 'dict'>
19:07:52 kwargs,  {'weibo_id': 5} <class 'dict'>
19:07:52 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "222fff",
    "comments": []
  }
]
19:07:58 完整请求
19:07:58 请求结束
19:07:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:07:58 path and query /api/weibo/update {} 
19:12:27 完整请求
19:12:27 请求结束
19:12:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:12:27 path and query /weibo/index {} 
19:12:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:12:27 完整请求
19:12:27 完整请求
19:12:27 请求结束
19:12:27 请求结束
19:12:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:12:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:12:27 path and query /static {'file': 'weibo.js'} 
19:12:27 path and query /static {'file': 'gua.js'} 
19:12:27 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:12:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:12:27 完整请求
19:12:27 请求结束
19:12:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:12:28 path and query /api/weibo/all {} 
19:12:28 kwargs,  {'weibo_id': 1} <class 'dict'>
19:12:28 kwargs,  {'weibo_id': 2} <class 'dict'>
19:12:28 kwargs,  {'weibo_id': 3} <class 'dict'>
19:12:28 kwargs,  {'weibo_id': 4} <class 'dict'>
19:12:28 kwargs,  {'weibo_id': 5} <class 'dict'>
19:12:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "222fff",
    "comments": []
  }
]
19:12:37 完整请求
19:12:37 完整请求
19:12:37 请求结束
19:12:37 请求结束
19:12:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'user=dsd9dd4ffc8debgh']
19:12:37 path and query /api/weibo/update {} 
19:13:28 完整请求
19:13:28 请求结束
19:13:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:28 path and query /weibo/index {} 
19:13:28 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:13:29 完整请求
19:13:29 完整请求
19:13:29 请求结束
19:13:29 请求结束
19:13:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:29 path and query /static {'file': 'weibo.js'} 
19:13:29 path and query /static {'file': 'gua.js'} 
19:13:29 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:13:29 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:13:29 完整请求
19:13:29 请求结束
19:13:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:29 path and query /api/weibo/all {} 
19:13:29 完整请求
19:13:29 kwargs,  {'weibo_id': 1} <class 'dict'>
19:13:29 请求结束
19:13:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:29 kwargs,  {'weibo_id': 2} <class 'dict'>
19:13:29 path and query /favicon.ico {} 
19:13:29 kwargs,  {'weibo_id': 3} <class 'dict'>
19:13:29 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
19:13:29 kwargs,  {'weibo_id': 4} <class 'dict'>
19:13:29 kwargs,  {'weibo_id': 5} <class 'dict'>
19:13:29 完整请求
19:13:29 请求结束
19:13:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "222fff",
    "comments": []
  }
]
19:13:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:29 path and query /favicon.ico {} 
19:13:29 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
19:13:36 完整请求
19:13:36 请求结束
19:13:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:36 path and query /api/weibo/update {} {"id":"1","content":"aaa123"}
19:13:36 kwargs,  {'id': 1} <class 'dict'>
19:13:36 debug 0
19:13:36 kwargs,  {'weibo_id': 1} <class 'dict'>
19:13:36 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa123",
  "comments": []
}
19:13:46 完整请求
19:13:46 请求结束
19:13:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:46 path and query /api/weibo/update {} {"id":"3","content":"ccc123"}
19:13:46 kwargs,  {'id': 3} <class 'dict'>
19:13:46 debug 2
19:13:46 kwargs,  {'weibo_id': 3} <class 'dict'>
19:13:46 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc123",
  "comments": []
}
19:13:54 完整请求
19:13:54 请求结束
19:13:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:54 path and query /api/weibo/update {} {"id":"5","content":"fff"}
19:13:54 kwargs,  {'id': 5} <class 'dict'>
19:13:54 debug 4
19:13:54 kwargs,  {'weibo_id': 5} <class 'dict'>
19:13:54 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "fff",
  "comments": []
}
19:13:58 完整请求
19:13:58 请求结束
19:13:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:58 path and query /weibo/index {} 
19:13:58 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:13:58 完整请求
19:13:58 完整请求
19:13:58 请求结束
19:13:58 请求结束
19:13:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:58 path and query /static {'file': 'gua.js'} 
19:13:58 path and query /static {'file': 'weibo.js'} 
19:13:58 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:13:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            <div class="comment-list">
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:13:58 完整请求
19:13:58 请求结束
19:13:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:13:58 path and query /api/weibo/all {} 
19:13:58 kwargs,  {'weibo_id': 1} <class 'dict'>
19:13:58 kwargs,  {'weibo_id': 2} <class 'dict'>
19:13:58 kwargs,  {'weibo_id': 3} <class 'dict'>
19:13:58 kwargs,  {'weibo_id': 4} <class 'dict'>
19:13:58 kwargs,  {'weibo_id': 5} <class 'dict'>
19:13:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc123",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "fff",
    "comments": []
  }
]
19:14:11 完整请求
19:14:11 请求结束
19:14:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:14:11 path and query /api/weibo/update {} {"id":"1","content":"aaa"}
19:14:11 kwargs,  {'id': 1} <class 'dict'>
19:14:11 debug 0
19:14:11 kwargs,  {'weibo_id': 1} <class 'dict'>
19:14:11 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
19:14:16 完整请求
19:14:16 请求结束
19:14:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:14:16 path and query /api/weibo/update {} {"id":"3","content":"ccc"}
19:14:16 kwargs,  {'id': 3} <class 'dict'>
19:14:17 debug 2
19:14:17 kwargs,  {'weibo_id': 3} <class 'dict'>
19:14:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
19:35:08 完整请求
19:35:08 请求结束
19:35:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:35:08 path and query /api/weibo/delete {'id': '5'} 
19:35:08 kwargs,  {'weibo_id': 5} <class 'dict'>
19:35:08 kwargs,  {'weibo_id': 5} <class 'dict'>
19:35:08 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "fff",
  "comments": []
}
19:35:26 完整请求
19:35:26 请求结束
19:35:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:35:26 path and query /api/weibo/add {} {"content":"weibotest"}
19:35:26 kwargs,  {'weibo_id': 5} <class 'dict'>
19:35:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "weibotest",
  "comments": []
}
19:35:33 完整请求
19:35:33 请求结束
19:35:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:35:33 path and query /api/weibo/update {} {"id":"5","content":"weibotest2"}
19:35:33 kwargs,  {'id': 5} <class 'dict'>
19:35:33 debug 4
19:35:33 kwargs,  {'weibo_id': 5} <class 'dict'>
19:35:33 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "weibotest2",
  "comments": []
}
19:47:16 完整请求
19:47:16 请求结束
19:47:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:16 path and query /weibo/index {} 
19:47:16 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:47:16 完整请求
19:47:16 完整请求
19:47:16 请求结束
19:47:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:16 path and query /static {'file': 'gua.js'} 
19:47:16 path and query /static {'file': 'weibo.js'} 
19:47:16 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:47:16 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${cell.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:47:16 完整请求
19:47:16 请求结束
19:47:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:16 path and query /api/weibo/all {} 
19:47:16 kwargs,  {'weibo_id': 1} <class 'dict'>
19:47:17 kwargs,  {'weibo_id': 2} <class 'dict'>
19:47:17 kwargs,  {'weibo_id': 3} <class 'dict'>
19:47:17 kwargs,  {'weibo_id': 4} <class 'dict'>
19:47:17 kwargs,  {'weibo_id': 5} <class 'dict'>
19:47:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:47:26 完整请求
19:47:26 请求结束
19:47:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:26 path and query /weibo/index {} 
19:47:26 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:47:26 完整请求
19:47:26 完整请求
19:47:26 请求结束
19:47:26 请求结束
19:47:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:26 path and query /static {'file': 'weibo.js'} 
19:47:26 path and query /static {'file': 'gua.js'} 
19:47:26 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${cell.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:47:26 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:47:26 完整请求
19:47:26 请求结束
19:47:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:47:26 path and query /api/weibo/all {} 
19:47:26 kwargs,  {'weibo_id': 1} <class 'dict'>
19:47:26 kwargs,  {'weibo_id': 2} <class 'dict'>
19:47:26 kwargs,  {'weibo_id': 3} <class 'dict'>
19:47:26 kwargs,  {'weibo_id': 4} <class 'dict'>
19:47:26 kwargs,  {'weibo_id': 5} <class 'dict'>
19:47:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:48:09 完整请求
19:48:09 请求结束
19:48:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:48:09 path and query /weibo/index {} 
19:48:09 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:48:09 完整请求
19:48:09 完整请求
19:48:09 请求结束
19:48:09 请求结束
19:48:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:48:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:48:09 path and query /static {'file': 'gua.js'} 
19:48:09 path and query /static {'file': 'weibo.js'} 
19:48:09 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
on-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
            insertEditForm(WeiboCell)
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:48:09 完整请求
19:48:09 请求结束
19:48:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:48:10 path and query /api/weibo/all {} 
19:48:10 kwargs,  {'weibo_id': 1} <class 'dict'>
19:48:10 kwargs,  {'weibo_id': 2} <class 'dict'>
19:48:10 kwargs,  {'weibo_id': 3} <class 'dict'>
19:48:10 kwargs,  {'weibo_id': 4} <class 'dict'>
19:48:10 kwargs,  {'weibo_id': 5} <class 'dict'>
19:48:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:48:20 完整请求
19:48:20 请求结束
19:48:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:48:20 path and query /api/weibo/update {} {"id":"1","content":"undefined"}
19:48:20 kwargs,  {'id': 1} <class 'dict'>
19:48:20 debug 0
19:48:20 kwargs,  {'weibo_id': 1} <class 'dict'>
19:48:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "undefined",
  "comments": []
}
19:49:15 完整请求
19:49:15 请求结束
19:49:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:15 path and query /weibo/index {} 
19:49:15 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:49:15 完整请求
19:49:15 完整请求
19:49:15 请求结束
19:49:15 请求结束
19:49:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:15 path and query /static {'file': 'weibo.js'} 
19:49:15 path and query /static {'file': 'gua.js'} 
19:49:15 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${cell.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:49:15 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:49:15 完整请求
19:49:15 请求结束
19:49:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:15 path and query /api/weibo/all {} 
19:49:15 kwargs,  {'weibo_id': 1} <class 'dict'>
19:49:15 kwargs,  {'weibo_id': 2} <class 'dict'>
19:49:15 kwargs,  {'weibo_id': 3} <class 'dict'>
19:49:15 kwargs,  {'weibo_id': 4} <class 'dict'>
19:49:15 kwargs,  {'weibo_id': 5} <class 'dict'>
19:49:15 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "undefined",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:49:58 完整请求
19:49:58 请求结束
19:49:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:58 path and query /weibo/index {} 
19:49:58 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:49:58 完整请求
19:49:58 完整请求
19:49:58 请求结束
19:49:58 请求结束
19:49:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:58 path and query /static {'file': 'gua.js'} 
19:49:58 path and query /static {'file': 'weibo.js'} 
19:49:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${cell.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:49:58 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:49:58 完整请求
19:49:58 请求结束
19:49:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:49:58 path and query /api/weibo/all {} 
19:49:58 kwargs,  {'weibo_id': 1} <class 'dict'>
19:49:58 kwargs,  {'weibo_id': 2} <class 'dict'>
19:49:59 kwargs,  {'weibo_id': 3} <class 'dict'>
19:49:59 kwargs,  {'weibo_id': 4} <class 'dict'>
19:49:59 kwargs,  {'weibo_id': 5} <class 'dict'>
19:49:59 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "undefined",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:50:01 完整请求
19:50:01 请求结束
19:50:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:50:01 path and query /weibo/index {} 
19:50:01 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:50:01 完整请求
19:50:01 完整请求
19:50:01 请求结束
19:50:01 请求结束
19:50:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:50:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:50:01 path and query /static {'file': 'weibo.js'} 
19:50:01 path and query /static {'file': 'gua.js'} 
19:50:01 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: ${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${cell.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:50:01 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:50:01 完整请求
19:50:01 请求结束
19:50:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:50:01 path and query /api/weibo/all {} 
19:50:01 kwargs,  {'weibo_id': 1} <class 'dict'>
19:50:01 kwargs,  {'weibo_id': 2} <class 'dict'>
19:50:01 kwargs,  {'weibo_id': 3} <class 'dict'>
19:50:01 kwargs,  {'weibo_id': 4} <class 'dict'>
19:50:01 kwargs,  {'weibo_id': 5} <class 'dict'>
19:50:01 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "undefined",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:58:04 完整请求
19:58:04 请求结束
19:58:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:04 path and query /weibo/index {} 
19:58:04 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:58:04 完整请求
19:58:04 完整请求
19:58:04 请求结束
19:58:04 请求结束
19:58:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:04 path and query /static {'file': 'gua.js'} 

19:58:04 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:58:04 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:58:04 完整请求
19:58:04 请求结束
19:58:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:04 path and query /api/weibo/all {} 
19:58:04 kwargs,  {'weibo_id': 1} <class 'dict'>
19:58:04 kwargs,  {'weibo_id': 2} <class 'dict'>
19:58:04 kwargs,  {'weibo_id': 3} <class 'dict'>
19:58:04 kwargs,  {'weibo_id': 4} <class 'dict'>
19:58:04 kwargs,  {'weibo_id': 5} <class 'dict'>
19:58:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "undefined",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:58:13 完整请求
19:58:13 请求结束
19:58:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:13 path and query /api/weibo/update {} {"id":"1","content":"123"}
19:58:13 kwargs,  {'id': 1} <class 'dict'>
19:58:13 debug 0
19:58:13 kwargs,  {'weibo_id': 1} <class 'dict'>
19:58:13 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "123",
  "comments": []
}
19:58:23 完整请求
19:58:24 请求结束
19:58:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:24 path and query /api/weibo/update {} {"id":"2","content":"123"}
19:58:24 kwargs,  {'id': 2} <class 'dict'>
19:58:24 debug 1
19:58:24 kwargs,  {'weibo_id': 2} <class 'dict'>
19:58:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "123",
  "comments": []
}
19:58:34 完整请求
19:58:34 请求结束
19:58:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:34 path and query /weibo/index {} 
19:58:34 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:58:34 完整请求
19:58:34 完整请求
19:58:34 请求结束
19:58:34 请求结束
19:58:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:34 path and query /static {'file': 'weibo.js'} 
19:58:34 path and query /static {'file': 'gua.js'} 
19:58:34 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
    }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:58:34 完整请求
19:58:34 请求结束
19:58:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:34 path and query /api/weibo/all {} 
19:58:34 kwargs,  {'weibo_id': 1} <class 'dict'>
19:58:34 kwargs,  {'weibo_id': 2} <class 'dict'>
19:58:34 kwargs,  {'weibo_id': 3} <class 'dict'>
19:58:34 kwargs,  {'weibo_id': 4} <class 'dict'>
19:58:34 kwargs,  {'weibo_id': 5} <class 'dict'>
19:58:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "123",
    "comments": []
  },
  {
    "id": 2,
    "content": "123",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:58:42 完整请求
19:58:42 请求结束
19:58:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:42 path and query /api/weibo/update {} {"id":"1","content":"456"}
19:58:42 kwargs,  {'id': 1} <class 'dict'>
19:58:42 debug 0
19:58:42 kwargs,  {'weibo_id': 1} <class 'dict'>
19:58:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "456",
  "comments": []
}
19:58:51 完整请求
19:58:51 请求结束
19:58:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:51 path and query /weibo/index {} 
19:58:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:58:51 完整请求
19:58:51 完整请求
19:58:51 请求结束
19:58:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:51 path and query /static {'file': 'gua.js'} 
19:58:51 path and query /static {'file': 'weibo.js'} 
19:58:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:58:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:58:51 完整请求
19:58:51 请求结束
19:58:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:58:51 path and query /api/weibo/all {} 
19:58:51 kwargs,  {'weibo_id': 1} <class 'dict'>
19:58:51 kwargs,  {'weibo_id': 2} <class 'dict'>
19:58:51 kwargs,  {'weibo_id': 3} <class 'dict'>
19:58:51 kwargs,  {'weibo_id': 4} <class 'dict'>
19:58:51 kwargs,  {'weibo_id': 5} <class 'dict'>
19:58:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "456",
    "comments": []
  },
  {
    "id": 2,
    "content": "123",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd123",
    "comments": []
  },
  {
    "id": 5,
    "content": "weibotest2",
    "comments": []
  }
]
19:59:19 完整请求
19:59:19 请求结束
19:59:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:19 path and query /api/weibo/update {} {"id":"1","content":"456123"}
19:59:19 kwargs,  {'id': 1} <class 'dict'>
19:59:19 debug 0
19:59:19 kwargs,  {'weibo_id': 1} <class 'dict'>
19:59:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "456123",
  "comments": []
}
19:59:25 完整请求
19:59:25 请求结束
19:59:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:25 path and query /api/weibo/delete {'id': '5'} 
19:59:25 kwargs,  {'weibo_id': 5} <class 'dict'>
19:59:25 kwargs,  {'weibo_id': 5} <class 'dict'>
19:59:25 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "weibotest2",
  "comments": []
}
19:59:25 完整请求
19:59:25 请求结束
19:59:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:26 path and query /api/weibo/delete {'id': '5'} 
19:59:26 完整请求
19:59:26 完整请求
19:59:26 请求结束
19:59:26 请求结束
19:59:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:26 path and query /api/weibo/delete {'id': '5'} 
19:59:26 path and query /api/weibo/delete {'id': '4'} 
19:59:26 kwargs,  {'weibo_id': 4} <class 'dict'>
19:59:26 kwargs,  {'weibo_id': 4} <class 'dict'>
19:59:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "ddd123",
  "comments": []
}
19:59:27 完整请求
19:59:27 完整请求
19:59:27 请求结束
19:59:27 请求结束
19:59:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:27 path and query /api/weibo/delete {'id': '5'} 
19:59:27 path and query /api/weibo/delete {'id': '3'} 
19:59:27 kwargs,  {'weibo_id': 3} <class 'dict'>
19:59:27 kwargs,  {'weibo_id': 3} <class 'dict'>
19:59:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
19:59:28 完整请求
19:59:28 完整请求
19:59:28 请求结束
19:59:28 请求结束
19:59:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:28 path and query /api/weibo/delete {'id': '2'} 
19:59:28 path and query /api/weibo/delete {'id': '5'} 
19:59:28 kwargs,  {'weibo_id': 2} <class 'dict'>
19:59:28 kwargs,  {'weibo_id': 2} <class 'dict'>
19:59:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "123",
  "comments": []
}
19:59:31 完整请求
19:59:31 请求结束
19:59:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:31 path and query /weibo/index {} 
19:59:31 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:59:31 完整请求
19:59:31 完整请求
19:59:31 请求结束
19:59:31 请求结束
19:59:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:31 path and query /static {'file': 'weibo.js'} 
19:59:31 path and query /static {'file': 'gua.js'} 
19:59:31 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
    }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:59:31 完整请求
19:59:31 请求结束
19:59:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:31 path and query /api/weibo/all {} 
19:59:31 kwargs,  {'weibo_id': 1} <class 'dict'>
19:59:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "456123",
    "comments": []
  }
]
19:59:37 完整请求
19:59:37 请求结束
19:59:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:37 path and query /api/weibo/update {} {"id":"1","content":"aaa"}
19:59:37 kwargs,  {'id': 1} <class 'dict'>
19:59:37 debug 0
19:59:37 kwargs,  {'weibo_id': 1} <class 'dict'>
19:59:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
19:59:51 完整请求
19:59:51 请求结束
19:59:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:51 path and query /weibo/index {} 
19:59:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
19:59:51 完整请求
19:59:51 完整请求
19:59:51 请求结束
19:59:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:51 path and query /static {'file': 'gua.js'} 

19:59:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

19:59:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
19:59:51 完整请求
19:59:51 请求结束
19:59:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
19:59:51 path and query /api/weibo/all {} 
19:59:51 kwargs,  {'weibo_id': 1} <class 'dict'>
19:59:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:00:00 完整请求
20:00:00 请求结束
20:00:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:00:00 path and query /api/weibo/update {} {"id":"1","content":"aaa123"}
20:00:00 kwargs,  {'id': 1} <class 'dict'>
20:00:00 debug 0
20:00:00 kwargs,  {'weibo_id': 1} <class 'dict'>
20:00:00 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa123",
  "comments": []
}
20:00:04 完整请求
20:00:04 请求结束
20:00:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:00:04 path and query /static {'file': 'weibo.js'} 
20:00:04 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:01:30 完整请求
20:01:30 请求结束
20:01:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:01:30 path and query /weibo/index {} 
20:01:30 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:01:30 完整请求
20:01:30 完整请求
20:01:30 请求结束
20:01:30 请求结束
20:01:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:01:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:01:30 path and query /static {'file': 'gua.js'} 
20:01:30 path and query /static {'file': 'weibo.js'} 
20:01:30 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:01:30 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:01:31 完整请求
20:01:31 请求结束
20:01:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:01:31 path and query /api/weibo/all {} 
20:01:31 kwargs,  {'weibo_id': 1} <class 'dict'>
20:01:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "comments": []
  }
]
20:01:31 完整请求
20:01:31 请求结束
20:01:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:01:31 path and query /static {'file': 'weibo.js'} 
20:01:31 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:01:48 完整请求
20:01:48 请求结束
20:01:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:01:48 path and query /api/weibo/update {} {"id":"1","content":"aaa"}
20:01:49 kwargs,  {'id': 1} <class 'dict'>
20:01:49 debug 0
20:01:49 kwargs,  {'weibo_id': 1} <class 'dict'>
20:01:49 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
20:02:28 完整请求
20:02:28 请求结束
20:02:45 完整请求
20:02:45 请求结束
20:02:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:02:45 path and query /api/weibo/add {} {"content":""}
20:02:45 kwargs,  {'weibo_id': 2} <class 'dict'>
20:02:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "",
  "comments": []
}
20:02:50 完整请求
20:02:50 请求结束
20:02:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:02:50 path and query /api/weibo/delete {'id': '2'} 
20:02:50 kwargs,  {'weibo_id': 2} <class 'dict'>
20:02:50 kwargs,  {'weibo_id': 2} <class 'dict'>
20:02:50 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "",
  "comments": []
}
20:02:53 完整请求
20:02:54 请求结束
20:02:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:02:54 path and query /static {'file': 'weibo.js'} 
20:02:54 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id}>
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = (cell.querySelector('#content')).innerHTML
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:05:00 完整请求
20:05:00 请求结束
20:13:16 完整请求
20:13:16 请求结束
20:13:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:16 path and query /weibo/index {} 
20:13:16 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:13:16 完整请求
20:13:16 完整请求
20:13:16 请求结束
20:13:16 请求结束
20:13:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:16 path and query /static {'file': 'gua.js'} 
20:13:16 path and query /static {'file': 'weibo.js'} 
20:13:16 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:13:16 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:13:16 完整请求
20:13:16 请求结束
20:13:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:16 path and query /api/weibo/all {} 
20:13:16 kwargs,  {'weibo_id': 1} <class 'dict'>
20:13:16 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:13:16 完整请求
20:13:16 请求结束
20:13:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:16 path and query /static {'file': 'weibo.js'} 
20:13:16 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:13:27 完整请求
20:13:27 请求结束
20:13:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:27 path and query /weibo/index {} 
20:13:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:13:27 完整请求
20:13:27 完整请求
20:13:27 请求结束
20:13:27 请求结束
20:13:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:28 path and query /static {'file': 'gua.js'} 
20:13:28 path and query /static {'file': 'weibo.js'} 
20:13:28 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:13:28 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:13:28 完整请求
20:13:28 请求结束
20:13:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:28 path and query /api/weibo/all {} 
20:13:28 kwargs,  {'weibo_id': 1} <class 'dict'>
20:13:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:13:34 完整请求
20:13:34 请求结束
20:13:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:34 path and query /weibo/index {} 
20:13:34 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:13:34 完整请求
20:13:34 完整请求
20:13:35 请求结束
20:13:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:35 请求结束
 /static {'file': 'gua.js'} 
20:13:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:35 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:13:35 path and query /static {'file': 'weibo.js'} 
20:13:35 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]: <div id="content">${content}</div>
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:13:35 完整请求
20:13:35 请求结束
20:13:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:35 path and query /api/weibo/all {} 
20:13:35 kwargs,  {'weibo_id': 1} <class 'dict'>
20:13:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:13:57 完整请求
20:13:57 请求结束
20:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:57 path and query /weibo/index {} 
20:13:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:13:57 完整请求
20:13:57 完整请求
20:13:57 请求结束
20:13:57 请求结束
20:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:57 path and query /static {'file': 'weibo.js'} 
20:13:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
     }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:13:57 完整请求
20:13:57 请求结束
20:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:13:57 path and query /api/weibo/all {} 
20:13:57 kwargs,  {'weibo_id': 1} <class 'dict'>
20:13:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:14:28 完整请求
20:14:28 请求结束
20:14:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:14:28 path and query /static {'file': 'weibo.js'} 
20:14:28 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:14:37 完整请求
20:14:37 请求结束
20:14:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:14:37 path and query /weibo/index {} 
20:14:37 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:14:37 完整请求
20:14:37 完整请求
20:14:38 请求结束
20:14:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:14:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:14:38 path and query /static {'file': 'gua.js'} 

20:14:38 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:14:38 完整请求
20:14:38 请求结束
20:14:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:14:38 path and query /api/weibo/all {} 
20:14:38 kwargs,  {'weibo_id': 1} <class 'dict'>
20:14:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:14:38 完整请求
20:14:38 请求结束
20:14:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:14:38 path and query /static {'file': 'weibo.js'} 
20:14:38 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-Weibo="${Weibo}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var Weibo = cell.dataset.Weibo //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${Weibo.content}">
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:18:57 完整请求
20:18:57 请求结束
20:18:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:18:57 path and query /weibo/index {} 
20:18:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:18:57 完整请求
20:18:57 完整请求
20:18:57 请求结束
20:18:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:18:57 path and query /static {'file': 'weibo.js'} 
20:18:57 path and query /static {'file': 'gua.js'} 
20:18:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:18:57 完整请求
20:18:58 请求结束
20:18:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:18:58 path and query /api/weibo/all {} 
20:18:58 kwargs,  {'weibo_id': 1} <class 'dict'>
20:18:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  }
]
20:18:58 完整请求
20:18:58 请求结束
20:18:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:18:58 path and query /static {'file': 'weibo.js'} 
20:18:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:19:06 完整请求
20:19:06 请求结束
20:19:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:06 path and query /api/weibo/update {} {"id":"1","content":"bbb"}
20:19:06 kwargs,  {'id': 1} <class 'dict'>
20:19:06 debug 0
20:19:06 kwargs,  {'weibo_id': 1} <class 'dict'>
20:19:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "bbb",
  "comments": []
}
20:19:11 完整请求
20:19:11 请求结束
20:19:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:11 path and query /api/weibo/update {} {"id":"1","content":"ccc"}
20:19:11 kwargs,  {'id': 1} <class 'dict'>
20:19:11 debug 0
20:19:11 kwargs,  {'weibo_id': 1} <class 'dict'>
20:19:11 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "ccc",
  "comments": []
}
20:19:17 完整请求
20:19:17 请求结束
20:19:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:17 path and query /weibo/index {} 
20:19:17 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:19:17 完整请求
20:19:17 完整请求
20:19:17 请求结束
20:19:17 请求结束
20:19:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:17 path and query /static {'file': 'weibo.js'} 
20:19:17 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:19:17 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:19:17 完整请求
20:19:17 请求结束
20:19:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:17 path and query /api/weibo/all {} 
20:19:17 完整请求
20:19:17 请求结束
20:19:17 kwargs,  {'weibo_id': 1} <class 'dict'>
20:19:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ccc",
    "comments": []
  }
]
20:19:17 path and query /static {'file': 'weibo.js'} 
20:19:17 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:19:25 完整请求
20:19:25 请求结束
20:19:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:25 path and query /weibo/index {} 
20:19:25 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:19:25 完整请求
20:19:25 请求结束
20:19:25 请求结束
20:19:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:25 path and query /static {'file': 'gua.js'} 
20:19:25 path and query /static {'file': 'weibo.js'} 
20:19:25 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:19:25 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:19:25 完整请求
20:19:25 请求结束
20:19:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:25 完整请求
20:19:25 path and query /api/weibo/all {} 
20:19:25 请求结束
bo_id': 1} <class 'dict'>
20:19:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ccc",
    "comments": []
  }
]
20:19:26 path and query /static {'file': 'weibo.js'} 
20:19:26 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到Weibo这个dict
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            //WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:19:30 完整请求
20:19:30 请求结束
20:19:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:19:31 path and query /api/weibo/update {} {"id":"1","content":"ddd"}
20:19:31 kwargs,  {'id': 1} <class 'dict'>
20:19:31 debug 0
20:19:31 kwargs,  {'weibo_id': 1} <class 'dict'>
20:19:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "ddd",
  "comments": []
}
20:21:06 完整请求
20:21:06 请求结束
20:21:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:21:06 path and query /weibo/index {} 
20:21:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:21:07 完整请求
20:21:07 完整请求
20:21:07 请求结束
20:21:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:21:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:21:07 path and query /static {'file': 'weibo.js'} 
20:21:07 path and query /static {'file': 'gua.js'} 
20:21:07 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
            insertEditForm(WeiboCell)

        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:21:07 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:21:07 完整请求
20:21:07 请求结束
20:21:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:21:07 path and query /api/weibo/all {} 
20:21:07 kwargs,  {'weibo_id': 1} <class 'dict'>
20:21:07 完整请求
20:21:07 请求结束
20:21:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ddd",
    "comments": []
  }
]
20:21:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:21:07 path and query /static {'file': 'weibo.js'} 
20:21:07 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
            insertEditForm(WeiboCell)

        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:22:59 完整请求
20:22:59 请求结束
20:22:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:22:59 path and query /weibo/index {} 
20:22:59 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:22:59 完整请求
20:22:59 完整请求
20:22:59 请求结束
20:22:59 请求结束
20:22:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:22:59 path and query /static {'file': 'gua.js'} 

20:22:59 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示

        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:22:59 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:22:59 完整请求
20:22:59 请求结束
20:22:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:22:59 path and query /api/weibo/all {} 
20:22:59 kwargs,  {'weibo_id': 1} <class 'dict'>
20:22:59 完整请求
20:22:59 请求结束
20:22:59 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ddd",
    "comments": []
  }
]
20:22:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:22:59 path and query /static {'file': 'weibo.js'} 
20:22:59 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示

        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:25:26 完整请求
20:25:26 请求结束
20:25:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:25:26 path and query /weibo/index {} 
20:25:26 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:25:27 完整请求
20:25:27 完整请求
20:25:27 请求结束
20:25:27 请求结束
20:25:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:25:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:25:27 path and query /static {'file': 'weibo.js'} 
20:25:27 path and query /static {'file': 'gua.js'} 
20:25:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:25:27 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:25:27 完整请求
20:25:27 请求结束
20:25:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:25:27 path and query /api/weibo/all {} 
20:25:27 kwargs,  {'weibo_id': 1} <class 'dict'>
20:25:27 完整请求
20:25:27 请求结束
20:25:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ddd",
    "comments": []
  }
]
20:25:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:25:27 path and query /static {'file': 'weibo.js'} 
20:25:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:26:04 完整请求
20:26:04 请求结束
20:26:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:26:04 path and query /weibo/index {} 
20:26:04 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:26:04 完整请求
20:26:04 完整请求
20:26:04 请求结束
20:26:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:26:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:26:04 path and query /static {'file': 'gua.js'} 

20:26:04 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:26:04 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:26:04 完整请求
20:26:04 请求结束
20:26:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:26:04 path and query /api/weibo/all {} 
20:26:04 完整请求
20:26:04 请求结束
20:26:04 kwargs,  {'weibo_id': 1} <class 'dict'>
20:26:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:26:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ddd",
    "comments": []
  }
]
20:26:04 path and query /static {'file': 'weibo.js'} 
20:26:04 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            WeiboCell.style.display= "none" //让当前这个WeiboCell不显示
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:27:48 完整请求
20:27:48 请求结束
20:27:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:48 path and query /weibo/index {} 
20:27:48 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:27:48 完整请求
20:27:48 完整请求
20:27:48 请求结束
20:27:48 请求结束
20:27:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:48 path and query /static {'file': 'gua.js'} 
20:27:48 path and query /static {'file': 'weibo.js'} 
20:27:48 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:27:48 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:27:48 完整请求
20:27:48 请求结束
20:27:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:48 path and query /api/weibo/all {} 
20:27:48 完整请求
20:27:48 请求结束
20:27:48 kwargs,  {'weibo_id': 1} <class 'dict'>
20:27:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:48 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "ddd",
    "comments": []
  }
]
20:27:48 path and query /static {'file': 'weibo.js'} 
20:27:48 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:27:51 完整请求
20:27:51 请求结束
20:27:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:51 path and query /api/weibo/delete {'id': '1'} 
20:27:51 kwargs,  {'weibo_id': 1} <class 'dict'>
20:27:51 kwargs,  {'weibo_id': 1} <class 'dict'>
20:27:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "ddd",
  "comments": []
}
20:27:54 完整请求
20:27:54 请求结束
20:27:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:54 path and query /api/weibo/add {} {"content":"aaa"}
20:27:54 kwargs,  {'weibo_id': 1} <class 'dict'>
20:27:54 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
20:27:58 完整请求
20:27:58 请求结束
20:27:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:27:58 path and query /api/weibo/add {} {"content":"bbb"}
20:27:58 kwargs,  {'weibo_id': 2} <class 'dict'>
20:27:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "bbb",
  "comments": []
}
20:28:01 完整请求
20:28:01 请求结束
20:28:01 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:28:01 path and query /api/weibo/add {} {"content":"ccc"}
20:28:01 kwargs,  {'weibo_id': 3} <class 'dict'>
20:28:01 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
20:30:08 完整请求
20:30:08 请求结束
20:30:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:08 path and query /weibo/index {} 
20:30:08 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: crimson;
        }
        .comment {
            border: 1px red solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:30:08 完整请求
20:30:08 请求结束
20:30:08 请求结束
20:30:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:08 path and query /static {'file': 'gua.js'} 
20:30:08 path and query /static {'file': 'weibo.js'} 
20:30:08 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
 }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:30:08 完整请求
20:30:08 请求结束
20:30:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:09 path and query /api/weibo/all {} 
20:30:09 完整请求
20:30:09 请求结束
20:30:09 kwargs,  {'weibo_id': 1} <class 'dict'>
20:30:09 kwargs,  {'weibo_id': 2} <class 'dict'>
20:30:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:09 path and query /static {'file': 'weibo.js'} 
20:30:09 kwargs,  {'weibo_id': 3} <class 'dict'>
20:30:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]

        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:30:35 完整请求
20:30:35 请求结束
20:30:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:36 path and query /weibo/index {} 
20:30:36 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:30:36 完整请求
20:30:36 完整请求
20:30:36 请求结束
20:30:36 请求结束
20:30:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:36 path and query /static {'file': 'weibo.js'} 
20:30:36 path and query /static {'file': 'gua.js'} 
20:30:36 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:30:36 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:30:36 完整请求
20:30:36 请求结束
20:30:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:36 完整请求
20:30:36 请求结束
20:30:36 path and query /api/weibo/all {} 
20:30:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:30:36 kwargs,  {'weibo_id': 1} <class 'dict'>
20:30:36 path and query /static {'file': 'weibo.js'} 
20:30:36 kwargs,  {'weibo_id': 2} <class 'dict'>
20:30:36 kwargs,  {'weibo_id': 3} <class 'dict'>
20:30:36 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:30:36 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
20:34:50 完整请求
20:34:50 请求结束
20:34:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:34:50 path and query /weibo/index {} 
20:34:50 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:34:50 完整请求
20:34:50 完整请求
20:34:50 请求结束
20:34:50 请求结束
20:34:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:34:50 path and query /static {'file': 'weibo.js'} 
20:34:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:34:50 path and query /static {'file': 'gua.js'} 
20:34:50 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:34:50 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:34:50 完整请求
20:34:50 请求结束
20:34:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:34:50 path and query /api/weibo/all {} 
20:34:51 kwargs,  {'weibo_id': 1} <class 'dict'>
20:34:51 完整请求
20:34:51 请求结束
20:34:51 kwargs,  {'weibo_id': 2} <class 'dict'>
20:34:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:34:51 kwargs,  {'weibo_id': 3} <class 'dict'>
20:34:51 path and query /static {'file': 'weibo.js'} 
20:34:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
20:34:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:35:16 完整请求
20:35:16 请求结束
20:35:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:16 path and query /weibo/index {} 
20:35:16 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:35:16 完整请求
20:35:16 完整请求
20:35:16 请求结束
20:35:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:16 path and query /static {'file': 'weibo.js'} 
20:35:16 path and query /static {'file': 'gua.js'} 
20:35:16 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:35:16 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:35:16 完整请求
20:35:16 请求结束
20:35:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:16 完整请求
20:35:16 请求结束
20:35:16 path and query /api/weibo/all {} 
20:35:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:16 kwargs,  {'weibo_id': 1} <class 'dict'>
20:35:16 path and query /static {'file': 'weibo.js'} 
20:35:16 kwargs,  {'weibo_id': 2} <class 'dict'>
20:35:16 kwargs,  {'weibo_id': 3} <class 'dict'>
20:35:16 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:35:16 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
20:35:44 完整请求
20:35:44 请求结束
20:35:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:44 path and query /weibo/index {} 
20:35:44 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" name="weibo_id" value="">-->
            <!--<input name="content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
20:35:44 完整请求
20:35:44 完整请求
20:35:44 请求结束
20:35:44 请求结束
20:35:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:44 path and query /static {'file': 'weibo.js'} 
20:35:44 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

20:35:44 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/*  Weibo的API */



// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}
20:35:45 完整请求
20:35:45 请求结束
20:35:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:45 path and query /api/weibo/all {} 
20:35:45 完整请求
20:35:45 请求结束
20:35:45 kwargs,  {'weibo_id': 1} <class 'dict'>
20:35:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
20:35:45 kwargs,  {'weibo_id': 2} <class 'dict'>
20:35:45 path and query /static {'file': 'weibo.js'} 
20:35:45 kwargs,  {'weibo_id': 3} <class 'dict'>
20:35:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
20:35:45 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" name="weibo_id" value="">
                <input name="content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}

var bindEvents = function() {
   bindEventWeiboAdd()
   bindEventWeiboDelete()
   bindEventWeiboEdit()
   bindEventWeiboUpdate()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:11:56 完整请求
21:11:56 请求结束
21:11:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:11:56 path and query /weibo/index {} 
21:11:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:11:57 完整请求
21:11:57 完整请求
21:11:57 请求结束
21:11:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:11:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:11:57 path and query /static {'file': 'gua.js'} 

21:11:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:11:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:11:57 完整请求
21:11:57 请求结束
21:11:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:11:57 path and query /static {'file': 'weibo.js'} 
21:11:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:11:58 完整请求
21:11:58 请求结束
21:11:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:11:58 path and query /static {'file': 'weibo.js'} 
21:11:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:13:49 完整请求
21:13:49 请求结束
21:13:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:49 path and query /weibo/index {} 
21:13:49 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:13:49 完整请求
21:13:49 完整请求
21:13:49 请求结束
21:13:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:50 path and query /static {'file': 'gua.js'} 

21:13:50 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:13:50 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:13:50 完整请求
21:13:50 请求结束
21:13:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:50 path and query /static {'file': 'weibo.js'} 
21:13:50 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:13:51 完整请求
21:13:51 请求结束
21:13:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:51 path and query /static {'file': 'weibo.js'} 
21:13:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:13:57 完整请求
21:13:57 请求结束
21:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:57 path and query /weibo/index {} 
21:13:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:13:57 完整请求
21:13:57 完整请求
21:13:57 请求结束
21:13:57 请求结束
21:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:57 path and query /static {'file': 'weibo.js'} 
21:13:57 path and query /static {'file': 'gua.js'} 
21:13:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:13:58 完整请求
21:13:58 请求结束
21:13:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:58 path and query /static {'file': 'weibo.js'} 
21:13:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:13:58 完整请求
21:13:58 请求结束
21:13:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:13:59 path and query /static {'file': 'weibo.js'} 
21:13:59 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:14:24 完整请求
21:14:24 请求结束
21:14:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:14:24 path and query /weibo/index {} 
21:14:24 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:14:25 完整请求
21:14:25 完整请求
21:14:25 请求结束
21:14:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:14:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:14:25 path and query /static {'file': 'weibo.js'} 
21:14:25 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:14:25 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:14:25 完整请求
21:14:25 请求结束
21:14:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:14:25 path and query /static {'file': 'weibo.js'} 
21:14:25 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:14:26 完整请求
21:14:26 请求结束
21:14:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:14:26 path and query /static {'file': 'weibo.js'} 
21:14:26 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:16:06 完整请求
21:16:06 请求结束
21:16:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:06 path and query /weibo/index {} 
21:16:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:16:07 完整请求
21:16:07 完整请求
21:16:07 请求结束
21:16:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:07 path and query /static {'file': 'weibo.js'} 
21:16:07 path and query /static {'file': 'gua.js'} 
21:16:07 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:16:07 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:16:07 完整请求
21:16:07 请求结束
21:16:07 完整请求
21:16:07 请求结束
21:16:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:07 path and query /api/weibo/all {} 
21:16:07 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:16:07 kwargs,  {'weibo_id': 1} <class 'dict'>
21:16:07 kwargs,  {'weibo_id': 2} <class 'dict'>
21:16:07 kwargs,  {'weibo_id': 3} <class 'dict'>
21:16:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
21:16:39 完整请求
21:16:39 请求结束
21:16:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:39 path and query /weibo/index {} 
21:16:39 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:16:39 完整请求
21:16:39 完整请求
21:16:39 请求结束
21:16:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:39 path and query /static {'file': 'gua.js'} 
21:16:39 path and query /static {'file': 'weibo.js'} 
21:16:39 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:16:39 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:16:39 完整请求
21:16:39 请求结束
21:16:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:39 path and query /api/weibo/all {} 
21:16:39 完整请求
21:16:39 请求结束
21:16:39 kwargs,  {'weibo_id': 1} <class 'dict'>
21:16:39 kwargs,  {'weibo_id': 2} <class 'dict'>
21:16:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:39 path and query /static {'file': 'weibo.js'} 
21:16:39 kwargs,  {'weibo_id': 3} <class 'dict'>
21:16:39 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  }
]
21:16:39 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:16:53 完整请求
21:16:53 请求结束
21:16:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:16:53 path and query /api/weibo/add {} {"content":"ddd"}
21:16:53 kwargs,  {'weibo_id': 4} <class 'dict'>
21:16:53 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "ddd",
  "comments": []
}
21:18:08 完整请求
21:18:08 请求结束
21:18:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:18:08 path and query /weibo/index {} 
21:18:08 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:18:08 完整请求
21:18:08 完整请求
21:18:08 请求结束
21:18:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:18:09 path and query /static {'file': 'gua.js'} 

21:18:09 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:18:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:18:09 完整请求
21:18:09 请求结束
21:18:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:18:09 path and query /api/weibo/all {} 
21:18:09 完整请求
21:18:09 请求结束
21:18:09 kwargs,  {'weibo_id': 1} <class 'dict'>
21:18:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:18:09 kwargs,  {'weibo_id': 2} <class 'dict'>
21:18:09 path and query /static {'file': 'weibo.js'} 
21:18:09 kwargs,  {'weibo_id': 3} <class 'dict'>
21:18:09 kwargs,  {'weibo_id': 4} <class 'dict'>
21:18:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:18:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:19:27 完整请求
21:19:27 请求结束
21:19:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:19:27 path and query /weibo/index {} 
21:19:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:19:28 完整请求
21:19:28 完整请求
21:19:28 请求结束
21:19:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:19:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:19:28 path and query /static {'file': 'gua.js'} 
21:19:28 path and query /static {'file': 'weibo.js'} 
21:19:28 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:19:28 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:19:28 完整请求
21:19:28 请求结束
21:19:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:19:28 path and query /api/weibo/all {} 
21:19:28 kwargs,  {'weibo_id': 1} <class 'dict'>
21:19:28 kwargs,  {'weibo_id': 2} <class 'dict'>
21:19:28 kwargs,  {'weibo_id': 3} <class 'dict'>
21:19:28 完整请求
21:19:28 请求结束
21:19:28 kwargs,  {'weibo_id': 4} <class 'dict'>
21:19:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:19:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:19:28 path and query /static {'file': 'weibo.js'} 
21:19:28 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:20:36 完整请求
21:20:36 请求结束
21:20:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:20:36 path and query /weibo/index {} 
21:20:36 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:20:36 完整请求
21:20:36 完整请求
21:20:36 请求结束
21:20:36 请求结束
21:20:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:20:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:20:37 path and query /static {'file': 'gua.js'} 
21:20:37 path and query /static {'file': 'weibo.js'} 
21:20:37 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:20:37 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        log("self click")
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:20:37 完整请求
21:20:37 请求结束
21:20:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:20:37 完整请求
21:20:37 path and query /api/weibo/all {} 
21:20:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:20:37 kwargs,  {'weibo_id': 1} <class 'dict'>
21:20:37 kwargs,  {'weibo_id': 2} <class 'dict'>
21:20:37 path and query /static {'file': 'weibo.js'} 
21:20:37 kwargs,  {'weibo_id': 3} <class 'dict'>
21:20:37 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        log("self click")
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:20:37 kwargs,  {'weibo_id': 4} <class 'dict'>
21:20:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:22:14 完整请求
21:22:14 请求结束
21:22:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:14 path and query /weibo/index {} 
21:22:14 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <input type="hidden" id="comment-weibo_id" value="${id}">
            <input id="comment-content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:22:14 完整请求
21:22:14 完整请求
21:22:14 请求结束
21:22:14 请求结束
21:22:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:14 path and query /static {'file': 'gua.js'} 

21:22:14 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:22:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        log("self click")
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:22:14 完整请求
21:22:14 请求结束
21:22:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:14 path and query /api/weibo/all {} 
21:22:14 完整请求
21:22:14 请求结束
21:22:14 kwargs,  {'weibo_id': 1} <class 'dict'>
21:22:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:14 kwargs,  {'weibo_id': 2} <class 'dict'>
21:22:14 path and query /static {'file': 'weibo.js'} 
21:22:14 kwargs,  {'weibo_id': 3} <class 'dict'>
21:22:14 kwargs,  {'weibo_id': 4} <class 'dict'>
21:22:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        log("self click")
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:22:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:22:17 完整请求
21:22:17 请求结束
21:22:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:17 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:17 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:29 完整请求
21:22:29 请求结束
21:22:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:29 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:29 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:29 完整请求
21:22:29 请求结束
21:22:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:29 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:30 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:30 完整请求
21:22:30 请求结束
21:22:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:30 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:30 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:30 完整请求
21:22:30 请求结束
21:22:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:30 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:30 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:30 完整请求
21:22:30 请求结束
21:22:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:30 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:30 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:32 完整请求
21:22:33 请求结束
21:22:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:33 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:33 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:34 完整请求
21:22:34 请求结束
21:22:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:34 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:34 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:35 完整请求
21:22:35 请求结束
21:22:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:35 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:35 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:35 完整请求
21:22:35 请求结束
21:22:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:35 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:36 完整请求
21:22:36 请求结束
21:22:36 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:36 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:36 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:22:36 完整请求
21:22:36 请求结束
21:22:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:22:36 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:22:36 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:24:07 完整请求
21:24:07 请求结束
21:24:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:08 path and query /weibo/index {} 
21:24:08 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <input type="hidden" id="comment-weibo_id" value="${id}">
            <input id="comment-content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:24:08 完整请求
21:24:08 完整请求
21:24:08 请求结束
21:24:08 请求结束
21:24:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:08 path and query /static {'file': 'weibo.js'} 
21:24:08 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        log("self click")
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:24:08 完整请求
21:24:08 完整请求
21:24:08 请求结束
21:24:08 请求结束
21:24:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:08 path and query /api/weibo/all {} 
21:24:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:08 path and query /static {'file': 'weibo.js'} 
21:24:08 kwargs,  {'weibo_id': 1} <class 'dict'>
21:24:08 kwargs,  {'weibo_id': 2} <class 'dict'>
21:24:08 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        log("self click")
        if (self.classList.contains('.comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:24:08 kwargs,  {'weibo_id': 3} <class 'dict'>
21:24:08 kwargs,  {'weibo_id': 4} <class 'dict'>
21:24:08 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:24:12 完整请求
21:24:12 请求结束
21:24:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:13 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:24:13 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:24:14 完整请求
21:24:14 请求结束
21:24:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:14 path and query /api/comment/add {} {"content":"123","weibo_id":"${id}"}
21:24:14 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:24:23 完整请求
21:24:23 请求结束
21:24:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:23 path and query /api/comment/add {} {"content":"123","weibo_id":"${id}"}
21:24:23 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:24:23 完整请求
21:24:24 请求结束
21:24:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:24 path and query /api/comment/add {} {"content":"123","weibo_id":"${id}"}
21:24:24 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:24:24 完整请求
21:24:24 请求结束
21:24:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:24 path and query /api/comment/add {} {"content":"123","weibo_id":"${id}"}
21:24:24 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:24:25 完整请求
21:24:25 请求结束
21:24:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:24:25 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:24:26 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:31:58 完整请求
21:31:58 请求结束
21:31:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:31:58 path and query /api/comment/add {} {"content":"","weibo_id":"${id}"}
21:31:58 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:32:55 完整请求
21:32:55 请求结束
21:32:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:32:56 path and query /weibo/index {} 
21:32:56 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <input type="hidden" id="comment-weibo_id" value="${id}">
            <input id="comment-content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:32:56 完整请求
21:32:56 完整请求
21:32:56 请求结束
21:32:56 请求结束
21:32:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:32:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:32:56 path and query /static {'file': 'gua.js'} 
21:32:56 path and query /static {'file': 'weibo.js'} 
21:32:56 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:32:56 完整请求
21:32:56 请求结束
21:32:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:32:56 path and query /api/weibo/all {} 
21:32:56 完整请求
21:32:56 请求结束
21:32:56 kwargs,  {'weibo_id': 1} <class 'dict'>
21:32:56 kwargs,  {'weibo_id': 2} <class 'dict'>
21:32:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:32:56 path and query /static {'file': 'weibo.js'} 
21:32:56 kwargs,  {'weibo_id': 3} <class 'dict'>
21:32:56 kwargs,  {'weibo_id': 4} <class 'dict'>
21:32:56 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:32:56 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:33:39 完整请求
21:33:39 请求结束
21:33:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:33:39 path and query /weibo/index {} 
21:33:39 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <div class="comment-form">
            <input type="hidden" id="comment-weibo_id" value="${id}">
            <input id="comment-content">
            <br>
            <button class="comment-add">添加评论</button>
        </div>
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:33:39 完整请求
21:33:39 完整请求
21:33:39 请求结束
21:33:39 请求结束
21:33:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:33:39 path and query /static {'file': 'weibo.js'} 
21:33:39 path and query /static {'file': 'gua.js'} 
21:33:39 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:33:39 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:33:39 完整请求
21:33:39 请求结束
21:33:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:33:40 path and query /api/weibo/all {} 
21:33:40 kwargs,  {'weibo_id': 1} <class 'dict'>
21:33:40 完整请求
21:33:40 请求结束
21:33:40 kwargs,  {'weibo_id': 2} <class 'dict'>
21:33:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:33:40 kwargs,  {'weibo_id': 3} <class 'dict'>
21:33:40 path and query /static {'file': 'weibo.js'} 
21:33:40 kwargs,  {'weibo_id': 4} <class 'dict'>
21:33:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:33:40 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:34:55 完整请求
21:34:55 请求结束
21:34:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:34:55 path and query /weibo/index {} 
21:34:55 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:34:55 完整请求
21:34:55 完整请求
21:34:55 请求结束
21:34:55 请求结束
21:34:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:34:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:34:55 path and query /static {'file': 'weibo.js'} 
21:34:55 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:34:55 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:34:56 完整请求
21:34:56 请求结束
21:34:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:34:56 path and query /static {'file': 'weibo.js'} 
21:34:56 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:34:56 完整请求
21:34:56 请求结束
21:34:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:34:56 path and query /static {'file': 'weibo.js'} 
21:34:56 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.comment-form')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:08 完整请求
21:38:08 请求结束
21:38:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:08 path and query /weibo/index {} 
21:38:08 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:38:09 完整请求
21:38:09 完整请求
21:38:09 请求结束
21:38:09 请求结束
21:38:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:09 path and query /static {'file': 'weibo.js'} 
21:38:09 path and query /static {'file': 'gua.js'} 
21:38:09 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:38:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:09 完整请求
21:38:09 请求结束
21:38:09 完整请求
21:38:09 请求结束
21:38:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:09 path and query /api/weibo/all {} 
21:38:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:09 path and query /static {'file': 'weibo.js'} 
21:38:09 kwargs,  {'weibo_id': 1} <class 'dict'>
21:38:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:09 kwargs,  {'weibo_id': 2} <class 'dict'>
21:38:09 kwargs,  {'weibo_id': 3} <class 'dict'>
21:38:09 kwargs,  {'weibo_id': 4} <class 'dict'>
21:38:09 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:38:11 完整请求
21:38:11 请求结束
21:38:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:11 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:11 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:15 完整请求
21:38:15 请求结束
21:38:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:15 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
21:38:15 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:19 完整请求
21:38:19 请求结束
21:38:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:19 path and query /weibo/index {} 
21:38:19 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:38:19 完整请求
21:38:19 完整请求
21:38:19 请求结束
21:38:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:19 path and query /static {'file': 'gua.js'} 

21:38:19 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:38:19 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:19 完整请求
21:38:19 请求结束
21:38:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:19 path and query /api/weibo/all {} 
21:38:19 kwargs,  {'weibo_id': 1} <class 'dict'>
21:38:19 完整请求
21:38:20 请求结束
21:38:20 kwargs,  {'weibo_id': 2} <class 'dict'>
21:38:20 kwargs,  {'weibo_id': 3} <class 'dict'>
21:38:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:20 path and query /static {'file': 'weibo.js'} 
21:38:20 kwargs,  {'weibo_id': 4} <class 'dict'>
21:38:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:22 完整请求
21:38:22 请求结束
21:38:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:22 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:22 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:24 完整请求
21:38:24 请求结束
21:38:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:24 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:24 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:24 完整请求
21:38:24 请求结束
21:38:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:24 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:25 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:25 完整请求
21:38:25 请求结束
21:38:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:25 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:25 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:31 完整请求
21:38:31 请求结束
21:38:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:31 path and query /weibo/index {} 
21:38:31 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:38:31 完整请求
21:38:31 完整请求
21:38:31 请求结束
21:38:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:31 path and query /static {'file': 'gua.js'} 
21:38:31 path and query /static {'file': 'weibo.js'} 
21:38:31 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:31 完整请求
21:38:31 请求结束
21:38:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:31 完整请求
21:38:31 path and query /api/weibo/all {} 
21:38:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:31 kwargs,  {'weibo_id': 1} <class 'dict'>
21:38:31 path and query /static {'file': 'weibo.js'} 
21:38:31 kwargs,  {'weibo_id': 2} <class 'dict'>
21:38:31 kwargs,  {'weibo_id': 3} <class 'dict'>
21:38:31 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:31 kwargs,  {'weibo_id': 4} <class 'dict'>
21:38:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:38:33 完整请求
21:38:33 请求结束
21:38:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:33 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:33 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:36 完整请求
21:38:36 请求结束
21:38:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:36 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
21:38:36 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:47 完整请求
21:38:47 请求结束
21:38:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:48 path and query /weibo/index {} 
21:38:48 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:38:48 完整请求
21:38:48 请求结束
21:38:48 完整请求
21:38:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:48 path and query /static {'file': 'weibo.js'} 
21:38:48 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:38:48 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:48 完整请求
21:38:48 请求结束
21:38:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:48 path and query /api/weibo/all {} 
21:38:48 完整请求
21:38:48 请求结束
21:38:48 kwargs,  {'weibo_id': 1} <class 'dict'>
21:38:48 kwargs,  {'weibo_id': 2} <class 'dict'>
21:38:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:48 path and query /static {'file': 'weibo.js'} 
21:38:48 kwargs,  {'weibo_id': 3} <class 'dict'>
21:38:48 kwargs,  {'weibo_id': 4} <class 'dict'>
21:38:48 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:38:48 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:38:54 完整请求
21:38:54 请求结束
21:38:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:54 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:54 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:55 完整请求
21:38:56 请求结束
21:38:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:56 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:56 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:56 完整请求
21:38:56 请求结束
21:38:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:56 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:56 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:38:56 完整请求
21:38:56 请求结束
21:38:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:38:56 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:38:56 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:39:41 完整请求
21:39:41 请求结束
21:39:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:39:41 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:39:41 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:39:44 完整请求
21:39:44 请求结束
21:39:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:39:44 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
21:39:44 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:40:20 完整请求
21:40:20 请求结束
21:40:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:20 path and query /weibo/index {} 
21:40:20 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:40:20 完整请求
21:40:20 完整请求
21:40:20 请求结束
21:40:20 请求结束
21:40:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:20 path and query /static {'file': 'weibo.js'} 
21:40:20 path and query /static {'file': 'gua.js'} 
21:40:20 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}

var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:40:20 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:40:20 完整请求
21:40:20 请求结束
21:40:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:20 完整请求
21:40:20 请求结束
21:40:20 path and query /api/weibo/all {} 
21:40:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:20 kwargs,  {'weibo_id': 1} <class 'dict'>
21:40:20 path and query /static {'file': 'weibo.js'} 
21:40:20 kwargs,  {'weibo_id': 2} <class 'dict'>
21:40:20 kwargs,  {'weibo_id': 3} <class 'dict'>
21:40:20 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:40:20 kwargs,  {'weibo_id': 4} <class 'dict'>
21:40:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:40:24 完整请求
21:40:24 请求结束
21:40:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:24 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:40:24 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:40:53 完整请求
21:40:53 请求结束
21:40:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:53 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:40:53 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:40:54 完整请求
21:40:54 请求结束
21:40:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:40:54 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:40:54 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
21:47:29 完整请求
21:47:29 请求结束
21:47:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:29 path and query /weibo/index {} 
21:47:29 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:47:29 完整请求
21:47:29 完整请求
21:47:29 请求结束
21:47:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:29 path and query /static {'file': 'weibo.js'} 
21:47:29 path and query /static {'file': 'gua.js'} 
21:47:29 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:47:29 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:47:29 完整请求
21:47:29 请求结束
21:47:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:29 path and query /api/weibo/all {} 
21:47:29 kwargs,  {'weibo_id': 1} <class 'dict'>
21:47:29 完整请求
21:47:29 请求结束
21:47:29 kwargs,  {'weibo_id': 2} <class 'dict'>
21:47:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:29 kwargs,  {'weibo_id': 3} <class 'dict'>
21:47:29 kwargs,  {'weibo_id': 4} <class 'dict'>
21:47:29 path and query /static {'file': 'weibo.js'} 
21:47:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:47:29 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var b = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add'))
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:47:31 完整请求
21:47:31 请求结束
21:47:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:31 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:47:31 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /weibo/index


21:47:31 完整请求
21:47:31 请求结束
21:47:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:31 path and query /weibo/index {} 
21:47:31 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:47:32 完整请求
21:47:32 请求结束
21:47:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:32 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:47:32 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /weibo/index


21:47:32 完整请求
21:47:32 请求结束
21:47:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:47:32 path and query /weibo/index {} 
21:47:32 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:51:31 完整请求
21:51:31 请求结束
21:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:51:31 path and query /weibo/index {} 
21:51:31 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:51:31 完整请求
21:51:31 请求结束
21:51:31 请求结束
21:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:51:31 path and query /static {'file': 'weibo.js'} 
21:51:31 path and query /static {'file': 'gua.js'} 
21:51:31 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:51:31 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:51:32 完整请求
21:51:32 请求结束
21:51:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:51:32 path and query /api/weibo/all {} 
21:51:32 完整请求
21:51:32 请求结束
21:51:32 kwargs,  {'weibo_id': 1} <class 'dict'>
21:51:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:51:32 kwargs,  {'weibo_id': 2} <class 'dict'>
21:51:32 path and query /static {'file': 'weibo.js'} 
21:51:32 kwargs,  {'weibo_id': 3} <class 'dict'>
21:51:32 kwargs,  {'weibo_id': 4} <class 'dict'>
21:51:32 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:51:32 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:51:38 完整请求
21:51:38 请求结束
21:51:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:51:38 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
21:51:38 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /weibo/index


21:51:38 完整请求
21:51:38 请求结束
21:51:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:51:38 path and query /weibo/index {} 
21:51:38 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:53:43 完整请求
21:53:43 请求结束
21:53:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:53:43 path and query /weibo/index {} 
21:53:43 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:53:43 完整请求
21:53:43 完整请求
21:53:43 请求结束
21:53:43 请求结束
21:53:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:53:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:53:43 path and query /static {'file': 'weibo.js'} 
21:53:43 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:53:43 完整请求
21:53:43 请求结束
21:53:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:53:43 完整请求
21:53:43 path and query /api/weibo/all {} 
21:53:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:53:43 kwargs,  {'weibo_id': 1} <class 'dict'>
21:53:43 path and query /static {'file': 'weibo.js'} 
21:53:44 kwargs,  {'weibo_id': 3} <class 'dict'>
21:53:44 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:53:44 kwargs,  {'weibo_id': 4} <class 'dict'>
21:53:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:53:52 完整请求
21:53:52 请求结束
21:53:52 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:53:52 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
21:53:52 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "123",
  "weibo_id": 1
}
21:54:03 完整请求
21:54:03 请求结束
21:54:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:03 path and query /weibo/index {} 
21:54:03 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:54:03 完整请求
21:54:03 完整请求
21:54:03 请求结束
21:54:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:03 path and query /static {'file': 'weibo.js'} 
21:54:03 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:54:03 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:54:03 完整请求
21:54:03 请求结束
21:54:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:03 path and query /api/weibo/all {} 
21:54:03 完整请求
21:54:03 请求结束
21:54:03 kwargs,  {'weibo_id': 1} <class 'dict'>
21:54:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:03 kwargs,  {'weibo_id': 2} <class 'dict'>
21:54:03 path and query /static {'file': 'weibo.js'} 
21:54:03 kwargs,  {'weibo_id': 3} <class 'dict'>
21:54:03 kwargs,  {'weibo_id': 4} <class 'dict'>
21:54:03 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:54:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:54:29 完整请求
21:54:29 请求结束
21:54:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:30 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
21:54:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "",
  "weibo_id": 1
}
21:54:37 完整请求
21:54:37 请求结束
21:54:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:37 path and query /weibo/index {} 
21:54:37 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:54:37 完整请求
21:54:37 完整请求
21:54:37 请求结束
21:54:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:37 path and query /static {'file': 'weibo.js'} 
21:54:37 path and query /static {'file': 'gua.js'} 
21:54:38 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:54:38 完整请求
21:54:38 请求结束
21:54:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:38 完整请求
21:54:38 请求结束
21:54:38 path and query /api/weibo/all {} 
21:54:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:38 kwargs,  {'weibo_id': 1} <class 'dict'>
21:54:38 path and query /static {'file': 'weibo.js'} 
21:54:38 kwargs,  {'weibo_id': 2} <class 'dict'>
21:54:38 kwargs,  {'weibo_id': 3} <class 'dict'>
21:54:38 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:54:38 kwargs,  {'weibo_id': 4} <class 'dict'>
21:54:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
21:54:56 完整请求
21:54:57 请求结束
21:54:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:57 path and query /weibo/index {} 
21:54:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
21:54:57 完整请求
21:54:57 完整请求
21:54:57 请求结束
21:54:57 请求结束
21:54:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:57 path and query /static {'file': 'gua.js'} 
21:54:57 path and query /static {'file': 'weibo.js'} 
21:54:57 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
21:54:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:54:57 完整请求
21:54:57 请求结束
21:54:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:57 path and query /api/weibo/all {} 
21:54:57 完整请求
21:54:57 请求结束
21:54:57 kwargs,  {'weibo_id': 1} <class 'dict'>
21:54:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
21:54:57 kwargs,  {'weibo_id': 2} <class 'dict'>
21:54:57 path and query /static {'file': 'weibo.js'} 
21:54:57 kwargs,  {'weibo_id': 3} <class 'dict'>
21:54:57 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)

    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                //var Weibo = JSON.parse(r)
                //insertWeibo(Weibo)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

21:54:57 kwargs,  {'weibo_id': 4} <class 'dict'>
21:54:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:12:19 完整请求
22:12:19 请求结束
22:12:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:12:20 path and query /weibo/index {} 
22:12:20 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:12:20 完整请求
22:12:20 完整请求
22:12:20 请求结束
22:12:20 请求结束
22:12:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:12:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:12:20 path and query /static {'file': 'gua.js'} 

22:12:20 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comments_html = commentsTemplate(comments)
                var c = e('comment-list')
                c.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:12:20 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:12:20 完整请求
22:12:20 请求结束
22:12:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:12:20 path and query /api/weibo/all {} 
22:12:20 kwargs,  {'weibo_id': 1} <class 'dict'>
22:12:20 完整请求
22:12:20 请求结束
22:12:20 kwargs,  {'weibo_id': 2} <class 'dict'>
22:12:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:12:20 kwargs,  {'weibo_id': 3} <class 'dict'>
22:12:20 path and query /static {'file': 'weibo.js'} 
22:12:20 kwargs,  {'weibo_id': 4} <class 'dict'>
22:12:20 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comments_html = commentsTemplate(comments)
                var c = e('comment-list')
                c.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:12:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:12:27 完整请求
22:12:27 请求结束
22:12:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:12:27 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
22:12:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  }
]
22:22:33 完整请求
22:22:33 请求结束
22:22:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:22:33 path and query /weibo/index {} 
22:22:33 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:22:34 完整请求
22:22:34 完整请求
22:22:34 请求结束
22:22:34 请求结束
22:22:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:22:34 path and query /static {'file': 'gua.js'} 
22:22:34 path and query /static {'file': 'weibo.js'} 
22:22:34 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:22:34 完整请求
22:22:34 请求结束
22:22:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:22:34 path and query /api/weibo/all {} 
22:22:34 kwargs,  {'weibo_id': 1} <class 'dict'>
22:22:34 kwargs,  {'weibo_id': 2} <class 'dict'>
22:22:34 kwargs,  {'weibo_id': 3} <class 'dict'>
22:22:34 kwargs,  {'weibo_id': 4} <class 'dict'>
22:22:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:22:35 完整请求
22:22:35 请求结束
22:22:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:22:35 path and query /static {'file': 'weibo.js'} 
22:22:35 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:22:46 完整请求
22:22:46 请求结束
22:22:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:22:46 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
22:22:46 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /api/weibo/index


22:22:46 完整请求
22:22:46 请求结束
22:22:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:22:46 path and query /api/weibo/index {} 
22:22:46 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:23:06 完整请求
22:23:06 请求结束
22:23:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:06 path and query /weibo/index {} 
22:23:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:23:07 完整请求
22:23:07 请求结束
22:23:07 请求结束
22:23:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:07 path and query /static {'file': 'gua.js'} 
22:23:07 path and query /static {'file': 'weibo.js'} 
22:23:07 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:23:07 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:23:07 完整请求
22:23:07 请求结束
22:23:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:07 path and query /api/weibo/all {} 
22:23:07 kwargs,  {'weibo_id': 1} <class 'dict'>
22:23:07 完整请求
22:23:07 请求结束
22:23:07 kwargs,  {'weibo_id': 2} <class 'dict'>
22:23:07 kwargs,  {'weibo_id': 3} <class 'dict'>
22:23:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:07 path and query /static {'file': 'weibo.js'} 
22:23:07 kwargs,  {'weibo_id': 4} <class 'dict'>
22:23:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if (self.classList.contains('comment-add')){
            log("comment-add click")
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:23:12 完整请求
22:23:12 请求结束
22:23:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:12 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
22:23:12 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /api/weibo/index


22:23:12 完整请求
22:23:13 请求结束
22:23:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:13 path and query /api/weibo/index {} 
22:23:13 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:23:26 完整请求
22:23:26 请求结束
22:23:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:26 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
22:23:26 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /api/weibo/index


22:23:26 完整请求
22:23:26 请求结束
22:23:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:23:26 path and query /api/weibo/index {} 
22:23:26 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:37:00 完整请求
22:37:00 请求结束
22:37:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:37:00 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
22:37:00 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /api/weibo/index


22:37:00 完整请求
22:37:00 请求结束
22:37:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:37:00 path and query /api/weibo/index {} 
22:37:00 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:37:13 完整请求
22:37:13 请求结束
22:37:41 完整请求
22:37:41 请求结束
22:37:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:37:41 path and query /weibo/index {} 
22:37:41 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:37:41 完整请求
22:37:41 完整请求
22:37:41 请求结束
22:37:41 请求结束
22:37:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:37:41 path and query /static {'file': 'weibo.js'} 
22:37:41 path and query /static {'file': 'gua.js'} 
22:37:41 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:37:41 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parent.parent
        log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:37:42 完整请求
22:37:42 请求结束
22:37:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:37:42 path and query /api/weibo/all {} 
22:37:42 kwargs,  {'weibo_id': 1} <class 'dict'>
22:37:42 kwargs,  {'weibo_id': 2} <class 'dict'>
22:37:42 kwargs,  {'weibo_id': 3} <class 'dict'>
22:37:42 完整请求
22:37:42 请求结束
22:37:42 kwargs,  {'weibo_id': 4} <class 'dict'>
22:37:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:37:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:37:42 path and query /static {'file': 'weibo.js'} 
22:37:42 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parent.parent
        log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:38:24 完整请求
22:38:24 请求结束
22:38:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:24 path and query /weibo/index {} 
22:38:24 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:38:25 完整请求
22:38:25 完整请求
22:38:25 请求结束
22:38:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:25 path and query /static {'file': 'gua.js'} 
22:38:25 path and query /static {'file': 'weibo.js'} 
22:38:25 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target 
        var WeiboCell = self.parentElement.parentElement
        log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:38:25 完整请求
22:38:25 请求结束
22:38:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:25 path and query /api/weibo/all {} 
22:38:25 kwargs,  {'weibo_id': 1} <class 'dict'>
22:38:25 完整请求
22:38:25 请求结束
22:38:25 kwargs,  {'weibo_id': 2} <class 'dict'>
22:38:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:25 kwargs,  {'weibo_id': 3} <class 'dict'>
22:38:26 path and query /static {'file': 'weibo.js'} 
22:38:26 kwargs,  {'weibo_id': 4} <class 'dict'>
22:38:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
iv>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target 
        var WeiboCell = self.parentElement.parentElement
        log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:38:38 完整请求
22:38:38 请求结束
22:38:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:38 path and query /api/comment/add {} {"content":"235","weibo_id":"1"}
22:38:38 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /api/weibo/index


22:38:38 完整请求
22:38:38 请求结束
22:38:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:38:38 path and query /api/weibo/index {} 
22:38:38 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
22:49:01 完整请求
22:49:02 请求结束
22:49:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:02 path and query /weibo/index {} 
22:49:02 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:49:02 完整请求
22:49:02 完整请求
22:49:02 请求结束
22:49:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:02 path and query /static {'file': 'gua.js'} 

22:49:02 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:02 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:49:02 完整请求
22:49:02 请求结束
22:49:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:02 完整请求
22:49:02 path and query /api/weibo/all {} 
22:49:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:02 kwargs,  {'weibo_id': 1} <class 'dict'>
22:49:02 path and query /static {'file': 'weibo.js'} 
22:49:02 kwargs,  {'weibo_id': 2} <class 'dict'>
22:49:02 kwargs,  {'weibo_id': 3} <class 'dict'>
22:49:02 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:02 kwargs,  {'weibo_id': 4} <class 'dict'>
22:49:03 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 6,
        "content": "235",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:49:09 完整请求
22:49:09 请求结束
22:49:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:09 path and query /weibo/index {} 
22:49:09 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:49:09 完整请求
22:49:09 完整请求
22:49:09 请求结束
22:49:09 请求结束
22:49:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:09 path and query /static {'file': 'gua.js'} 
22:49:09 path and query /static {'file': 'weibo.js'} 
22:49:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:09 完整请求
22:49:09 请求结束
22:49:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:09 完整请求
22:49:09 path and query /api/weibo/all {} 
22:49:09 请求结束
22:49:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:09 kwargs,  {'weibo_id': 1} <class 'dict'>
22:49:10 path and query /static {'file': 'weibo.js'} 
22:49:10 kwargs,  {'weibo_id': 2} <class 'dict'>
22:49:10 kwargs,  {'weibo_id': 3} <class 'dict'>
22:49:10 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:10 kwargs,  {'weibo_id': 4} <class 'dict'>
22:49:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 6,
        "content": "235",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:49:20 完整请求
22:49:20 请求结束
22:49:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:20 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:49:20 kwargs,  {'weibo_id': 1} <class 'dict'>
22:49:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "235",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "",
    "weibo_id": 1
  }
]
22:49:23 完整请求
22:49:23 请求结束
22:49:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:23 path and query /weibo/index {} 
22:49:23 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:49:24 完整请求
22:49:24 完整请求
22:49:24 请求结束
22:49:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:24 path and query /static {'file': 'gua.js'} 
22:49:24 path and query /static {'file': 'weibo.js'} 
22:49:24 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:24 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:49:24 完整请求
22:49:24 请求结束
22:49:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:24 path and query /api/weibo/all {} 
22:49:24 kwargs,  {'weibo_id': 1} <class 'dict'>
22:49:24 kwargs,  {'weibo_id': 2} <class 'dict'>
22:49:24 kwargs,  {'weibo_id': 3} <class 'dict'>
22:49:24 kwargs,  {'weibo_id': 4} <class 'dict'>
22:49:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 6,
        "content": "235",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:49:24 完整请求
22:49:24 请求结束
22:49:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:24 path and query /static {'file': 'weibo.js'} 
22:49:24 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:41 完整请求
22:49:41 请求结束
22:49:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:41 path and query /weibo/index {} 
22:49:41 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:49:42 完整请求
22:49:42 完整请求
22:49:42 请求结束
22:49:42 请求结束
22:49:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:42 path and query /static {'file': 'gua.js'} 
22:49:42 path and query /static {'file': 'weibo.js'} 
22:49:42 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:42 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:49:42 完整请求
22:49:42 请求结束
22:49:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:42 path and query /api/weibo/all {} 
22:49:42 kwargs,  {'weibo_id': 1} <class 'dict'>
22:49:42 kwargs,  {'weibo_id': 2} <class 'dict'>
22:49:42 kwargs,  {'weibo_id': 3} <class 'dict'>
22:49:42 kwargs,  {'weibo_id': 4} <class 'dict'>
22:49:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 6,
        "content": "235",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:49:42 完整请求
22:49:42 请求结束
22:49:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:42 path and query /static {'file': 'weibo.js'} 
22:49:42 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.e('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:49:47 完整请求
22:49:47 请求结束
22:49:47 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:49:47 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:49:47 kwargs,  {'weibo_id': 1} <class 'dict'>
22:49:47 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "235",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 8,
    "content": "",
    "weibo_id": 1
  }
]
22:50:33 完整请求
22:50:33 请求结束
22:50:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:50:33 path and query /weibo/index {} 
22:50:33 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:50:33 完整请求
22:50:33 请求结束
22:50:33 完整请求
22:50:33 请求结束
22:50:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:50:34 path and query /static {'file': 'gua.js'} 
22:50:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:50:34 path and query /static {'file': 'weibo.js'} 
22:50:34 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:50:34 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.querySelector('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:50:34 完整请求
22:50:34 请求结束
22:50:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:50:34 path and query /api/weibo/all {} 
22:50:34 kwargs,  {'weibo_id': 1} <class 'dict'>
22:50:34 kwargs,  {'weibo_id': 2} <class 'dict'>
22:50:34 kwargs,  {'weibo_id': 3} <class 'dict'>
22:50:34 kwargs,  {'weibo_id': 4} <class 'dict'>
22:50:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 6,
        "content": "235",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "",
        "weibo_id": 1
      },
      {
        "id": 8,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:50:34 完整请求
22:50:34 请求结束
22:50:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:50:34 path and query /static {'file': 'weibo.js'} 
22:50:34 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.querySelector('comment-list')
                log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:50:41 完整请求
22:50:41 请求结束
22:50:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:50:41 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:50:41 kwargs,  {'weibo_id': 1} <class 'dict'>
22:50:41 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "235",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 8,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 9,
    "content": "",
    "weibo_id": 1
  }
]
22:51:05 完整请求
22:51:05 请求结束
22:51:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:05 path and query /weibo/index {} 
22:51:05 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:51:05 完整请求
22:51:05 完整请求
22:51:05 请求结束
22:51:05 请求结束
22:51:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:05 path and query /static {'file': 'weibo.js'} 
22:51:05 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:05 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:51:05 完整请求
22:51:05 请求结束
22:51:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:05 path and query /api/weibo/all {} 
22:51:05 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:05 kwargs,  {'weibo_id': 2} <class 'dict'>
22:51:05 kwargs,  {'weibo_id': 3} <class 'dict'>
22:51:05 kwargs,  {'weibo_id': 4} <class 'dict'>
22:51:05 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:51:05 完整请求
22:51:05 请求结束
22:51:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:05 path and query /static {'file': 'weibo.js'} 
22:51:05 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:11 完整请求
22:51:11 请求结束
22:51:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:11 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
22:51:11 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:11 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  }
]
22:51:14 完整请求
22:51:14 请求结束
22:51:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:14 path and query /weibo/index {} 
22:51:14 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:51:14 完整请求
22:51:14 完整请求
22:51:14 请求结束
22:51:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:14 path and query /static {'file': 'weibo.js'} 
22:51:14 path and query /static {'file': 'gua.js'} 
22:51:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:14 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:51:14 完整请求
22:51:14 请求结束
22:51:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:14 path and query /api/weibo/all {} 
22:51:14 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:14 kwargs,  {'weibo_id': 2} <class 'dict'>
22:51:14 kwargs,  {'weibo_id': 3} <class 'dict'>
22:51:14 kwargs,  {'weibo_id': 4} <class 'dict'>
22:51:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:51:14 完整请求
22:51:14 请求结束
22:51:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:14 path and query /static {'file': 'weibo.js'} 
22:51:14 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:22 完整请求
22:51:22 请求结束
22:51:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:22 path and query /api/comment/add {} {"content":"aaa456","weibo_id":"1"}
22:51:22 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:22 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  }
]
22:51:24 完整请求
22:51:24 请求结束
22:51:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:24 path and query /weibo/index {} 
22:51:24 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:51:24 完整请求
22:51:24 请求结束
22:51:24 请求结束
22:51:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:24 path and query /static {'file': 'weibo.js'} 
22:51:24 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:24 完整请求
22:51:24 请求结束
22:51:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:24 path and query /api/weibo/all {} 
22:51:24 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:24 kwargs,  {'weibo_id': 2} <class 'dict'>
22:51:24 kwargs,  {'weibo_id': 3} <class 'dict'>
22:51:24 kwargs,  {'weibo_id': 4} <class 'dict'>
22:51:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:51:24 完整请求
22:51:24 请求结束
22:51:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:24 path and query /static {'file': 'weibo.js'} 
22:51:24 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:28 完整请求
22:51:28 请求结束
22:51:28 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:28 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:51:28 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:28 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  }
]
22:51:31 完整请求
22:51:31 请求结束
22:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:31 path and query /weibo/index {} 
22:51:31 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:51:31 完整请求
22:51:31 完整请求
22:51:31 请求结束
22:51:31 请求结束
22:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:31 path and query /static {'file': 'weibo.js'} 
22:51:31 path and query /static {'file': 'gua.js'} 
22:51:31 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:31 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:51:31 完整请求
22:51:31 请求结束
22:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:31 path and query /api/weibo/all {} 
22:51:31 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:31 kwargs,  {'weibo_id': 2} <class 'dict'>
22:51:31 kwargs,  {'weibo_id': 3} <class 'dict'>
22:51:31 kwargs,  {'weibo_id': 4} <class 'dict'>
22:51:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:51:31 完整请求
22:51:31 请求结束
22:51:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:31 path and query /static {'file': 'weibo.js'} 
22:51:31 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:46 完整请求
22:51:46 请求结束
22:51:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:46 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:51:46 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:46 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "",
    "weibo_id": 1
  }
]
22:51:51 完整请求
22:51:51 请求结束
22:51:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:51 path and query /weibo/index {} 
22:51:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:51:51 完整请求
22:51:51 完整请求
22:51:51 请求结束
22:51:51 请求结束
22:51:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:51 path and query /static {'file': 'gua.js'} 

22:51:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:51:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:51:51 完整请求
22:51:51 请求结束
22:51:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:51 path and query /api/weibo/all {} 
22:51:51 kwargs,  {'weibo_id': 1} <class 'dict'>
22:51:51 kwargs,  {'weibo_id': 2} <class 'dict'>
22:51:51 kwargs,  {'weibo_id': 3} <class 'dict'>
22:51:51 kwargs,  {'weibo_id': 4} <class 'dict'>
22:51:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:51:51 完整请求
22:51:51 请求结束
22:51:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:51:51 path and query /static {'file': 'weibo.js'} 
22:51:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:52:35 完整请求
22:52:35 请求结束
22:52:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:35 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:52:39 完整请求
22:52:39 请求结束
22:52:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:39 path and query /weibo/index {} 
22:52:39 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:52:39 完整请求
22:52:40 完整请求
22:52:40 请求结束
22:52:40 请求结束
22:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:40 path and query /static {'file': 'weibo.js'} 
22:52:40 path and query /static {'file': 'gua.js'} 
22:52:40 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:52:40 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:52:40 完整请求
22:52:40 请求结束
22:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:40 path and query /api/weibo/all {} 
22:52:40 kwargs,  {'weibo_id': 1} <class 'dict'>
22:52:40 完整请求
22:52:40 完整请求
22:52:40 请求结束
22:52:40 请求结束
22:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:40 path and query /static {'file': 'weibo.js'} 
22:52:40 path and query /api/weibo/all {} 
22:52:40 kwargs,  {'weibo_id': 1} <class 'dict'>
22:52:40 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:52:45 完整请求
22:52:45 请求结束
22:52:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:45 path and query /weibo/index {} 
22:52:45 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:52:45 完整请求
22:52:45 请求结束
22:52:45 请求结束
22:52:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:45 path and query /static {'file': 'weibo.js'} 
22:52:45 path and query /static {'file': 'gua.js'} 
22:52:45 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:52:45 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:52:46 完整请求
22:52:46 请求结束
22:52:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:46 path and query /api/weibo/all {} 
22:52:46 kwargs,  {'weibo_id': 1} <class 'dict'>
22:52:55 完整请求
22:52:55 请求结束
22:52:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:55 path and query /weibo/index {} 
22:52:55 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:52:55 完整请求
22:52:55 完整请求
22:52:55 请求结束
22:52:55 请求结束
22:52:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:55 path and query /static {'file': 'gua.js'} 
22:52:55 path and query /static {'file': 'weibo.js'} 
22:52:55 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:52:55 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:52:55 完整请求
22:52:55 请求结束
22:52:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:52:55 path and query /api/weibo/all {} 
22:52:55 kwargs,  {'weibo_id': 1} <class 'dict'>
22:52:55 kwargs,  {'weibo_id': 2} <class 'dict'>
22:52:55 kwargs,  {'weibo_id': 3} <class 'dict'>
22:52:55 kwargs,  {'weibo_id': 4} <class 'dict'>
22:52:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:54:00 完整请求
22:54:00 请求结束
22:54:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:00 path and query /weibo/index {} 
22:54:00 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:54:00 完整请求
22:54:00 请求结束
22:54:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:00 path and query /static {'file': 'gua.js'} 
22:54:00 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:54:00 完整请求
22:54:00 请求结束
22:54:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:00 path and query /static {'file': 'weibo.js'} 
22:54:00 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:54:00 完整请求
22:54:00 请求结束
22:54:00 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:00 path and query /api/weibo/all {} 
22:54:00 kwargs,  {'weibo_id': 1} <class 'dict'>
22:54:00 kwargs,  {'weibo_id': 2} <class 'dict'>
22:54:00 kwargs,  {'weibo_id': 3} <class 'dict'>
22:54:00 kwargs,  {'weibo_id': 4} <class 'dict'>
22:54:00 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:54:04 完整请求
22:54:04 请求结束
22:54:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:04 path and query /api/comment/add {} {"content":"","weibo_id":"1"}
22:54:04 kwargs,  {'weibo_id': 1} <class 'dict'>
22:54:04 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  }
]
22:54:18 完整请求
22:54:18 请求结束
22:54:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:18 path and query /weibo/index {} 
22:54:18 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:54:18 完整请求
22:54:18 完整请求
22:54:18 请求结束
22:54:18 请求结束
22:54:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:18 path and query /static {'file': 'gua.js'} 

22:54:18 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:54:18 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:54:18 完整请求
22:54:18 请求结束
22:54:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:18 path and query /api/weibo/all {} 
22:54:18 kwargs,  {'weibo_id': 1} <class 'dict'>
22:54:18 kwargs,  {'weibo_id': 2} <class 'dict'>
22:54:18 kwargs,  {'weibo_id': 3} <class 'dict'>
22:54:18 kwargs,  {'weibo_id': 4} <class 'dict'>
22:54:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
22:54:27 完整请求
22:54:27 请求结束
22:54:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:27 path and query /api/comment/add {} {"content":"aaa789","weibo_id":"1"}
22:54:27 kwargs,  {'weibo_id': 1} <class 'dict'>
22:54:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa789",
    "weibo_id": 1
  }
]
22:54:55 完整请求
22:54:55 请求结束
22:54:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:55 path and query /weibo/index {} 
22:54:55 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
22:54:55 完整请求
22:54:55 完整请求
22:54:55 请求结束
22:54:55 请求结束
22:54:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:55 path and query /static {'file': 'gua.js'} 

22:54:55 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

22:54:55 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
22:54:55 完整请求
22:54:55 请求结束
22:54:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
22:54:55 path and query /api/weibo/all {} 
22:54:55 kwargs,  {'weibo_id': 1} <class 'dict'>
22:54:55 kwargs,  {'weibo_id': 2} <class 'dict'>
22:54:55 kwargs,  {'weibo_id': 3} <class 'dict'>
22:54:55 kwargs,  {'weibo_id': 4} <class 'dict'>
22:54:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa789",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:05:09 完整请求
23:05:09 请求结束
23:05:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:09 path and query /weibo/index {} 
23:05:09 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:05:09 完整请求
23:05:09 完整请求
23:05:09 请求结束
23:05:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:09 path and query /static {'file': 'gua.js'} 
23:05:09 path and query /static {'file': 'weibo.js'} 
23:05:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo_id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            log("content,", content)
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:05:09 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:05:09 完整请求
23:05:10 请求结束
23:05:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:10 path and query /api/weibo/all {} 
23:05:10 kwargs,  {'weibo_id': 1} <class 'dict'>
23:05:10 kwargs,  {'weibo_id': 2} <class 'dict'>
23:05:10 kwargs,  {'weibo_id': 3} <class 'dict'>
23:05:10 kwargs,  {'weibo_id': 4} <class 'dict'>
23:05:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa789",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:05:58 完整请求
23:05:58 请求结束
23:05:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:58 path and query /weibo/index {} 
23:05:58 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:05:58 完整请求
23:05:58 完整请求
23:05:58 请求结束
23:05:58 请求结束
23:05:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:58 path and query /static {'file': 'gua.js'} 

23:05:58 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var WeiboCell = self.parentElement.parentElement // 只局部更新这个WeiboCell的comments
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            var input = e('#comment-content')
            var content = input.value
            log("content,", content)
            var input = e('#comment-weibo_id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:05:58 完整请求
23:05:58 请求结束
23:05:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:05:58 path and query /api/weibo/all {} 
23:05:58 kwargs,  {'weibo_id': 1} <class 'dict'>
23:05:58 kwargs,  {'weibo_id': 2} <class 'dict'>
23:05:58 kwargs,  {'weibo_id': 3} <class 'dict'>
23:05:59 kwargs,  {'weibo_id': 4} <class 'dict'>
23:05:59 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa789",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:06:26 完整请求
23:06:26 请求结束
23:06:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:06:26 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
23:06:26 kwargs,  {'weibo_id': 1} <class 'dict'>
23:06:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa789",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "123",
    "weibo_id": 1
  }
]
23:06:32 完整请求
23:06:32 请求结束
23:06:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:06:32 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
23:06:32 kwargs,  {'weibo_id': 1} <class 'dict'>
23:06:32 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa789",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "123",
    "weibo_id": 1
  }
]
23:06:39 完整请求
23:06:39 请求结束
23:06:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:06:39 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
23:06:39 kwargs,  {'weibo_id': 1} <class 'dict'>
23:06:39 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa789",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "123",
    "weibo_id": 1
  }
]
23:06:43 完整请求
23:06:43 请求结束
23:06:43 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:06:43 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
23:06:43 kwargs,  {'weibo_id': 1} <class 'dict'>
23:06:43 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa789",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 8,
    "content": "123",
    "weibo_id": 1
  }
]
23:06:48 完整请求
23:06:48 请求结束
23:06:48 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:06:48 path and query /api/comment/add {} {"content":"123","weibo_id":"1"}
23:06:48 kwargs,  {'weibo_id': 1} <class 'dict'>
23:06:48 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 3,
    "content": "",
    "weibo_id": 1
  },
  {
    "id": 4,
    "content": "aaa789",
    "weibo_id": 1
  },
  {
    "id": 5,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 6,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 8,
    "content": "123",
    "weibo_id": 1
  },
  {
    "id": 9,
    "content": "123",
    "weibo_id": 1
  }
]
23:15:51 完整请求
23:15:51 请求结束
23:15:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:15:51 path and query /weibo/index {} 
23:15:51 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:15:51 完整请求
23:15:51 完整请求
23:15:51 请求结束
23:15:51 请求结束
23:15:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:15:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:15:51 path and query /static {'file': 'weibo.js'} 
23:15:51 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:15:51 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:15:51 完整请求
23:15:51 请求结束
23:15:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:15:51 path and query /api/weibo/all {} 
23:15:51 kwargs,  {'weibo_id': 1} <class 'dict'>
23:15:51 kwargs,  {'weibo_id': 2} <class 'dict'>
23:15:51 kwargs,  {'weibo_id': 3} <class 'dict'>
23:15:51 kwargs,  {'weibo_id': 4} <class 'dict'>
23:15:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 3,
        "content": "",
        "weibo_id": 1
      },
      {
        "id": 4,
        "content": "aaa789",
        "weibo_id": 1
      },
      {
        "id": 5,
        "content": "123",
        "weibo_id": 1
      },
      {
        "id": 6,
        "content": "123",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "123",
        "weibo_id": 1
      },
      {
        "id": 8,
        "content": "123",
        "weibo_id": 1
      },
      {
        "id": 9,
        "content": "123",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:16:03 完整请求
23:16:03 请求结束
23:16:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:03 path and query /weibo/index {} 
23:16:03 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:16:03 完整请求
23:16:03 完整请求
23:16:03 请求结束
23:16:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:03 请求结束
23:16:03 path and query /static {'file': 'weibo.js'} 
23:16:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:03 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:16:03 path and query /static {'file': 'gua.js'} 
23:16:03 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:16:03 完整请求
23:16:03 请求结束
23:16:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:03 path and query /api/weibo/all {} 
23:16:03 kwargs,  {'weibo_id': 1} <class 'dict'>
23:16:03 kwargs,  {'weibo_id': 2} <class 'dict'>
23:16:03 kwargs,  {'weibo_id': 3} <class 'dict'>
23:16:03 kwargs,  {'weibo_id': 4} <class 'dict'>
23:16:03 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:16:08 完整请求
23:16:08 请求结束
23:16:08 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:08 path and query /api/comment/add {} {"content":"1","weibo_id":"aaa123"}
23:16:15 完整请求
23:16:15 完整请求
23:16:15 请求结束
23:16:15 请求结束
23:16:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:15 path and query /api/comment/add {} {"content":"1","weibo_id":"aaa123"}
23:16:15 path and query /api/comment/add {} {"content":"1","weibo_id":"aaa456"}
23:16:19 完整请求
23:16:19 请求结束
23:16:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:19 path and query /api/comment/add {} {"content":"2","weibo_id":"bbb123"}
23:16:22 完整请求
23:16:22 完整请求
23:16:23 请求结束
23:16:23 请求结束
23:16:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:23 path and query /api/comment/add {} {"content":"2","weibo_id":"bbb123"}
23:16:23 path and query /api/comment/add {} {"content":"2","weibo_id":"bbb456"}
23:16:27 完整请求
23:16:27 请求结束
23:16:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:27 path and query /api/comment/add {} {"content":"3","weibo_id":"ccc123"}
23:16:31 完整请求
23:16:31 完整请求
23:16:31 请求结束
23:16:31 请求结束
23:16:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:31 path and query /api/comment/add {} {"content":"3","weibo_id":"ccc123"}
23:16:31 path and query /api/comment/add {} {"content":"3","weibo_id":"ccc456"}
23:16:35 完整请求
23:16:35 请求结束
23:16:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:35 path and query /api/comment/add {} {"content":"4","weibo_id":"ddd123"}
23:16:39 完整请求
23:16:39 完整请求
23:16:39 请求结束
23:16:39 请求结束
23:16:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:39 path and query /api/comment/add {} {"content":"4","weibo_id":"ddd123"}
23:16:39 path and query /api/comment/add {} {"content":"4","weibo_id":"ddd456"}
23:16:47 完整请求
23:16:47 请求结束
23:16:47 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:47 path and query /api/comment/add {} {"content":"3","weibo_id":"ccc789"}
23:16:49 完整请求
23:16:49 请求结束
23:16:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:49 path and query /weibo/index {} 
23:16:49 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:16:49 完整请求
23:16:49 请求结束
23:16:49 完整请求
23:16:49 请求结束
23:16:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:49 path and query /static {'file': 'gua.js'} 
23:16:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:49 path and query /static {'file': 'weibo.js'} 
23:16:49 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:16:49 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:16:50 完整请求
23:16:50 请求结束
23:16:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:16:50 path and query /api/weibo/all {} 
23:16:50 kwargs,  {'weibo_id': 1} <class 'dict'>
23:16:50 kwargs,  {'weibo_id': 2} <class 'dict'>
23:16:50 kwargs,  {'weibo_id': 3} <class 'dict'>
23:16:50 kwargs,  {'weibo_id': 4} <class 'dict'>
23:16:50 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:17:17 完整请求
23:17:17 请求结束
23:17:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:17:17 path and query /api/comment/add {} {"content":"1","weibo_id":"aaa123"}
23:17:21 完整请求
23:17:21 请求结束
23:17:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:17:21 path and query /weibo/index {} 
23:17:21 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:17:21 完整请求
23:17:21 完整请求
23:17:21 请求结束
23:17:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:17:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:17:21 path and query /static {'file': 'gua.js'} 
23:17:21 path and query /static {'file': 'weibo.js'} 
23:17:21 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:17:21 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:17:21 完整请求
23:17:21 请求结束
23:17:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:17:21 path and query /api/weibo/all {} 
23:17:21 kwargs,  {'weibo_id': 1} <class 'dict'>
23:17:21 kwargs,  {'weibo_id': 2} <class 'dict'>
23:17:21 kwargs,  {'weibo_id': 3} <class 'dict'>
23:17:21 kwargs,  {'weibo_id': 4} <class 'dict'>
23:17:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:21:29 完整请求
23:21:29 请求结束
23:21:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:29 path and query /weibo/index {} 
23:21:29 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:21:29 完整请求
23:21:29 完整请求
23:21:29 请求结束
23:21:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:30 path and query /static {'file': 'weibo.js'} 
23:21:30 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':parseInt(weibo_id),
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:21:30 完整请求
23:21:30 请求结束
23:21:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:30 path and query /api/weibo/all {} 
23:21:30 kwargs,  {'weibo_id': 1} <class 'dict'>
23:21:30 kwargs,  {'weibo_id': 2} <class 'dict'>
23:21:30 kwargs,  {'weibo_id': 3} <class 'dict'>
23:21:30 kwargs,  {'weibo_id': 4} <class 'dict'>
23:21:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  }
]
23:21:31 完整请求
23:21:31 请求结束
23:21:31 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:31 path and query /api/weibo/delete {'id': '1'} 
23:21:31 kwargs,  {'weibo_id': 1} <class 'dict'>
23:21:31 kwargs,  {'weibo_id': 1} <class 'dict'>
23:21:31 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
23:21:37 完整请求
23:21:37 请求结束
23:21:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:37 path and query /api/weibo/add {} {"content":"aaa"}
23:21:37 kwargs,  {'weibo_id': 5} <class 'dict'>
23:21:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "aaa",
  "comments": []
}
23:21:42 完整请求
23:21:42 请求结束
23:21:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:42 path and query /api/comment/add {} {"content":"5","weibo_id":null}
23:21:44 完整请求
23:21:44 请求结束
23:21:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:44 path and query /weibo/index {} 
23:21:44 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:21:44 完整请求
23:21:44 完整请求
23:21:44 请求结束
23:21:44 请求结束
23:21:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:44 path and query /static {'file': 'weibo.js'} 
23:21:44 path and query /static {'file': 'gua.js'} 
23:21:44 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':parseInt(weibo_id),
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:21:44 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:21:44 完整请求
23:21:44 请求结束
23:21:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:21:44 path and query /api/weibo/all {} 
23:21:44 kwargs,  {'weibo_id': 2} <class 'dict'>
23:21:44 kwargs,  {'weibo_id': 3} <class 'dict'>
23:21:44 kwargs,  {'weibo_id': 4} <class 'dict'>
23:21:44 kwargs,  {'weibo_id': 5} <class 'dict'>
23:21:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:22:17 完整请求
23:22:17 请求结束
23:22:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:17 path and query /weibo/index {} 
23:22:17 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:22:17 完整请求
23:22:17 完整请求
23:22:17 请求结束
23:22:17 请求结束
23:22:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:17 path and query /static {'file': 'weibo.js'} 
23:22:17 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:22:17 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':parseInt(weibo_id),
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:22:17 完整请求
23:22:17 请求结束
23:22:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:17 path and query /api/weibo/all {} 
23:22:17 kwargs,  {'weibo_id': 2} <class 'dict'>
23:22:17 kwargs,  {'weibo_id': 3} <class 'dict'>
23:22:18 kwargs,  {'weibo_id': 4} <class 'dict'>
23:22:18 kwargs,  {'weibo_id': 5} <class 'dict'>
23:22:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:22:25 完整请求
23:22:25 请求结束
23:22:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:25 path and query /api/comment/add {} {"content":"5","weibo_id":null}
23:22:27 完整请求
23:22:27 请求结束
23:22:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:27 path and query /weibo/index {} 
23:22:27 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:22:27 完整请求
23:22:27 完整请求
23:22:27 请求结束
23:22:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:27 path and query /static {'file': 'weibo.js'} 
23:22:27 path and query /static {'file': 'gua.js'} 
23:22:27 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:22:27 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value="${id}">
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':parseInt(weibo_id),
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:22:27 完整请求
23:22:27 请求结束
23:22:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:22:27 path and query /api/weibo/all {} 
23:22:27 kwargs,  {'weibo_id': 2} <class 'dict'>
23:22:27 kwargs,  {'weibo_id': 3} <class 'dict'>
23:22:27 kwargs,  {'weibo_id': 4} <class 'dict'>
23:22:27 kwargs,  {'weibo_id': 5} <class 'dict'>
23:22:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:23:58 完整请求
23:23:58 请求结束
23:23:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:23:58 path and query /weibo/index {} 
23:23:58 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:23:58 完整请求
23:23:58 完整请求
23:23:58 请求结束
23:23:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:23:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:23:58 path and query /static {'file': 'weibo.js'} 
23:23:58 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:23:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:23:59 完整请求
23:23:59 请求结束
23:23:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:23:59 path and query /api/weibo/all {} 
23:23:59 kwargs,  {'weibo_id': 2} <class 'dict'>
23:23:59 kwargs,  {'weibo_id': 3} <class 'dict'>
23:23:59 kwargs,  {'weibo_id': 4} <class 'dict'>
23:23:59 kwargs,  {'weibo_id': 5} <class 'dict'>
23:23:59 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:24:03 完整请求
23:24:03 请求结束
23:24:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:24:03 path and query /api/comment/add {} {"content":"2","weibo_id":"bbb123"}
23:24:04 完整请求
23:24:04 请求结束
23:24:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:24:04 path and query /weibo/index {} 
23:24:04 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:24:04 完整请求
23:24:04 完整请求
23:24:04 请求结束
23:24:04 请求结束
23:24:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:24:04 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:24:04 path and query /static {'file': 'weibo.js'} 
23:24:04 path and query /static {'file': 'gua.js'} 
23:24:04 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-weibo-id') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-content')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:24:04 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:24:05 完整请求
23:24:05 请求结束
23:24:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:24:05 path and query /api/weibo/all {} 
23:24:05 kwargs,  {'weibo_id': 2} <class 'dict'>
23:24:05 kwargs,  {'weibo_id': 3} <class 'dict'>
23:24:05 kwargs,  {'weibo_id': 4} <class 'dict'>
23:24:05 kwargs,  {'weibo_id': 5} <class 'dict'>
23:24:05 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:26:20 完整请求
23:26:20 请求结束
23:26:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:20 path and query /weibo/index {} 
23:26:20 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:26:20 完整请求
23:26:20 完整请求
23:26:20 请求结束
23:26:20 请求结束
23:26:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:20 path and query /static {'file': 'gua.js'} 

23:26:20 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:26:20 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:26:20 完整请求
23:26:20 请求结束
23:26:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:20 path and query /api/weibo/all {} 
23:26:20 kwargs,  {'weibo_id': 2} <class 'dict'>
23:26:20 kwargs,  {'weibo_id': 3} <class 'dict'>
23:26:20 kwargs,  {'weibo_id': 4} <class 'dict'>
23:26:20 kwargs,  {'weibo_id': 5} <class 'dict'>
23:26:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": []
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:26:24 完整请求
23:26:24 请求结束
23:26:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:24 path and query /api/comment/add {} {"content":"bbb123","weibo_id":"2"}
23:26:24 kwargs,  {'weibo_id': 2} <class 'dict'>
23:26:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "bbb123",
    "weibo_id": 2
  }
]
23:26:26 完整请求
23:26:26 请求结束
23:26:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:26 path and query /weibo/index {} 
23:26:26 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:26:26 完整请求
23:26:26 请求结束
23:26:26 请求结束
23:26:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:26 path and query /static {'file': 'gua.js'} 
23:26:26 path and query /static {'file': 'weibo.js'} 
23:26:26 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:26:26 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:26:26 完整请求
23:26:26 请求结束
23:26:26 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:26 path and query /api/weibo/all {} 
23:26:26 kwargs,  {'weibo_id': 2} <class 'dict'>
23:26:26 kwargs,  {'weibo_id': 3} <class 'dict'>
23:26:26 kwargs,  {'weibo_id': 4} <class 'dict'>
23:26:26 kwargs,  {'weibo_id': 5} <class 'dict'>
23:26:26 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": []
  }
]
23:26:30 完整请求
23:26:30 请求结束
23:26:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:30 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"5"}
23:26:30 kwargs,  {'weibo_id': 5} <class 'dict'>
23:26:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "aaa123",
    "weibo_id": 5
  }
]
23:26:33 完整请求
23:26:33 请求结束
23:26:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:33 path and query /weibo/index {} 
23:26:33 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:26:33 完整请求
23:26:33 完整请求
23:26:33 请求结束
23:26:33 请求结束
23:26:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:33 path and query /static {'file': 'weibo.js'} 
23:26:33 path and query /static {'file': 'gua.js'} 
23:26:33 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:26:33 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:26:33 完整请求
23:26:33 请求结束
23:26:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:33 path and query /api/weibo/all {} 
23:26:33 kwargs,  {'weibo_id': 2} <class 'dict'>
23:26:33 kwargs,  {'weibo_id': 3} <class 'dict'>
23:26:33 kwargs,  {'weibo_id': 4} <class 'dict'>
23:26:33 kwargs,  {'weibo_id': 5} <class 'dict'>
23:26:33 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": []
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": []
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": [
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 5
      }
    ]
  }
]
23:26:38 完整请求
23:26:38 请求结束
23:26:38 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:38 path and query /api/comment/add {} {"content":"ddd123","weibo_id":"4"}
23:26:38 kwargs,  {'weibo_id': 4} <class 'dict'>
23:26:38 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 3,
    "content": "ddd123",
    "weibo_id": 4
  }
]
23:26:45 完整请求
23:26:45 请求结束
23:26:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:45 path and query /api/comment/add {} {"content":"ccc123","weibo_id":"3"}
23:26:45 kwargs,  {'weibo_id': 3} <class 'dict'>
23:26:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  }
]
23:26:46 完整请求
23:26:46 请求结束
23:26:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:46 path and query /weibo/index {} 
23:26:46 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:26:46 完整请求
23:26:46 完整请求
23:26:46 请求结束
23:26:46 请求结束
23:26:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:46 path and query /static {'file': 'weibo.js'} 
23:26:46 path and query /static {'file': 'gua.js'} 
23:26:46 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:26:46 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:26:46 完整请求
23:26:46 请求结束
23:26:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:46 path and query /api/weibo/all {} 
23:26:46 kwargs,  {'weibo_id': 2} <class 'dict'>
23:26:46 kwargs,  {'weibo_id': 3} <class 'dict'>
23:26:46 kwargs,  {'weibo_id': 4} <class 'dict'>
23:26:46 kwargs,  {'weibo_id': 5} <class 'dict'>
23:26:47 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 3,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": [
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 5
      }
    ]
  }
]
23:26:52 完整请求
23:26:52 请求结束
23:26:52 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:52 path and query /api/comment/add {} {"content":"aaa456","weibo_id":"5"}
23:26:52 kwargs,  {'weibo_id': 5} <class 'dict'>
23:26:52 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "aaa123",
    "weibo_id": 5
  },
  {
    "id": 5,
    "content": "aaa456",
    "weibo_id": 5
  }
]
23:26:57 完整请求
23:26:57 请求结束
23:26:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:26:57 path and query /api/comment/add {} {"content":"ccc456","weibo_id":"3"}
23:26:57 kwargs,  {'weibo_id': 3} <class 'dict'>
23:26:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 6,
    "content": "ccc456",
    "weibo_id": 3
  }
]
23:27:02 完整请求
23:27:02 请求结束
23:27:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:27:02 path and query /api/comment/add {} {"content":"aaa456","weibo_id":"2"}
23:27:02 kwargs,  {'weibo_id': 2} <class 'dict'>
23:27:02 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "bbb123",
    "weibo_id": 2
  },
  {
    "id": 7,
    "content": "aaa456",
    "weibo_id": 2
  }
]
23:27:07 完整请求
23:27:07 请求结束
23:27:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:27:07 path and query /api/comment/add {} {"content":"ccc789","weibo_id":"3"}
23:27:07 kwargs,  {'weibo_id': 3} <class 'dict'>
23:27:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 6,
    "content": "ccc456",
    "weibo_id": 3
  },
  {
    "id": 8,
    "content": "ccc789",
    "weibo_id": 3
  }
]
23:27:09 完整请求
23:27:09 请求结束
23:27:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:27:09 path and query /weibo/index {} 
23:27:09 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:27:09 完整请求
23:27:09 完整请求
23:27:09 请求结束
23:27:09 请求结束
23:27:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:27:09 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:27:09 path and query /static {'file': 'weibo.js'} 
23:27:09 path and query /static {'file': 'gua.js'} 
23:27:09 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:27:09 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                //var comments = JSON.parse(r)
                //var comment_list = WeiboCell.querySelector('comment-list')
                //log("comment-list", comment-list)
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:27:10 完整请求
23:27:10 请求结束
23:27:10 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:27:10 path and query /api/weibo/all {} 
23:27:10 kwargs,  {'weibo_id': 2} <class 'dict'>
23:27:10 kwargs,  {'weibo_id': 3} <class 'dict'>
23:27:10 kwargs,  {'weibo_id': 4} <class 'dict'>
23:27:10 kwargs,  {'weibo_id': 5} <class 'dict'>
23:27:10 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc789",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 3,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": [
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 5
      },
      {
        "id": 5,
        "content": "aaa456",
        "weibo_id": 5
      }
    ]
  }
]
23:31:45 完整请求
23:31:45 请求结束
23:31:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:31:45 path and query /weibo/index {} 
23:31:45 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:31:45 完整请求
23:31:45 完整请求
23:31:45 请求结束
23:31:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:31:45 path and query /static {'file': 'weibo.js'} 
23:31:45 path and query /static {'file': 'gua.js'} 
23:31:45 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:31:45 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.querySelector('comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:31:45 完整请求
23:31:45 请求结束
23:31:45 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:31:45 path and query /api/weibo/all {} 
23:31:45 kwargs,  {'weibo_id': 2} <class 'dict'>
23:31:45 kwargs,  {'weibo_id': 3} <class 'dict'>
23:31:45 kwargs,  {'weibo_id': 4} <class 'dict'>
23:31:45 kwargs,  {'weibo_id': 5} <class 'dict'>
23:31:45 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc789",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 3,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": [
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 5
      },
      {
        "id": 5,
        "content": "aaa456",
        "weibo_id": 5
      }
    ]
  }
]
23:31:56 完整请求
23:31:56 请求结束
23:31:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:31:56 path and query /api/comment/add {} {"content":"aaa789","weibo_id":"2"}
23:31:56 kwargs,  {'weibo_id': 2} <class 'dict'>
23:31:56 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "bbb123",
    "weibo_id": 2
  },
  {
    "id": 7,
    "content": "aaa456",
    "weibo_id": 2
  },
  {
    "id": 9,
    "content": "aaa789",
    "weibo_id": 2
  }
]
23:31:56 完整请求
23:31:56 请求结束
23:31:56 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:31:56 path and query /static {'file': 'weibo.js'} 
23:31:56 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                var comment_list = WeiboCell.querySelector('comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:32:36 完整请求
23:32:36 请求结束
23:32:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:32:36 path and query /weibo/index {} 
23:32:36 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:32:36 完整请求
23:32:36 请求结束
23:32:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:32:36 path and query /static {'file': 'gua.js'} 
23:32:36 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:32:36 完整请求
23:32:36 请求结束
23:32:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:32:36 path and query /static {'file': 'weibo.js'} 
23:32:36 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                log("comments",comments)
                var comment_list = WeiboCell.querySelector('comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:32:36 完整请求
23:32:36 请求结束
23:32:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:32:36 path and query /api/weibo/all {} 
23:32:36 kwargs,  {'weibo_id': 2} <class 'dict'>
23:32:36 kwargs,  {'weibo_id': 3} <class 'dict'>
23:32:36 kwargs,  {'weibo_id': 4} <class 'dict'>
23:32:36 kwargs,  {'weibo_id': 5} <class 'dict'>
23:32:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 2
      },
      {
        "id": 9,
        "content": "aaa789",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc789",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 3,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": [
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 5
      },
      {
        "id": 5,
        "content": "aaa456",
        "weibo_id": 5
      }
    ]
  }
]
23:32:37 完整请求
23:32:37 请求结束
23:32:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:32:37 path and query /static {'file': 'weibo.js'} 
23:32:37 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                log("comments",comments)
                var comment_list = WeiboCell.querySelector('comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:33:02 完整请求
23:33:02 请求结束
23:33:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:33:02 path and query /api/comment/add {} {"content":"ddd456","weibo_id":"4"}
23:33:02 kwargs,  {'weibo_id': 4} <class 'dict'>
23:33:02 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 3,
    "content": "ddd123",
    "weibo_id": 4
  },
  {
    "id": 10,
    "content": "ddd456",
    "weibo_id": 4
  }
]
23:34:22 完整请求
23:34:22 请求结束
23:34:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:22 path and query /weibo/index {} 
23:34:22 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:34:22 完整请求
23:34:22 完整请求
23:34:22 请求结束
23:34:22 请求结束
23:34:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:22 path and query /static {'file': 'gua.js'} 

23:34:22 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:34:22 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:34:22 完整请求
23:34:22 请求结束
23:34:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:22 path and query /api/weibo/all {} 
23:34:22 kwargs,  {'weibo_id': 2} <class 'dict'>
23:34:23 kwargs,  {'weibo_id': 3} <class 'dict'>
23:34:23 kwargs,  {'weibo_id': 4} <class 'dict'>
23:34:23 kwargs,  {'weibo_id': 5} <class 'dict'>
23:34:23 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 1,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 2
      },
      {
        "id": 9,
        "content": "aaa789",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc789",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 3,
        "content": "ddd123",
        "weibo_id": 4
      },
      {
        "id": 10,
        "content": "ddd456",
        "weibo_id": 4
      }
    ]
  },
  {
    "id": 5,
    "content": "aaa",
    "comments": [
      {
        "id": 2,
        "content": "aaa123",
        "weibo_id": 5
      },
      {
        "id": 5,
        "content": "aaa456",
        "weibo_id": 5
      }
    ]
  }
]
23:34:23 完整请求
23:34:23 请求结束
23:34:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:23 path and query /static {'file': 'weibo.js'} 
23:34:23 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:34:34 完整请求
23:34:34 请求结束
23:34:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:34 path and query /api/comment/add {} {"content":"ddd789","weibo_id":"4"}
23:34:34 kwargs,  {'weibo_id': 4} <class 'dict'>
23:34:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 3,
    "content": "ddd123",
    "weibo_id": 4
  },
  {
    "id": 10,
    "content": "ddd456",
    "weibo_id": 4
  },
  {
    "id": 11,
    "content": "ddd789",
    "weibo_id": 4
  }
]
23:34:54 完整请求
23:34:54 请求结束
23:34:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:54 path and query /weibo/index {} 
23:34:54 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:34:54 完整请求
23:34:54 完整请求
23:34:54 请求结束
23:34:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:54 path and query /static {'file': 'weibo.js'} 
23:34:54 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()
23:34:54 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

23:34:55 完整请求
23:34:55 请求结束
23:34:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:55 path and query /api/weibo/all {} 
23:34:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
23:34:55 完整请求
23:34:55 请求结束
23:34:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:55 path and query /static {'file': 'weibo.js'} 
23:34:55 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:34:57 完整请求
23:34:57 请求结束
23:34:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:34:57 path and query /api/weibo/add {} {"content":"aaa"}
23:34:57 kwargs,  {'weibo_id': 1} <class 'dict'>
23:34:57 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
23:35:02 完整请求
23:35:02 请求结束
23:35:02 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:02 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
23:35:02 kwargs,  {'weibo_id': 1} <class 'dict'>
23:35:02 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  }
]
23:35:07 完整请求
23:35:07 请求结束
23:35:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:07 path and query /api/comment/add {} {"content":"aaa456","weibo_id":"1"}
23:35:07 kwargs,  {'weibo_id': 1} <class 'dict'>
23:35:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  }
]
23:35:11 完整请求
23:35:11 请求结束
23:35:11 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:11 path and query /api/weibo/add {} {"content":"bbb"}
23:35:11 kwargs,  {'weibo_id': 2} <class 'dict'>
23:35:11 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "bbb",
  "comments": []
}
23:35:16 完整请求
23:35:16 请求结束
23:35:16 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:16 path and query /api/comment/add {} {"content":"bbb123","weibo_id":"2"}
23:35:16 kwargs,  {'weibo_id': 2} <class 'dict'>
23:35:16 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 3,
    "content": "bbb123",
    "weibo_id": 2
  }
]
23:35:19 完整请求
23:35:19 请求结束
23:35:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:19 path and query /api/weibo/add {} {"content":"ccc"}
23:35:19 kwargs,  {'weibo_id': 3} <class 'dict'>
23:35:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
23:35:23 完整请求
23:35:23 请求结束
23:35:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:23 path and query /api/comment/add {} {"content":"ccc123","weibo_id":"3"}
23:35:23 kwargs,  {'weibo_id': 3} <class 'dict'>
23:35:23 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  }
]
23:35:29 完整请求
23:35:29 请求结束
23:35:29 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:29 path and query /api/weibo/add {} {"content":"ddd"}
23:35:29 kwargs,  {'weibo_id': 4} <class 'dict'>
23:35:29 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "ddd",
  "comments": []
}
23:35:36 完整请求
23:35:36 请求结束
23:35:36 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:36 path and query /api/comment/add {} {"content":"ccc456","weibo_id":"3"}
23:35:36 kwargs,  {'weibo_id': 3} <class 'dict'>
23:35:36 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  }
]
23:35:42 完整请求
23:35:42 请求结束
23:35:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:42 path and query /api/comment/add {} {"content":"ccc778","weibo_id":"3"}
23:35:42 kwargs,  {'weibo_id': 3} <class 'dict'>
23:35:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  },
  {
    "id": 6,
    "content": "ccc778",
    "weibo_id": 3
  }
]
23:35:46 完整请求
23:35:46 请求结束
23:35:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:46 path and query /api/comment/add {} {"content":"bbb456","weibo_id":"2"}
23:35:46 kwargs,  {'weibo_id': 2} <class 'dict'>
23:35:46 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 3,
    "content": "bbb123",
    "weibo_id": 2
  },
  {
    "id": 7,
    "content": "bbb456",
    "weibo_id": 2
  }
]
23:35:51 完整请求
23:35:51 请求结束
23:35:51 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:51 path and query /api/comment/add {} {"content":"aaa789","weibo_id":"1"}
23:35:51 kwargs,  {'weibo_id': 1} <class 'dict'>
23:35:51 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  },
  {
    "id": 8,
    "content": "aaa789",
    "weibo_id": 1
  }
]
23:35:55 完整请求
23:35:55 请求结束
23:35:55 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:35:55 path and query /api/comment/add {} {"content":"ddd123","weibo_id":"4"}
23:35:55 kwargs,  {'weibo_id': 4} <class 'dict'>
23:35:55 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 9,
    "content": "ddd123",
    "weibo_id": 4
  }
]
23:36:17 完整请求
23:36:17 请求结束
23:36:17 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:17 path and query /api/weibo/update {} {"id":"1","content":"aaa123"}
23:36:17 kwargs,  {'id': 1} <class 'dict'>
23:36:17 debug 0
23:36:17 kwargs,  {'weibo_id': 1} <class 'dict'>
23:36:17 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa123",
  "comments": [
    {
      "id": 1,
      "content": "aaa123",
      "weibo_id": 1
    },
    {
      "id": 2,
      "content": "aaa456",
      "weibo_id": 1
    },
    {
      "id": 8,
      "content": "aaa789",
      "weibo_id": 1
    }
  ]
}
23:36:42 完整请求
23:36:42 请求结束
23:36:42 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:42 path and query /api/weibo/update {} {"id":"1","content":"aaa"}
23:36:42 kwargs,  {'id': 1} <class 'dict'>
23:36:42 debug 0
23:36:42 kwargs,  {'weibo_id': 1} <class 'dict'>
23:36:42 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": [
    {
      "id": 1,
      "content": "aaa123",
      "weibo_id": 1
    },
    {
      "id": 2,
      "content": "aaa456",
      "weibo_id": 1
    },
    {
      "id": 8,
      "content": "aaa789",
      "weibo_id": 1
    }
  ]
}
23:36:57 完整请求
23:36:57 请求结束
23:36:57 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:57 path and query /weibo/index {} 
23:36:57 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
23:36:58 完整请求
23:36:58 完整请求
23:36:58 请求结束
23:36:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:58 path and query /static {'file': 'gua.js'} 

23:36:58 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




// Comment
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}
23:36:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

23:36:58 完整请求
23:36:58 请求结束
23:36:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:58 path and query /api/weibo/all {} 
23:36:58 kwargs,  {'weibo_id': 1} <class 'dict'>
23:36:58 kwargs,  {'weibo_id': 2} <class 'dict'>
23:36:58 kwargs,  {'weibo_id': 3} <class 'dict'>
23:36:58 kwargs,  {'weibo_id': 4} <class 'dict'>
23:36:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 8,
        "content": "aaa789",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 3,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc778",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 9,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  }
]
23:36:58 完整请求
23:36:58 请求结束
23:36:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
23:36:58 path and query /static {'file': 'weibo.js'} 
23:36:58 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div>
                ${c.content}
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    // bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:27:34 完整请求
00:27:34 请求结束
00:27:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:27:34 path and query /weibo/index {} 
00:27:34 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
00:27:35 完整请求
00:27:35 完整请求
00:27:35 请求结束
00:27:35 请求结束
rm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:27:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:27:35 path and query /static {'file': 'gua.js'} 
00:27:35 path and query /static {'file': 'weibo.js'} 
00:27:35 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
00:27:35 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">{c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:27:35 完整请求
00:27:35 请求结束
00:27:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:27:35 path and query /api/weibo/all {} 
00:27:35 kwargs,  {'weibo_id': 1} <class 'dict'>
00:27:35 kwargs,  {'weibo_id': 2} <class 'dict'>
00:27:35 kwargs,  {'weibo_id': 3} <class 'dict'>
00:27:35 kwargs,  {'weibo_id': 4} <class 'dict'>
00:27:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 8,
        "content": "aaa789",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 3,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc778",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 9,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  }
]
00:27:35 完整请求
00:27:35 请求结束
00:27:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:27:35 path and query /static {'file': 'weibo.js'} 
00:27:35 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">{c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:28:13 完整请求
00:28:13 请求结束
00:28:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:13 path and query /weibo/index {} 
00:28:13 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: blue;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
00:28:13 完整请求
00:28:13 请求结束
00:28:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:13 path and query /static {'file': 'gua.js'} 
00:28:13 完整请求
00:28:13 请求结束
00:28:13 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
00:28:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:13 path and query /static {'file': 'weibo.js'} 
00:28:13 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:28:13 完整请求
00:28:13 请求结束
00:28:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:13 path and query /api/weibo/all {} 
00:28:13 完整请求
00:28:13 请求结束
00:28:13 kwargs,  {'weibo_id': 1} <class 'dict'>
00:28:13 kwargs,  {'weibo_id': 2} <class 'dict'>
00:28:13 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:13 kwargs,  {'weibo_id': 3} <class 'dict'>
00:28:13 path and query /static {'file': 'weibo.js'} 
00:28:13 kwargs,  {'weibo_id': 4} <class 'dict'>
00:28:13 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:28:13 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 2,
        "content": "aaa456",
        "weibo_id": 1
      },
      {
        "id": 8,
        "content": "aaa789",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 3,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 6,
        "content": "ccc778",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 9,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  }
]
00:28:24 完整请求
00:28:24 请求结束
00:28:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:24 path and query /api/comment/delete {'id': '6'} 
00:28:24 kwargs,  {'weibo_id': 3} <class 'dict'>
00:28:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  }
]
00:28:33 完整请求
00:28:33 请求结束
00:28:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:33 path and query /api/comment/delete {'id': '8'} 
00:28:33 kwargs,  {'weibo_id': 1} <class 'dict'>
00:28:33 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  }
]
00:28:46 完整请求
00:28:46 请求结束
00:28:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:46 path and query /api/comment/delete {'id': '1'} 
00:28:46 kwargs,  {'weibo_id': 1} <class 'dict'>
00:28:46 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "aaa456",
    "weibo_id": 1
  }
]
00:28:53 完整请求
00:28:53 请求结束
00:28:53 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:28:53 path and query /api/comment/delete {'id': '2'} 
00:28:53 kwargs,  {'weibo_id': 1} <class 'dict'>
00:28:53 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
00:30:39 完整请求
00:30:39 请求结束
00:30:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:30:39 path and query /weibo/index {} 
00:30:39 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: greenyellow;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
00:30:39 完整请求
00:30:39 请求结束
00:30:39 完整请求
00:30:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:30:39 path and query /static {'file': 'gua.js'} 
00:30:39 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
00:30:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:30:39 path and query /static {'file': 'weibo.js'} 
00:30:39 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:30:39 完整请求
00:30:39 请求结束
00:30:39 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:30:39 path and query /api/weibo/all {} 
00:30:39 kwargs,  {'weibo_id': 1} <class 'dict'>
00:30:39 kwargs,  {'weibo_id': 2} <class 'dict'>
00:30:40 kwargs,  {'weibo_id': 3} <class 'dict'>
00:30:40 kwargs,  {'weibo_id': 4} <class 'dict'>
00:30:40 完整请求
00:30:40 请求结束
00:30:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": []
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 3,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 7,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "ddd",
    "comments": [
      {
        "id": 9,
        "content": "ddd123",
        "weibo_id": 4
      }
    ]
  }
]
00:30:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:30:40 path and query /static {'file': 'weibo.js'} 
00:30:40 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

00:32:18 完整请求
00:32:18 请求结束
00:32:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:19 path and query /api/weibo/delete {'id': '1'} 
00:32:19 kwargs,  {'weibo_id': 1} <class 'dict'>
00:32:19 kwargs,  {'weibo_id': 1} <class 'dict'>
00:32:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
00:32:19 完整请求
00:32:19 请求结束
00:32:19 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:19 path and query /api/weibo/delete {'id': '2'} 
00:32:19 kwargs,  {'weibo_id': 2} <class 'dict'>
00:32:19 kwargs,  {'weibo_id': 2} <class 'dict'>
00:32:19 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "bbb",
  "comments": []
}
00:32:20 完整请求
00:32:20 请求结束
00:32:20 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:20 path and query /api/weibo/delete {'id': '3'} 
00:32:20 kwargs,  {'weibo_id': 3} <class 'dict'>
00:32:20 kwargs,  {'weibo_id': 3} <class 'dict'>
00:32:20 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
00:32:20 完整请求
00:32:21 请求结束
00:32:21 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:21 path and query /api/weibo/delete {'id': '4'} 
00:32:21 kwargs,  {'weibo_id': 4} <class 'dict'>
00:32:21 kwargs,  {'weibo_id': 4} <class 'dict'>
00:32:21 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "ddd",
  "comments": []
}
00:32:24 完整请求
00:32:24 请求结束
00:32:24 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:24 path and query /api/weibo/add {} {"content":"aaa"}
00:32:24 kwargs,  {'weibo_id': 1} <class 'dict'>
00:32:24 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 1,
  "content": "aaa",
  "comments": []
}
00:32:30 完整请求
00:32:30 请求结束
00:32:30 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:30 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
00:32:30 kwargs,  {'weibo_id': 1} <class 'dict'>
00:32:30 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  }
]
00:32:32 完整请求
00:32:32 请求结束
00:32:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:32 path and query /api/comment/delete {'id': '1'} 
00:32:32 kwargs,  {'weibo_id': 1} <class 'dict'>
00:32:32 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[]
00:32:34 完整请求
00:32:34 请求结束
00:32:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:34 path and query /api/comment/add {} {"content":"aaa123","weibo_id":"1"}
00:32:34 kwargs,  {'weibo_id': 1} <class 'dict'>
00:32:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  }
]
00:32:40 完整请求
00:32:40 请求结束
00:32:40 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:40 path and query /api/weibo/add {} {"content":"bbb"}
00:32:40 kwargs,  {'weibo_id': 2} <class 'dict'>
00:32:40 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 2,
  "content": "bbb",
  "comments": []
}
00:32:46 完整请求
00:32:46 请求结束
00:32:46 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:46 path and query /api/weibo/add {} {"content":"ccc"}
00:32:46 kwargs,  {'weibo_id': 3} <class 'dict'>
00:32:46 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 3,
  "content": "ccc",
  "comments": []
}
00:32:54 完整请求
00:32:54 请求结束
00:32:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:54 path and query /api/comment/add {} {"content":"bbb123","weibo_id":"2"}
00:32:54 kwargs,  {'weibo_id': 2} <class 'dict'>
00:32:54 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb123",
    "weibo_id": 2
  }
]
00:32:59 完整请求
00:32:59 请求结束
00:32:59 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:32:59 path and query /api/comment/add {} {"content":"bbb456","weibo_id":"2"}
00:32:59 kwargs,  {'weibo_id': 2} <class 'dict'>
00:32:59 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "content": "bbb123",
    "weibo_id": 2
  },
  {
    "id": 3,
    "content": "bbb456",
    "weibo_id": 2
  }
]
00:33:05 完整请求
00:33:05 请求结束
00:33:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:33:05 path and query /api/comment/add {} {"content":"ccc123","weibo_id":"3"}
00:33:05 kwargs,  {'weibo_id': 3} <class 'dict'>
00:33:05 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  }
]
00:33:12 完整请求
00:33:12 请求结束
00:33:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:33:12 path and query /api/comment/add {} {"content":"ccc456","weibo_id":"3"}
00:33:12 kwargs,  {'weibo_id': 3} <class 'dict'>
00:33:12 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  }
]
00:33:18 完整请求
00:33:18 请求结束
00:33:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:33:18 path and query /api/comment/add {} {"content":"ccc789","weibo_id":"3"}
00:33:18 kwargs,  {'weibo_id': 3} <class 'dict'>
00:33:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  },
  {
    "id": 6,
    "content": "ccc789",
    "weibo_id": 3
  }
]
00:33:25 完整请求
00:33:25 请求结束
00:33:25 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:33:25 path and query /api/comment/add {} {"content":"aaa456","weibo_id":"1"}
00:33:25 kwargs,  {'weibo_id': 1} <class 'dict'>
00:33:25 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa123",
    "weibo_id": 1
  },
  {
    "id": 7,
    "content": "aaa456",
    "weibo_id": 1
  }
]
00:33:32 完整请求
00:33:32 请求结束
00:33:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:33:32 path and query /api/comment/delete {'id': '6'} 
00:33:32 kwargs,  {'weibo_id': 3} <class 'dict'>
00:33:32 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  }
]
00:33:37 完整请求
00:33:37 请求结束
00:33:37 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce']
00:33:37 path and query /api/comment/add {} {"content":"ccc788","weibo_id":"3"}
00:33:37 kwargs,  {'weibo_id': 3} <class 'dict'>
00:33:37 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  },
  {
    "id": 8,
    "content": "ccc788",
    "weibo_id": 3
  }
]
15:01:05 完整请求
15:01:05 请求结束
15:01:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:05 path and query / {} 
15:01:05 响应
 HTTP/1.1 302 OK
Content-Type: text/html
Location: /todo/index


15:01:05 完整请求
15:01:05 请求结束
15:01:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:05 path and query /todo/index {} 
15:01:05 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
15:01:05 完整请求
15:01:05 完整请求
15:01:05 请求结束
15:01:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:05 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:05 path and query /static {'file': 'gua.js'} 
15:01:05 path and query /static {'file': 'todo.js'} 
15:01:05 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:01:05 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
            })
            // 如果上面的update成功，就把editForm这个div干掉
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
15:01:05 完整请求
15:01:06 请求结束
15:01:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:06 path and query /api/todo/all {} 
15:01:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "title": "456",
    "completed": false,
    "ct": 1520698729,
    "ut": 1520698729
  },
  {
    "id": 3,
    "title": "啊实打实",
    "completed": false,
    "ct": 1520698733,
    "ut": 1520699101
  }
]
15:01:15 完整请求
15:01:15 请求结束
15:01:15 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:15 path and query /api/todo/add {} {"title":"123"}
15:01:22 完整请求
15:01:22 完整请求
15:01:22 请求结束
15:01:22 请求结束
15:01:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:22 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:22 path and query /api/todo/add {} {"title":"123"}
15:01:22 path and query /api/todo/add {} {"title":"123"}
15:01:34 完整请求
15:01:34 请求结束
15:01:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:34 path and query /weibo/index {} 
15:01:34 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: greenyellow;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:01:34 完整请求
15:01:34 请求结束
15:01:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:34 path and query /static {'file': 'weibo.js'} 
15:01:34 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:01:34 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:01:34 完整请求
15:01:35 请求结束
15:01:35 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:35 path and query /api/weibo/all {} 
15:01:35 kwargs,  {'weibo_id': 1} <class 'dict'>
15:01:35 kwargs,  {'weibo_id': 2} <class 'dict'>
15:01:35 kwargs,  {'weibo_id': 3} <class 'dict'>
15:01:35 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 2,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 3,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc788",
        "weibo_id": 3
      }
    ]
  }
]
15:01:58 完整请求
15:01:58 请求结束
15:01:58 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:01:58 path and query /api/weibo/add {} {"content":"再次测试一下"}
15:01:58 kwargs,  {'weibo_id': 4} <class 'dict'>
15:01:58 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 4,
  "content": "再次测试一下",
  "comments": []
}
15:02:03 完整请求
15:02:03 请求结束
15:02:03 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:02:03 path and query /api/comment/add {} {"content":"123","weibo_id":"4"}
15:02:03 kwargs,  {'weibo_id': 4} <class 'dict'>
15:02:03 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 9,
    "content": "123",
    "weibo_id": 4
  }
]
15:02:06 完整请求
15:02:06 请求结束
15:02:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:02:06 path and query /api/comment/add {} {"content":"456","weibo_id":"4"}
15:02:06 kwargs,  {'weibo_id': 4} <class 'dict'>
15:02:06 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 9,
    "content": "123",
    "weibo_id": 4
  },
  {
    "id": 10,
    "content": "456",
    "weibo_id": 4
  }
]
15:03:18 完整请求
15:03:18 请求结束
15:03:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:18 path and query /weibo/index {} 
15:03:18 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: greenyellow;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:03:18 完整请求
15:03:18 完整请求
15:03:18 请求结束
15:03:18 请求结束
15:03:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:18 path and query /static {'file': 'weibo.js'} 
15:03:18 path and query /static {'file': 'gua.js'} 
15:03:18 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:03:18 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:03:18 完整请求
15:03:18 请求结束
15:03:18 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:18 path and query /api/weibo/all {} 
15:03:18 kwargs,  {'weibo_id': 1} <class 'dict'>
15:03:18 kwargs,  {'weibo_id': 2} <class 'dict'>
15:03:18 kwargs,  {'weibo_id': 3} <class 'dict'>
15:03:18 kwargs,  {'weibo_id': 4} <class 'dict'>
15:03:18 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 2,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 3,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc788",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "再次测试一下",
    "comments": [
      {
        "id": 9,
        "content": "123",
        "weibo_id": 4
      },
      {
        "id": 10,
        "content": "456",
        "weibo_id": 4
      }
    ]
  }
]
15:03:40 完整请求
15:03:40 请求结束
15:03:41 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:41 path and query /todo {} 
15:03:41 响应
 HTTP/1.1 404 NOT FOUND

<h1>NOT FOUND</h1>
15:03:47 完整请求
15:03:47 请求结束
15:03:47 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:47 path and query /todo/index {} 
15:03:47 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
15:03:48 完整请求
15:03:48 完整请求
15:03:49 请求结束
15:03:49 请求结束
15:03:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:49 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:49 path and query /static {'file': 'todo.js'} 
15:03:49 path and query /static {'file': 'gua.js'} 
15:03:50 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:03:50 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
            })
            // 如果上面的update成功，就把editForm这个div干掉
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
15:03:50 完整请求
15:03:50 请求结束
15:03:50 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:50 path and query /api/todo/all {} 
15:03:50 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "title": "456",
    "completed": false,
    "ct": 1520698729,
    "ut": 1520698729
  },
  {
    "id": 3,
    "title": "啊实打实",
    "completed": false,
    "ct": 1520698733,
    "ut": 1520699101
  },
  {
    "id": 4,
    "title": "123",
    "completed": false,
    "ct": 1521010875,
    "ut": 1521010875
  },
  {
    "id": 5,
    "title": "123",
    "completed": false,
    "ct": 1521010882,
    "ut": 1521010882
  }
]
15:03:54 完整请求
15:03:54 请求结束
15:03:54 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:03:54 path and query /api/todo/add {} {"title":"456"}
15:04:12 完整请求
15:04:12 完整请求
15:04:12 请求结束
15:04:12 请求结束
15:04:12 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:12 path and query /api/todo/add {} {"title":"456"}
15:04:12 path and query /api/todo/add {} {"title":"456"}
15:04:23 完整请求
15:04:23 请求结束
15:04:23 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:23 path and query /static {'file': 'todo.js'} 
15:04:23 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
            })
            // 如果上面的update成功，就把editForm这个div干掉
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
15:04:32 完整请求
15:04:32 请求结束
15:04:32 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:32 path and query /todo/index {} 
15:04:32 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>web10 todo ajax</title>
    </head>
    <body>
        <input id='id-input-todo'>
        <button id='id-button-add'>add</button>
        <div class="todo-list">
        </div>
        <!-- 这是我们处理静态文件的套路 -->
        <!-- gua.js 放了公共的函数 -->
        <!-- 按顺序引入 2 个 js 文件, 后面的 js 文件就能使用前面的文件中的函数了 -->
        <script src='/static?file=gua.js'></script>
        <script src='/static?file=todo.js'></script>
    </body>
</html>
15:04:33 完整请求
15:04:33 完整请求
15:04:33 请求结束
15:04:33 请求结束
15:04:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:33 path and query /static {'file': 'todo.js'} 
15:04:33 path and query /static {'file': 'gua.js'} 
15:04:33 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:04:33 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
            })
            // 如果上面的update成功，就把editForm这个div干掉
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
15:04:33 完整请求
15:04:33 请求结束
15:04:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:33 path and query /api/todo/all {} 
15:04:33 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 2,
    "title": "456",
    "completed": false,
    "ct": 1520698729,
    "ut": 1520698729
  },
  {
    "id": 3,
    "title": "啊实打实",
    "completed": false,
    "ct": 1520698733,
    "ut": 1520699101
  },
  {
    "id": 4,
    "title": "123",
    "completed": false,
    "ct": 1521010875,
    "ut": 1521010875
  },
  {
    "id": 5,
    "title": "123",
    "completed": false,
    "ct": 1521010882,
    "ut": 1521010882
  },
  {
    "id": 6,
    "title": "456",
    "completed": false,
    "ct": 1521011034,
    "ut": 1521011034
  },
  {
    "id": 7,
    "title": "456",
    "completed": false,
    "ct": 1521011052,
    "ut": 1521011052
  }
]
15:04:33 完整请求
15:04:33 请求结束
15:04:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:04:33 path and query /static {'file': 'todo.js'} 
15:04:33 响应
 HTTP/1.1 200 OK

var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var todoTemplate = function(todo) {
    var title = todo.title
    var id = todo.id
    var ut = timeString(todo.ut)
    // data-xx 是自定义标签属性的语法
    // 通过这样的方式可以给任意标签添加任意属性
    // 假设 d 是 这个 div 的引用
    // 这样的自定义属性通过  d.dataset.xx 来获取
    // 在这个例子里面, 是 d.dataset.id
    var t = `
        <div class="todo-cell" id='todo-${id}' data-id="${id}">
            <button class="todo-edit">编辑</button>
            <button class="todo-delete">删除</button>
            <span class='todo-title'>${title}</span>
            <time class='todo-ut'>${ut}</time>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="todo-cell">
        <button class="todo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(todo)
    */
}

var insertTodo = function(todo) {
    var todoCell = todoTemplate(todo)
    // 把todoCell 插入 todo-list
    var todoList = e('.todo-list') //找到已有的todolist，把新按钮所在的div挂在.todo-list下
    todoList.insertAdjacentHTML('beforeend', todoCell)
}

var insertEditForm = function(cell) {
    var form = `
        <div class='todo-edit-form'>
            <input class="todo-edit-input">
            <button class='todo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadTodos = function() {
    // 调用 ajax api 来载入数据
    apiTodoAll(function(r) { //r接收实参{这个实参来自服务器的响应,其定义见gua.js中对回调函数输入的实参}
        // console.log('load all', r)
        // 解析为 数组
        var todos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i < todos.length; i++) {
            var todo = todos[i]
            insertTodo(todo)
        }
    })
}

var bindEventTodoAdd = function() { //编写事件监听器
    var b = e('#id-button-add')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-todo')
        var title = input.value
        log('click add', title)
        var form = {
            'title': title,
        }
        apiTodoAdd(form, function(r) { //定义回调函数，并作为参数传入gua.js中定义的API中
            // 收到返回的数据, 插入到页面中
            var todo = JSON.parse(r)
            insertTodo(todo)
        })
    })
}

var bindEventTodoDelete = function() { //和bindEventTodoAdd的逻辑刚刚相反
    var todoList = e('.todo-list') //当时add一个todo的div时，就是挂在.todo-list下,所以现在删也是要到.todo-list
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ //事件监听委托给 爷爷节点 todoList
        var self = event.target //找到click动作的目标位置 {即要找到删除按钮}，因为这个按钮的父亲是todo{一个div},todo的父亲是todo-list{也是一个div}
        if(self.classList.contains('todo-delete')){ //找到删除按钮了
            // 删除这个 todo
            var todoCell = self.parentElement // 其实是要删除“删除按钮”所在的那个todo{即一个div}
            var todo_id = todoCell.dataset.id //但是add一个todo的div时，曾经自定义了一个data-id属性，现在从这个属性中取到当时add时存的值
            apiTodoDelete(todo_id, function(r){ //又去gua.js中调用ajax(),发送删除的HTTP请求到服务器
                log('删除成功', todo_id)
                todoCell.remove() //把这个todo从本地浏览器的静态页上删除掉
            })
        }
    })
}

var bindEventTodoEdit = function() {
    var todoList = e('.todo-list')
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){ // 又是把监听事件委托给了爷爷todolist
        var self = event.target
        if(self.classList.contains('todo-edit')){ //找到了"编辑按钮"
            var todoCell = self.parentElement //找到 "编辑按钮"的父亲{某一个todo,本质是一个div}
            insertEditForm(todoCell) //把一个用于编辑的div插入到todoCell最末尾{让其紧跟着这个待编辑的todo}
        }
    })
}


var bindEventTodoUpdate = function() {
    var todoList = e('.todo-list') // 又是委托{这个静态页面中恒存在的div}来监听事件
    // 注意, 第二个参数可以直接给出定义函数
    todoList.addEventListener('click', function(event){
        var self = event.target //当前被点击的对象
        if(self.classList.contains('todo-update')){ // 找到了“update按钮”
            log('点击了 update ')
            //
            var editForm = self.parentElement //拿到整个editForm
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.todo-edit-input') //找到editForm中的input框
            var title = input.value
            // 用 closest 方法可以找到最近的直系祖先
            var todoCell = self.closest('.todo-cell') // 找到“update按钮”最近的一个class名为.todo-cell的祖先
            var todo_id = todoCell.dataset.id // 从这个to中拿到自定义data-id的值
            var form = {
                'id': todo_id,
                'title': title,
            }
            apiTodoUpdate(form, function(r){ // 拿form去调用ajax()在服务器上更新上面那个todo,以及即将执行下面的回调函数
                log('更新成功', todo_id)
                var todo = JSON.parse(r) //解析apiTodoUpdate后得到的HTTP响应
                var selector = '#todo-' + todo.id //根据最开始{add todo} 时定义的id属性来
                var todoCell = e(selector)        //找需要更新的todo
                var titleSpan = todoCell.querySelector('.todo-title') //根据 这个todo的 {'.todo-title'的这个class属性}去找这个todo的一个子节点
                titleSpan.innerHTML = todo.title //更新titleSpan的内嵌的html内容，同理可以修改17行的${ut}
            })
            // 如果上面的update成功，就把editForm这个div干掉
            editForm.remove()
        }
    })
}

var bindEvents = function() {
    bindEventTodoAdd()
    bindEventTodoDelete()
    bindEventTodoEdit()
    bindEventTodoUpdate()
}

var __main = function() {
    bindEvents()
    loadTodos()
}

__main()


// 例如下图，待会儿在blog中逐个解释每一个CURD背后的逻辑和流程到底是怎样的？
// 可以很好地梳理清楚js和ajax的运行过程及效果

/*
给 删除 按钮绑定删除的事件
1, 绑定事件
2, 删除整个 todo-cell 元素
*/
// var todoList = e('.todo-list')
// // 事件响应函数会被传入一个参数, 就是事件本身
// todoList.addEventListener('click', function(event){
//     // log('click todolist', event)
//     // 我们可以通过 event.target 来得到被点击的元素
//     var self = event.target
//     // log('被点击的元素是', self)
//     // 通过比较被点击元素的 class 来判断元素是否是我们想要的
//     // classList 属性保存了元素的所有 class
//     // 在 HTML 中, 一个元素可以有多个 class, 用空格分开
//     // log(self.classList)
//     // 判断是否拥有某个 class 的方法如下
//     if (self.classList.contains('todo-delete')) {
//         log('点到了 删除按钮')
//         // 删除 self 的父节点
//         // parentElement 可以访问到元素的父节点
//         self.parentElement.remove()
//     } else {
//         // log('点击的不是删除按钮******')
//     }
// })
15:05:06 完整请求
15:05:06 请求结束
15:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:06 path and query /weibo/index {} 
15:05:06 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: greenyellow;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:05:06 完整请求
15:05:06 完整请求
15:05:06 请求结束
15:05:06 请求结束
15:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:06 path and query /static {'file': 'weibo.js'} 
15:05:06 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:06 path and query /static {'file': 'gua.js'} 
15:05:06 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:05:06 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:05:07 完整请求
15:05:07 请求结束
15:05:07 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:07 path and query /api/weibo/all {} 
15:05:07 kwargs,  {'weibo_id': 1} <class 'dict'>
15:05:07 kwargs,  {'weibo_id': 2} <class 'dict'>
15:05:07 kwargs,  {'weibo_id': 3} <class 'dict'>
15:05:07 kwargs,  {'weibo_id': 4} <class 'dict'>
15:05:07 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 2,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 3,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 8,
        "content": "ccc788",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "再次测试一下",
    "comments": [
      {
        "id": 9,
        "content": "123",
        "weibo_id": 4
      },
      {
        "id": 10,
        "content": "456",
        "weibo_id": 4
      }
    ]
  }
]
15:05:14 完整请求
15:05:14 请求结束
15:05:14 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:14 path and query /api/comment/delete {'id': '8'} 
15:05:14 kwargs,  {'weibo_id': 3} <class 'dict'>
15:05:14 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  }
]
15:05:27 完整请求
15:05:27 请求结束
15:05:27 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:27 path and query /api/comment/add {} {"content":"ccc789","weibo_id":"3"}
15:05:27 kwargs,  {'weibo_id': 3} <class 'dict'>
15:05:27 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 4,
    "content": "ccc123",
    "weibo_id": 3
  },
  {
    "id": 5,
    "content": "ccc456",
    "weibo_id": 3
  },
  {
    "id": 11,
    "content": "ccc789",
    "weibo_id": 3
  }
]
15:05:33 完整请求
15:05:33 请求结束
15:05:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:33 path and query /weibo/index {} 
15:05:33 响应
 HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weibo</title>
    <style>
        .weibo-content{
            background: red;
        }
        .comment {
            border: 1px black solid;
        }
        .comment-list {
            background: greenyellow;
        }
    </style>
</head>
<body>
    <div>
        <input id="id-input-weibo">
        <button id="id-button-add-weibo">发表微博</button>
    </div>
    <div class="weibo-list gua-auto-list">
         <!-- 下面是xjm教我html可以自定义标签放入上面的div, 然后可以自定义更加好的ajax() -->
         <!--data-method="get"-->
         <!--data-path="/api/weibo/all"-->
         <!--data-template="xxtemplate"-->

        <!--- 待会儿把新增的weibo及其评论封装成weibocell插入到weibo-list中 -->

        <div class="comment">  <!--  待会儿把新增的评论封装成comment-list插入到comment中-->
        </div>
        <!--<div class="comment-form">-->
            <!--<input type="hidden" id="comment-weibo_id" value="${id}">-->
            <!--<input id="comment-content">-->
            <!--<br>-->
            <!--<button class="comment-add">添加评论</button>-->
        <!--</div>-->
    </div>
    <script src='/static?file=gua.js'></script>
    <script src='/static?file=weibo.js'></script>


</body>
</html>
15:05:33 完整请求
15:05:33 完整请求
15:05:33 请求结束
15:05:33 请求结束
15:05:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:33 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:33 path and query /static {'file': 'gua.js'} 
15:05:33 path and query /static {'file': 'weibo.js'} 
15:05:33 响应
 HTTP/1.1 200 OK

﻿var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleTimeString()
    return t
}

var commentsTemplate = function(comments) {
    var html = ''
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var t = `
            <div class="comment-div" data-id=${c.id}>
                <div class="comment-div-content">${c.content}</div>
                <button class="comment-div-delete">删除</button>
            </div>
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        <div class='weibo-cell' id="weibo-${id}" data-id=${id} data-content="${content}">
            <div class="weibo-content">
                [WEIBO]:${content}
            </div>
            <button class="weibo-delete">删除weibo</button>
            <button class="weibo-edit">修改weibo</button>
            
            <div class="comment-list"> 
                ${comments}
            </div>
            <div class="comment-form">
                <input type="hidden" id="comment-weibo-id" value=${id}>
                <input id="comment-content">
                <br>
                <button class="comment-add">添加评论</button>
            </div>
        </div>
    `
    return t
    /*
    上面的写法在 python 中是这样的
    t = """
    <div class="Weibo-cell">
        <button class="Weibo-delete">删除</button>
        <span>{}</span>
    </div>
    """.format(Weibo)
    */
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    var WeiboList = e('.weibo-list') // 找到静态页中写固定了的Weibo-list
    WeiboList.insertAdjacentHTML('beforeend', WeiboCell) //把WeiboCell挂在Weibo-list中
}

var insertEditForm = function(cell) {
    var content = cell.dataset.content //得到content
    var form = `
        <div class='weibo-edit-form'>
            <input class="weibo-edit-input" value="${content}">  
            <button class='weibo-update'>更新</button>
        </div>
    `
    cell.insertAdjacentHTML('beforeend', form)
}

var loadWeibos = function() {
    // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log('load all', r)
        // 解析为 数组
        var Weibos = JSON.parse(r) //当前得到的Weibos是添加了comments后的Weibos
        // 循环添加到页面中
        for(var i = 0; i < Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}


var bindEventWeiboAdd = function() {
    var b = e('#id-button-add-weibo')
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener('click', function(){
        var input = e('#id-input-weibo')
        var content = input.value
        var form = {
            'content': content,
        }
        apiWeiboAdd(form, function(r) {
            // 收到返回的数据, 插入到页面中
            var Weibo = JSON.parse(r)
            insertWeibo(Weibo)
        })
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('weibo-delete')){
            // 删除这个 Weibo及其评论
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            apiWeiboDelete(Weibo_id, function(r){
                log('删除成功', Weibo_id)
                WeiboCell.remove()
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-edit')){
            var WeiboCell = self.parentElement
            insertEditForm(WeiboCell)
            // WeiboCell.style.display= "none" //让当前这个WeiboCell不显示;本html的布局方式有问题，需要
            //重写，然后才能简单的实现WeiboCell的部分内容不显示；暂时不处理这个。
        }
    })
}


var bindEventWeiboUpdate = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        if(self.classList.contains('weibo-update')){
            log('点击了 update ')
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector('.weibo-edit-input')
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest('.weibo-cell')
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                'id': Weibo_id,
                'content': content,
            }
            apiWeiboUpdate(form, function(r){
                log('更新成功', Weibo_id)
                var Weibo = JSON.parse(r)
                var selector = '#weibo-' + Weibo.id
                var WeiboCell = e(selector)
                var titleSpan = WeiboCell.querySelector('.weibo-content')
                titleSpan.innerHTML = Weibo.content
                //WeiboCell.style.display= "block" //让当前这个WeiboCell显示 {暂时不管这个功能 }
            })
            editForm.remove()
        }
    })
}


var bindEventCommentAdd = function() {
    var WeiboList = e('.weibo-list') //第一次只能找静态页中固定存在的节点
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        var comment_form = self.parentElement
        var WeiboCell = comment_form.parentElement // 只局部更新当前这个WeiboCell
        //log("CommentAdd, WeiboCell,",WeiboCell)
        if (self.classList.contains('comment-add')){
            // var input = e('#comment-content') //这种获取元素的方法错了，因为不能唯一。
            var input = comment_form.querySelector('#comment-content') // 要根据self来获取目标元素
            var content = input.value
            //log("content,", content)
            var input = comment_form.querySelector('#comment-weibo-id')
            var weibo_id = input.value
            var form = {
                'content': content,
                'weibo_id':weibo_id,
            }
            apiCommentAdd(form, function(r) {
                var comments = JSON.parse(r)
                //log("comments",comments)
                var comment_list = WeiboCell.querySelector('.comment-list')
                var comments_html = commentsTemplate(comments)
                comment_list.innerHTML = comments_html
            })
        }
    })
}

var bindEventCommentDelete = function() {
    var WeiboList = e('.weibo-list')
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener('click', function(event){
        var self = event.target
        log("click,", self)
        if(self.classList.contains('comment-div-delete')){
            var comment_div = self.parentElement
            var comment_id = comment_div.dataset.id
            apiCommentDelete(comment_id, function(r){
                comment_div.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
    bindEventWeiboEdit()
    bindEventWeiboUpdate()

    bindEventCommentAdd()
    bindEventCommentDelete()
}

var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

15:05:33 响应
 HTTP/1.1 200 OK

var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/*
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader('Content-Type', 'application/json')
    // 注册响应函数 {当请求得到响应，就自动激发}
    r.onreadystatechange = function() {
        if(r.readyState === 4) {  //4表示服务器响应已完成
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response) //把服务器响应内容给了回调函数做实参，故形参也是一个{接收实参}
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}


// TODO API {向服务器发起请求的API}, 处理响应的回调函数写在todo.js里面
// 获取所有 todo
var apiTodoAll = function(callback) { //当本函数执行完，请求得到响应后，系统自动执行回调函数callback
    var path = '/api/todo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = '/api/todo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = '/api/todo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = '/api/todo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}




/*  Weibo的API */

// load weibo all
var apiWeiboAll = function(callback) {
    var path = '/api/weibo/all'
    ajax('GET', path, '', callback)
}

// 增加一个 weibo
var apiWeiboAdd = function(form, callback) {
    var path = '/api/weibo/add'
    ajax('POST', path, form, callback)
}

// 删除一个 todo
var apiWeiboDelete = function(id, callback) {
    var path = '/api/weibo/delete?id=' + id
    ajax('GET', path, '', callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiWeiboUpdate = function(form, callback) {
    var path = '/api/weibo/update'
    ajax('POST', path, form, callback)
    //    post(path, form, callback)
}



/* Comment */
// add
var apiCommentAdd = function (form, callback) {
    var path = '/api/comment/add'
    ajax('POST', path, form, callback)
}

// delete
var apiCommentDelete = function (id, callback) {
    var path = '/api/comment/delete?id=' + id
    ajax('GET', path, '', callback)
}
15:05:34 完整请求
15:05:34 请求结束
15:05:34 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:34 path and query /api/weibo/all {} 
15:05:34 kwargs,  {'weibo_id': 1} <class 'dict'>
15:05:34 kwargs,  {'weibo_id': 2} <class 'dict'>
15:05:34 kwargs,  {'weibo_id': 3} <class 'dict'>
15:05:34 kwargs,  {'weibo_id': 4} <class 'dict'>
15:05:34 响应
 HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "content": "aaa",
    "comments": [
      {
        "id": 1,
        "content": "aaa123",
        "weibo_id": 1
      },
      {
        "id": 7,
        "content": "aaa456",
        "weibo_id": 1
      }
    ]
  },
  {
    "id": 2,
    "content": "bbb",
    "comments": [
      {
        "id": 2,
        "content": "bbb123",
        "weibo_id": 2
      },
      {
        "id": 3,
        "content": "bbb456",
        "weibo_id": 2
      }
    ]
  },
  {
    "id": 3,
    "content": "ccc",
    "comments": [
      {
        "id": 4,
        "content": "ccc123",
        "weibo_id": 3
      },
      {
        "id": 5,
        "content": "ccc456",
        "weibo_id": 3
      },
      {
        "id": 11,
        "content": "ccc789",
        "weibo_id": 3
      }
    ]
  },
  {
    "id": 4,
    "content": "再次测试一下",
    "comments": [
      {
        "id": 9,
        "content": "123",
        "weibo_id": 4
      },
      {
        "id": 10,
        "content": "456",
        "weibo_id": 4
      }
    ]
  }
]
15:05:44 完整请求
15:05:44 请求结束
15:05:44 cookie ['Pycharm-dc9a3628=c0df1600-3e31-44d7-bd67-ce36c03445ce', 'session=eyJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoyfQ.DYpFUA.R1nY2pgJwD2-QvC1vKauUvvafaU']
15:05:44 path and query /api/weibo/add {} {"content":"ddd"}
15:05:44 kwargs,  {'weibo_id': 5} <class 'dict'>
15:05:44 响应
 HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": 5,
  "content": "ddd",
  "comments": []
}
